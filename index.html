<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Supplies Tracker</title>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:0;}
nav{display:flex;gap:.5rem;padding:.5rem;background:#f5f5f5;position:sticky;top:0;}
nav button{flex:1;}
table{width:100%;border-collapse:collapse;}
th,td{padding:.5rem;border-bottom:1px solid #ddd;}
tr:nth-child(even){background:#f7f7f7;}
.chip{display:inline-block;padding:.25rem .5rem;margin:.25rem;border-radius:16px;background:#eee;cursor:pointer;}
.chip.active{background:#1a73e8;color:#fff;}
#toast{position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);background:#323232;color:#fff;padding:.5rem 1rem;border-radius:4px;display:none;}
.hidden{display:none;}
</style>
</head>
<body>
<nav id="nav" role="navigation"></nav>
<main id="app"></main>
<div id="toast" aria-live="polite"></div>
<script>
const SESSION = <?!= JSON.stringify(session) ?>;
</script>
<script type="module">
const state = {
  session: SESSION,
  route: 'request',
  filters: { mineOnly: false, status: [], search: '' },
  rows: [],
  selection: new Set(),
  catalog: []
};

function init(){
  renderNav();
  route('request');
}

function renderNav(){
  const nav=document.getElementById('nav');
  nav.innerHTML='';
  const links=[['request','Request'],['all','All Requests'],['catalog','Catalog']];
  links.forEach(([r,label])=>{
    const btn=document.createElement('button');
    btn.textContent=label;
    btn.onclick=()=>route(r);
    nav.appendChild(btn);
  });
}

function route(r){
  state.route=r;
  const app=document.getElementById('app');
  app.innerHTML='';
  if(r==='request') renderRequest(app);
  else if(r==='all') renderAll(app);
  else if(r==='catalog') renderCatalog(app);
}

function renderRequest(app){
  app.innerHTML=`<h2>Request</h2>
    <div><input id="item" placeholder="Item" list="catList">
    <input id="qty" type="number" min="1" value="1" style="width:4rem">
    <input id="est" type="number" min="0" placeholder="Est Cost">
    <input id="cc" placeholder="Cost Center">
    <input id="gl" placeholder="GL Code">
    <textarea id="just" placeholder="Justification (if override)"></textarea>
    <label><input type="checkbox" id="ov"> Override</label>
    <button id="sub">Submit</button></div>
    <datalist id="catList"></datalist>`;
  loadCatalog().then(()=>{
    const dl=document.getElementById('catList');
    dl.innerHTML='';
    state.catalog.forEach(c=>{const o=document.createElement('option');o.value=c.desc;dl.appendChild(o);});
  });
  app.querySelector('#sub').onclick=submitOrder;
}

function renderCatalog(app){
  loadCatalog().then(()=>{
    app.innerHTML='<h2>Catalog</h2><table><thead><tr><th>Item</th><th>Category</th></tr></thead><tbody id="catBody"></tbody></table>';
    const tb=document.getElementById('catBody');
    state.catalog.forEach(c=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${c.desc}</td><td>${c.category}</td>`;tb.appendChild(tr);});
  });
}

function loadCatalog(){
  if(state.catalog.length) return Promise.resolve();
  return new Promise(res=>{
    google.script.run.withSuccessHandler(rows=>{state.catalog=rows;res();}).router({action:'listCatalog'});
  });
}

function submitOrder(){
  const payload={
    item:document.getElementById('item').value,
    qty:Number(document.getElementById('qty').value||1),
    est_cost:Number(document.getElementById('est').value||0),
    cost_center:document.getElementById('cc').value,
    gl_code:document.getElementById('gl').value,
    override:document.getElementById('ov').checked,
    justification:document.getElementById('just').value
  };
  google.script.run.withSuccessHandler(o=>{
    toast('Submitted');
    state.filters={mineOnly:true,status:['PENDING'],search:''};
    route('all');
    loadOrders();
  }).withFailureHandler(err=>toast(err.message))
    .router({action:'createOrder',payload,csrf:state.session.csrf});
}

function renderAll(app){
  app.innerHTML=`<h2>All Requests</h2>
    <div id="filters">
      <label><input type="checkbox" id="mine"> Mine only</label>
      <div id="statusChips"></div>
      <input id="search" placeholder="Search">
      <button id="clear">Clear</button>
    </div>
    <div id="bulkBar" class="hidden">
      <textarea id="comment" placeholder="Decision comment"></textarea>
      <button id="ap">Approve</button>
      <button id="dn">Deny</button>
      <button id="oh">On-Hold</button>
    </div>
    <table id="list"><thead><tr><th><input type="checkbox" id="selAll"></th><th>Requested</th><th>Item</th><th>Qty</th><th>Est Cost</th><th>Requester</th><th>Status</th><th>Approver</th></tr></thead><tbody></tbody></table>
    <div id="empty" class="hidden">No requests match your filters. <button id="reset">Reset</button></div>`;
  const st=['PENDING','APPROVED','DENIED','ON-HOLD'];
  const chipsDiv=app.querySelector('#statusChips');
  st.forEach(s=>{const sp=document.createElement('span');sp.textContent=s;sp.className='chip';sp.onclick=()=>{sp.classList.toggle('active');updateFilters();};chipsDiv.appendChild(sp);});
  app.querySelector('#mine').onchange=updateFilters;
  app.querySelector('#search').oninput=debounce(updateFilters,300);
  app.querySelector('#clear').onclick=()=>{state.filters={mineOnly:false,status:[],search:''};route('all');loadOrders();};
  app.querySelector('#reset').onclick=()=>{state.filters={mineOnly:false,status:[],search:''};route('all');loadOrders();};
  app.querySelector('#selAll').onchange=e=>{const c=e.target.checked;state.selection=new Set();document.querySelectorAll('#list tbody input[type=checkbox]').forEach(cb=>{cb.checked=c;if(c)state.selection.add(cb.value);});toggleBulk();};
  if(['approver','developer','super_admin'].includes(state.session.role)){
    document.getElementById('bulkBar').classList.remove('hidden');
    document.getElementById('ap').onclick=()=>bulk('APPROVED');
    document.getElementById('dn').onclick=()=>bulk('DENIED');
    document.getElementById('oh').onclick=()=>bulk('ON-HOLD');
  }
  loadOrders();
}

function updateFilters(){
  state.filters.mineOnly=document.getElementById('mine').checked;
  state.filters.search=document.getElementById('search').value;
  state.filters.status=[...document.querySelectorAll('#statusChips .chip.active')].map(c=>c.textContent);
  loadOrders();
}

function loadOrders(){
  google.script.run.withSuccessHandler(rows=>{state.rows=rows;renderRows();})
    .router({action:'listOrders',filter:state.filters});
}

function renderRows(){
  const tbody=document.querySelector('#list tbody');
  if(!tbody) return;
  tbody.innerHTML='';
  state.selection=new Set();
  state.rows.forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td><input type="checkbox" value="${r.id}"></td><td>${r.ts}</td><td>${r.item}</td><td>${r.qty}</td><td>${r.est_cost}</td><td>${r.requester}</td><td>${r.statusChip}</td><td>${r.approver||''}</td>`;tbody.appendChild(tr);});
  if(!state.rows.length) document.getElementById('empty').classList.remove('hidden'); else document.getElementById('empty').classList.add('hidden');
  document.querySelectorAll('#list tbody input[type=checkbox]').forEach(cb=>cb.onchange=e=>{if(e.target.checked)state.selection.add(e.target.value);else state.selection.delete(e.target.value);toggleBulk();});
}

function toggleBulk(){const bar=document.getElementById('bulkBar');if(!bar)return;bar.classList.toggle('hidden',state.selection.size===0);}

function bulk(decision){
  const ids=[...state.selection];
  const comment=document.getElementById('comment').value;
  google.script.run.withSuccessHandler(()=>{toast('Done');loadOrders();})
    .withFailureHandler(e=>toast(e.message))
    .router({action:'bulkDecision',ids,decision,comment,csrf:state.session.csrf});
}

function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';setTimeout(()=>t.style.display='none',3000);}
function debounce(fn,ms){let t;return function(){clearTimeout(t);t=setTimeout(fn,ms);};}

init();
</script>
</body>
</html>

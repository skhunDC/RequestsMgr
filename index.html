<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Supplies Tracker</title>
  <style>
    :root {
      color-scheme: light;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --surface: #ffffff;
      --surface-alt: #f5f6f8;
      --border: #d7dce1;
      --text: #202731;
      --muted: #5c6774;
      --accent: #0b57d0;
      --accent-strong: #0a47ac;
      --success: #0f9d58;
      --danger: #d93025;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--surface-alt);
      color: var(--text);
    }

    header {
      padding: 1.5rem 1rem 0.75rem;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
    }

    header p {
      margin: 0.25rem 0 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    main {
      padding: 0 1rem 2.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
      max-width: 720px;
      margin: 0 auto;
    }

    section.card {
      background: var(--surface);
      border-radius: 16px;
      padding: 1.25rem;
      box-shadow: 0 12px 24px -18px rgba(23, 32, 42, 0.3);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    h2 {
      margin: 0;
      font-size: 1.15rem;
      font-weight: 600;
    }

    .form-grid {
      display: grid;
      gap: 0.75rem;
    }

    @media (min-width: 560px) {
      .form-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        align-items: end;
      }
      .form-grid textarea {
        grid-column: 1 / -1;
      }
    }

    label span {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.35rem;
    }

    input[type="number"],
    textarea,
    select,
    button {
      font: inherit;
    }

    textarea,
    input[type="number"],
    select {
      width: 100%;
      padding: 0.65rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--surface-alt);
      color: inherit;
      min-height: 44px;
    }

    textarea:focus,
    input[type="number"]:focus,
    select:focus,
    button:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    textarea {
      resize: vertical;
      min-height: 96px;
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 999px;
      padding: 0.75rem 1.25rem;
      font-weight: 600;
      background: var(--accent);
      color: #fff;
      min-height: 44px;
      transition: background 0.2s ease;
    }

    button[disabled] {
      opacity: 0.65;
      cursor: not-allowed;
    }

    button:not([disabled]):hover {
      background: var(--accent-strong);
    }

    button.secondary {
      background: var(--surface-alt);
      color: var(--accent);
      border: 1px solid var(--border);
    }

    button.secondary:hover:not([disabled]) {
      background: #e9eef7;
    }

    .inline-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .skeleton {
      position: relative;
      overflow: hidden;
      background: linear-gradient(90deg, #e4e8ee 25%, #f2f4f8 37%, #e4e8ee 63%);
      background-size: 400% 100%;
      animation: shimmer 1.4s ease infinite;
      border-radius: 12px;
      min-height: 44px;
    }

    .skeleton.sm {
      height: 18px;
      border-radius: 6px;
    }

    @keyframes shimmer {
      0% {
        background-position: 100% 0;
      }
      100% {
        background-position: -100% 0;
      }
    }

    .order-item,
    .catalog-item {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      padding: 0.85rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface-alt);
    }

    .order-item strong,
    .catalog-item strong {
      font-size: 1rem;
    }

    .meta {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.85rem;
      font-weight: 600;
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
      background: var(--surface);
      border: 1px solid var(--border);
    }

    .status[data-state="approved"] {
      border-color: rgba(15, 157, 88, 0.35);
      color: var(--success);
    }

    .status[data-state="declined"] {
      border-color: rgba(217, 48, 37, 0.35);
      color: var(--danger);
    }

    .empty {
      text-align: center;
      color: var(--muted);
      padding: 0.75rem 0;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .load-more {
      align-self: center;
    }

    #toast {
      position: fixed;
      left: 50%;
      bottom: 1.25rem;
      transform: translateX(-50%);
      background: rgba(32, 39, 49, 0.94);
      color: #fff;
      padding: 0.75rem 1.25rem;
      border-radius: 999px;
      box-shadow: 0 20px 35px -25px rgba(23, 32, 42, 0.8);
      display: none;
      z-index: 20;
      min-width: 200px;
      text-align: center;
    }
  </style>
</head>
<body>
  <header>
    <h1>Supplies Tracker</h1>
    <p>Request, review, and manage supply orders quickly.</p>
  </header>
  <main>
    <section class="card" id="orderFormCard">
      <div>
        <h2>New request</h2>
        <p class="meta">Use the catalog to fill details fast, then submit your order.</p>
      </div>
      <form id="orderForm" class="form-grid">
        <label>
          <span>Description</span>
          <textarea id="descriptionInput" name="description" autocomplete="off" required></textarea>
        </label>
        <label>
          <span>Quantity</span>
          <input id="qtyInput" name="qty" type="number" min="1" step="1" required>
        </label>
        <label>
          <span>Suggested item</span>
          <select id="catalogSelect"></select>
        </label>
        <div class="inline-buttons">
          <button type="submit" id="submitOrderButton">Submit request</button>
          <button type="button" id="resetFormButton" class="secondary">Reset</button>
        </div>
      </form>
    </section>

    <section class="card" id="ordersCard">
      <div>
        <h2>Recent orders</h2>
        <p class="meta">Statuses update in real time. Tap to change when you review an order.</p>
      </div>
      <div id="ordersList" class="list" role="list"></div>
      <button type="button" id="ordersMoreButton" class="load-more secondary">Load more</button>
    </section>

    <section class="card" id="catalogCard">
      <div>
        <h2>Catalog</h2>
        <p class="meta">Tap an item to autofill the request form.</p>
      </div>
      <div id="catalogList" class="list" role="list"></div>
      <button type="button" id="catalogMoreButton" class="load-more secondary">Load more</button>
    </section>
  </main>
  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    const SESSION = <?!= JSON.stringify(session) ?>;
  </script>
  <script>
    (function () {
      const state = {
        form: { description: '', qty: 1 },
        catalog: [],
        catalogNextToken: '',
        catalogLoading: false,
        orders: [],
        ordersNextToken: '',
        ordersLoading: false
      };

      const LOCAL_KEY = 'supplies-tracker-form';

      const orderForm = document.getElementById('orderForm');
      const descriptionInput = document.getElementById('descriptionInput');
      const qtyInput = document.getElementById('qtyInput');
      const catalogSelect = document.getElementById('catalogSelect');
      const submitOrderButton = document.getElementById('submitOrderButton');
      const resetFormButton = document.getElementById('resetFormButton');
      const ordersList = document.getElementById('ordersList');
      const ordersMoreButton = document.getElementById('ordersMoreButton');
      const catalogList = document.getElementById('catalogList');
      const catalogMoreButton = document.getElementById('catalogMoreButton');
      const toast = document.getElementById('toast');

      const initialSessionEmail = SESSION && SESSION.email ? String(SESSION.email) : '';

      attachHandlers();
      hydrateFormFromCache();
      setDefaultCatalogOption();
      loadInitialData();

      function attachHandlers() {
        orderForm.addEventListener('submit', handleSubmitOrder);
        resetFormButton.addEventListener('click', () => {
          setFormState({ description: '', qty: 1 });
          persistForm();
          renderForm();
        });
        catalogSelect.addEventListener('change', () => {
          const option = catalogSelect.options[catalogSelect.selectedIndex];
          if (option && option.value) {
            setFormState({ description: option.textContent });
            renderForm();
            persistForm();
          }
        });
        descriptionInput.addEventListener('input', () => {
          setFormState({ description: descriptionInput.value });
          persistForm();
        });
        qtyInput.addEventListener('input', () => {
          const qty = Number(qtyInput.value) > 0 ? Number(qtyInput.value) : 1;
          setFormState({ qty });
          qtyInput.value = qty;
          persistForm();
        });
        ordersMoreButton.addEventListener('click', () => {
          if (!state.ordersLoading && state.ordersNextToken) {
            loadOrders({ append: true });
          }
        });
        catalogMoreButton.addEventListener('click', () => {
          if (!state.catalogLoading && state.catalogNextToken) {
            loadCatalog({ append: true });
          }
        });
      }

      function setDefaultCatalogOption() {
        catalogSelect.textContent = '';
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Select an item (optional)';
        catalogSelect.appendChild(option);
      }

      function loadInitialData() {
        loadCatalog({ append: false });
        loadOrders({ append: false });
      }

      function loadCatalog({ append }) {
        if (state.catalogLoading) return;
        state.catalogLoading = true;
        catalogMoreButton.disabled = true;
        toggleCatalogSkeleton(true);
        const payload = {
          cid: makeCid(),
          pageSize: 20,
          nextToken: append ? state.catalogNextToken : ''
        };
        google.script.run
          .withSuccessHandler(handleResponse)
          .withFailureHandler(err => handleError(err, 'listCatalog', payload))
          .listCatalog(payload);

        function handleResponse(response) {
          state.catalogLoading = false;
          toggleCatalogSkeleton(false);
          if (!response || !response.ok) {
            handleError(response, 'listCatalog', payload);
            return;
          }
          state.catalogNextToken = response.nextToken || '';
          const items = Array.isArray(response.items) ? response.items : [];
          state.catalog = append ? state.catalog.concat(items) : items;
          renderCatalog();
        }
      }

      function loadOrders({ append }) {
        if (state.ordersLoading) return;
        state.ordersLoading = true;
        ordersMoreButton.disabled = true;
        toggleOrdersSkeleton(true);
        const payload = {
          cid: makeCid(),
          pageSize: 10,
          nextToken: append ? state.ordersNextToken : ''
        };
        google.script.run
          .withSuccessHandler(handleResponse)
          .withFailureHandler(err => handleError(err, 'listOrders', payload))
          .listOrders(payload);

        function handleResponse(response) {
          state.ordersLoading = false;
          toggleOrdersSkeleton(false);
          if (!response || !response.ok) {
            handleError(response, 'listOrders', payload);
            return;
          }
          state.ordersNextToken = response.nextToken || '';
          const items = Array.isArray(response.orders) ? response.orders : [];
          state.orders = append ? state.orders.concat(items) : items;
          renderOrders();
        }
      }

      function handleSubmitOrder(event) {
        event.preventDefault();
        const description = descriptionInput.value.trim();
        const qty = qtyInput.value;
        if (!description) {
          handleError({ message: 'Description is required.' }, 'validation:description');
          return;
        }
        disableOrderForm(true);
        const payload = {
          cid: makeCid(),
          clientRequestId: makeClientRequestId(),
          description,
          qty
        };
        google.script.run
          .withSuccessHandler(handleResponse)
          .withFailureHandler(err => {
            disableOrderForm(false);
            handleError(err, 'createOrder', payload);
          })
          .createOrder(payload);

        function handleResponse(response) {
          disableOrderForm(false);
          if (!response || !response.ok || !response.order) {
            handleError(response, 'createOrder', payload);
            return;
          }
          showToast('Request submitted');
          setFormState({ description: '', qty: 1 });
          persistForm();
          renderForm();
          state.orders.unshift(response.order);
          renderOrders();
        }
      }

      function handleUpdateStatus(orderId, status) {
        const payload = {
          cid: makeCid(),
          clientRequestId: makeClientRequestId(),
          orderId,
          status
        };
        const container = ordersList.querySelector(`article[data-order="${orderId}"]`);
        const buttons = container ? Array.from(container.querySelectorAll('button')) : [];
        buttons.forEach(btn => { btn.disabled = true; });
        google.script.run
          .withSuccessHandler(handleResponse)
          .withFailureHandler(err => {
            buttons.forEach(btn => { btn.disabled = false; });
            handleError(err, 'updateOrderStatus', payload);
          })
          .updateOrderStatus(payload);

        function handleResponse(response) {
          buttons.forEach(btn => { btn.disabled = false; });
          if (!response || !response.ok || !response.order) {
            handleError(response, 'updateOrderStatus', payload);
            return;
          }
          const updated = response.order;
          const idx = state.orders.findIndex(item => item.id === updated.id);
          if (idx >= 0) {
            state.orders[idx] = updated;
            renderOrders();
          }
          showToast('Order updated');
        }
      }

      function renderForm() {
        descriptionInput.value = state.form.description;
        qtyInput.value = state.form.qty;
      }

      function renderOrders() {
        ordersList.textContent = '';
        if (!state.orders.length && state.ordersLoading) {
          ordersList.appendChild(buildSkeletonBlock());
          return;
        }
        if (!state.orders.length) {
          const empty = document.createElement('p');
          empty.className = 'empty';
          empty.textContent = 'No orders yet. Submit your first request above.';
          ordersList.appendChild(empty);
          ordersMoreButton.disabled = true;
          return;
        }
        const fragment = document.createDocumentFragment();
        state.orders.forEach(order => {
          const item = document.createElement('article');
          item.className = 'order-item';
          item.dataset.order = order.id;

          const title = document.createElement('strong');
          title.textContent = order.description || 'Untitled request';
          item.appendChild(title);

          const meta = document.createElement('span');
          meta.className = 'meta';
          meta.textContent = buildOrderMeta(order);
          item.appendChild(meta);

          const status = document.createElement('span');
          status.className = 'status';
          status.dataset.state = order.status;
          status.textContent = formatStatus(order.status);
          item.appendChild(status);

          if (order.status === 'pending') {
            const actions = document.createElement('div');
            actions.className = 'inline-buttons';
            const approve = document.createElement('button');
            approve.type = 'button';
            approve.className = 'secondary';
            approve.textContent = 'Approve';
            approve.addEventListener('click', () => handleUpdateStatus(order.id, 'approved'));
            actions.appendChild(approve);

            const decline = document.createElement('button');
            decline.type = 'button';
            decline.className = 'secondary';
            decline.textContent = 'Decline';
            decline.addEventListener('click', () => handleUpdateStatus(order.id, 'declined'));
            actions.appendChild(decline);

            item.appendChild(actions);
          }

          fragment.appendChild(item);
        });
        ordersList.appendChild(fragment);
        ordersMoreButton.disabled = !state.ordersNextToken;
      }

      function renderCatalog() {
        catalogList.textContent = '';
        catalogSelect.textContent = '';
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Select an item (optional)';
        catalogSelect.appendChild(defaultOption);

        if (!state.catalog.length && state.catalogLoading) {
          catalogList.appendChild(buildSkeletonBlock());
          catalogMoreButton.disabled = true;
          return;
        }
        if (!state.catalog.length) {
          const empty = document.createElement('p');
          empty.className = 'empty';
          empty.textContent = 'No catalog items found.';
          catalogList.appendChild(empty);
          catalogMoreButton.disabled = true;
          return;
        }

        const fragment = document.createDocumentFragment();
        state.catalog.forEach(item => {
          const option = document.createElement('option');
          option.value = item.sku;
          option.textContent = `${item.description} · ${item.category}`;
          catalogSelect.appendChild(option);

          const card = document.createElement('article');
          card.className = 'catalog-item';
          card.tabIndex = 0;
          card.setAttribute('role', 'listitem');
          const name = document.createElement('strong');
          name.textContent = item.description;
          card.appendChild(name);
          const meta = document.createElement('span');
          meta.className = 'meta';
          meta.textContent = `${item.category} • ${item.sku}`;
          card.appendChild(meta);
          card.addEventListener('click', () => {
            setFormState({ description: item.description });
            renderForm();
            persistForm();
          });
          card.addEventListener('keydown', evt => {
            if (evt.key === 'Enter' || evt.key === ' ') {
              evt.preventDefault();
              setFormState({ description: item.description });
              renderForm();
              persistForm();
            }
          });
          fragment.appendChild(card);
        });
        catalogList.appendChild(fragment);
        catalogMoreButton.disabled = !state.catalogNextToken;
      }

      function toggleOrdersSkeleton(active) {
        if (active && !state.orders.length) {
          ordersList.textContent = '';
          ordersList.appendChild(buildSkeletonBlock());
          ordersMoreButton.disabled = true;
        }
      }

      function toggleCatalogSkeleton(active) {
        if (active && !state.catalog.length) {
          catalogList.textContent = '';
          catalogList.appendChild(buildSkeletonBlock());
          catalogMoreButton.disabled = true;
        }
      }

      function buildSkeletonBlock() {
        const wrapper = document.createElement('div');
        wrapper.className = 'order-item';
        const title = document.createElement('div');
        title.className = 'skeleton';
        title.style.height = '20px';
        wrapper.appendChild(title);
        const line = document.createElement('div');
        line.className = 'skeleton sm';
        wrapper.appendChild(line);
        return wrapper;
      }

      function buildOrderMeta(order) {
        const parts = [];
        if (order.qty) {
          parts.push(`Qty ${order.qty}`);
        }
        if (order.ts) {
          parts.push(new Date(order.ts).toLocaleString());
        }
        if (order.requester) {
          parts.push(order.requester);
        }
        if (order.approver && order.status !== 'pending') {
          parts.push(`by ${order.approver}`);
        }
        return parts.join(' • ');
      }

      function formatStatus(status) {
        switch (status) {
          case 'approved':
            return 'Approved';
          case 'declined':
            return 'Declined';
          default:
            return 'Pending review';
        }
      }

      function disableOrderForm(disabled) {
        submitOrderButton.disabled = disabled;
        descriptionInput.disabled = disabled;
        qtyInput.disabled = disabled;
        catalogSelect.disabled = disabled;
        resetFormButton.disabled = disabled;
      }

      function setFormState(partial) {
        state.form = Object.assign({}, state.form, partial);
      }

      function persistForm() {
        try {
          localStorage.setItem(LOCAL_KEY, JSON.stringify(state.form));
        } catch (err) {
          // ignore storage issues silently
        }
      }

      function hydrateFormFromCache() {
        try {
          const raw = localStorage.getItem(LOCAL_KEY);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === 'object') {
              state.form = Object.assign({}, state.form, parsed);
            }
          }
        } catch (err) {
          // ignore cache issues
        }
        renderForm();
      }

      function showToast(message) {
        toast.textContent = message;
        toast.style.display = 'block';
        clearTimeout(showToast.timer);
        showToast.timer = setTimeout(() => {
          toast.style.display = 'none';
        }, 2800);
      }

      function handleError(err, context, payload) {
        const message = err && err.message ? err.message : 'Something went wrong. Please try again.';
        console.error('[SuppliesTracker]', context, message, err);
        showToast(message);
        try {
          google.script.run
            .withFailureHandler(() => { })
            .logClientError({
              cid: makeCid(),
              context,
              message,
              stack: err && err.stack ? String(err.stack) : '',
              payload
            });
        } catch (loggingError) {
          // ignore logging issues
        }
      }

      function makeCid() {
        return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 8)}`;
      }

      function makeClientRequestId() {
        return `${initialSessionEmail || 'user'}-${makeCid()}`;
      }
    })();
  </script>
</body>
</html>

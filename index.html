<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Request Manager</title>
  <style>
    :root {
      color-scheme: light;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --surface: #ffffff;
      --surface-alt: #f6f7fb;
      --surface-elevated: rgba(255, 255, 255, 0.85);
      --border: #d6dde7;
      --border-strong: #b7c2d3;
      --text: #1f2733;
      --muted: #5c6774;
      --accent: #0b57d0;
      --accent-strong: #0a47ac;
      --accent-soft: rgba(11, 87, 208, 0.12);
      --hero-kicker: rgba(11, 87, 208, 0.14);
      --supplies-color: #0b57d0;
      --supplies-color-strong: #0a47ac;
      --supplies-soft: rgba(11, 87, 208, 0.12);
      --supplies-outline: rgba(11, 87, 208, 0.32);
      --it-color: #0f9d58;
      --it-color-strong: #0b8043;
      --it-soft: rgba(15, 157, 88, 0.12);
      --it-outline: rgba(15, 157, 88, 0.28);
      --maintenance-color: #f29900;
      --maintenance-color-strong: #c77700;
      --maintenance-soft: rgba(242, 153, 0, 0.14);
      --maintenance-outline: rgba(242, 153, 0, 0.3);
      --success: #0f9d58;
      --danger: #d93025;
      --page-gradient-start: #f3f6ff;
      --page-gradient-end: #ffffff;
      --shadow-soft: 0 24px 60px -40px rgba(20, 36, 63, 0.65);
      --dashboard-pie-size: 120px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(180deg, var(--page-gradient-start) 0%, var(--page-gradient-end) 45%);
      color: var(--text);
      font-size: clamp(16px, 4.6vw, 19px);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    body[data-active-tab="supplies"] {
      --page-gradient-start: #f3f6ff;
      --page-gradient-end: #ffffff;
    }

    body[data-active-tab="it"] {
      --page-gradient-start: #edf8f2;
      --page-gradient-end: #ffffff;
    }

    body[data-active-tab="maintenance"] {
      --page-gradient-start: #fff6eb;
      --page-gradient-end: #ffffff;
    }

    header {
      position: relative;
      padding: clamp(1.75rem, 5vw, 2.75rem) 0 clamp(2.4rem, 7vw, 3.5rem);
      overflow: hidden;
    }

    header::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(120% 140% at 0% 0%, rgba(11, 87, 208, 0.12), transparent 60%),
        radial-gradient(100% 120% at 100% 0%, rgba(15, 157, 88, 0.12), transparent 60%),
        linear-gradient(180deg, rgba(255, 255, 255, 0.85) 0%, rgba(255, 255, 255, 0.65) 100%);
      pointer-events: none;
    }

    header .hero-inner {
      position: relative;
      z-index: 1;
      width: min(100%, 1100px);
      margin: 0 auto;
      padding: 0 clamp(1.1rem, 5vw, 2.2rem);
      display: grid;
      gap: clamp(2rem, 6vw, 3rem);
      align-items: center;
    }

    .hero-copy {
      display: grid;
      gap: clamp(1rem, 3vw, 1.6rem);
      align-content: start;
    }

    .hero-eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.35rem 0.85rem;
      border-radius: 999px;
      background: var(--hero-kicker);
      color: var(--accent-strong);
      font-size: clamp(0.78rem, 2.8vw, 0.9rem);
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      width: fit-content;
    }

    .hero-title {
      margin: 0;
      font-size: clamp(2.05rem, 6vw, 2.9rem);
      font-weight: 700;
      line-height: 1.1;
      color: var(--text);
    }

    .hero-description {
      margin: 0;
      font-size: clamp(1.05rem, 3.6vw, 1.25rem);
      color: var(--muted);
      max-width: 38ch;
    }

    .hero-actions {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.6rem;
      align-items: stretch;
    }

    .hero-actions button {
      --button-bg: var(--accent);
      --button-hover-bg: var(--accent-strong);
      --button-fg: #fff;
      --button-shadow: rgba(11, 87, 208, 0.45);
      --button-shadow-active: rgba(11, 87, 208, 0.65);
      flex: 1 1 0;
      min-width: 0;
      position: relative;
      isolation: isolate;
      overflow: hidden;
      border: none;
      border-radius: 14px;
      color: var(--button-fg);
      font-size: clamp(0.85rem, 3vw, 1rem);
      font-weight: 600;
      letter-spacing: 0.01em;
      padding: clamp(0.65rem, 2.8vw, 0.9rem) clamp(0.85rem, 3vw, 1.15rem);
      text-align: center;
      line-height: 1.35;
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.18) 0%, rgba(255, 255, 255, 0.05) 45%),
        linear-gradient(140deg, var(--button-bg) 0%, var(--button-hover-bg) 100%);
      box-shadow: 0 16px 38px -28px var(--button-shadow);
      transform: translateY(0);
      transition: transform 0.35s ease, box-shadow 0.35s ease, background 0.35s ease;
    }

    .hero-actions button::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.45), transparent 55%),
        linear-gradient(180deg, rgba(255, 255, 255, 0.2), transparent 70%);
      opacity: 0;
      transform: translateY(14%);
      transition: opacity 0.4s ease, transform 0.4s ease;
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .hero-actions button:hover,
    .hero-actions button:focus-visible {
      background: linear-gradient(150deg, rgba(255, 255, 255, 0.22) 0%, rgba(255, 255, 255, 0.05) 40%),
        linear-gradient(140deg, var(--button-bg) 0%, var(--button-hover-bg) 100%);
      box-shadow: 0 22px 48px -28px var(--button-shadow-active);
      transform: translateY(-3px);
    }

    .hero-actions button:hover::after,
    .hero-actions button:focus-visible::after {
      opacity: 1;
      transform: translateY(0);
    }

    .hero-actions button:focus-visible {
      outline-color: var(--button-hover-bg);
      outline-offset: 2px;
    }

    .hero-actions button:active {
      transform: translateY(-1px);
      box-shadow: 0 18px 42px -30px var(--button-shadow-active);
    }

    .hero-actions button.active {
      transform: translateY(-4px);
      box-shadow: 0 26px 56px -30px var(--button-shadow-active);
    }

    .hero-actions button.active:hover,
    .hero-actions button.active:focus-visible {
      transform: translateY(-5px) scale(1.01);
      box-shadow: 0 34px 68px -30px var(--button-shadow-active), 0 20px 32px -26px rgba(18, 42, 78, 0.28);
    }

    .hero-actions button[data-tab-trigger="supplies"] {
      --button-bg: var(--supplies-color);
      --button-hover-bg: var(--supplies-color-strong);
      --button-shadow: rgba(11, 87, 208, 0.65);
      --button-shadow-active: rgba(11, 87, 208, 0.75);
    }

    .hero-actions button[data-tab-trigger="it"] {
      --button-bg: var(--it-color);
      --button-hover-bg: var(--it-color-strong);
      --button-shadow: rgba(15, 157, 88, 0.5);
      --button-shadow-active: rgba(15, 157, 88, 0.65);
    }

    .hero-actions button[data-tab-trigger="maintenance"] {
      --button-bg: var(--maintenance-color);
      --button-hover-bg: var(--maintenance-color-strong);
      --button-shadow: rgba(242, 153, 0, 0.45);
      --button-shadow-active: rgba(242, 153, 0, 0.6);
    }

    .feedback-fab {
      position: fixed;
      right: clamp(1rem, 4vw, 1.75rem);
      bottom: clamp(1rem, 6vw, 2rem);
      display: inline-flex;
      align-items: center;
      gap: 0.55rem;
      border: none;
      border-radius: 999px;
      padding: 0.75rem 1.35rem;
      background: linear-gradient(135deg, #0b57d0, #5b8def);
      color: #fff;
      font-weight: 600;
      font-size: clamp(0.85rem, 2.8vw, 0.95rem);
      box-shadow: 0 18px 38px -24px rgba(11, 87, 208, 0.85);
      cursor: pointer;
      transition: transform 160ms ease, box-shadow 160ms ease;
      z-index: 40;
    }

    .feedback-fab:hover,
    .feedback-fab:focus-visible {
      transform: translateY(-2px);
      box-shadow: 0 26px 48px -22px rgba(11, 87, 208, 0.9);
    }

    .feedback-fab:focus-visible {
      outline: 3px solid rgba(11, 87, 208, 0.35);
      outline-offset: 3px;
    }

    .feedback-fab-emoji {
      font-size: 1.25em;
    }

    .feedback-dialog {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: clamp(1rem, 5vw, 2.5rem);
      background: rgba(16, 24, 40, 0.55);
      z-index: 50;
    }

    .feedback-dialog[hidden] {
      display: none;
    }

    .feedback-card {
      position: relative;
      width: min(100%, 480px);
      background: var(--surface);
      border-radius: 20px;
      box-shadow: var(--shadow-soft);
      padding: clamp(1.2rem, 5vw, 1.9rem);
      display: grid;
      gap: 1.1rem;
    }

    .feedback-close {
      position: absolute;
      top: 0.9rem;
      right: 0.9rem;
      border: none;
      background: rgba(15, 23, 42, 0.06);
      border-radius: 999px;
      width: 32px;
      height: 32px;
      display: grid;
      place-items: center;
      color: var(--muted);
      cursor: pointer;
      transition: background 160ms ease, color 160ms ease;
    }

    .feedback-close:hover,
    .feedback-close:focus-visible {
      background: rgba(11, 87, 208, 0.12);
      color: var(--accent-strong);
    }

    .feedback-close:focus-visible {
      outline: 3px solid rgba(11, 87, 208, 0.25);
      outline-offset: 3px;
    }

    .feedback-header h2 {
      margin: 0;
      font-size: clamp(1.35rem, 4vw, 1.7rem);
    }

    .feedback-header p {
      margin: 0.35rem 0 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .feedback-required,
    .feedback-optional {
      font-size: clamp(0.82rem, 2.6vw, 0.92rem);
      color: var(--muted);
      font-weight: 600;
    }

    .feedback-required {
      color: var(--accent-strong);
      margin-left: 0.3rem;
    }

    .feedback-note {
      margin: 0;
      font-size: clamp(0.85rem, 2.8vw, 0.95rem);
      color: var(--muted);
    }

    .feedback-form {
      display: grid;
      gap: 0.85rem;
    }

    .feedback-form fieldset {
      border: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 0.65rem;
    }

    .feedback-form legend {
      font-weight: 600;
      font-size: 0.92rem;
    }

    .feedback-type-options {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .feedback-chip {
      position: relative;
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .feedback-chip input {
      appearance: none;
      width: 1px;
      height: 1px;
      position: absolute;
      inset: 0;
      margin: 0;
      pointer-events: none;
      opacity: 0;
    }

    .feedback-chip-label {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem 0.85rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      transition: border-color 160ms ease, background 160ms ease, color 160ms ease, box-shadow 160ms ease;
    }

    .feedback-chip[data-selected="true"] .feedback-chip-label {
      background: var(--accent-soft);
      border-color: rgba(11, 87, 208, 0.4);
      color: var(--accent-strong);
    }

    .feedback-chip[data-focused="true"] .feedback-chip-label {
      box-shadow: 0 0 0 3px rgba(11, 87, 208, 0.18);
    }

    .feedback-form label {
      display: grid;
      gap: 0.35rem;
      font-size: 0.92rem;
    }

    .feedback-form input[type="text"],
    .feedback-form textarea {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0.65rem 0.75rem;
      font: inherit;
      transition: border-color 160ms ease, box-shadow 160ms ease;
      resize: vertical;
      min-height: 44px;
    }

    .feedback-form textarea {
      min-height: 110px;
    }

    .feedback-form input:focus-visible,
    .feedback-form textarea:focus-visible {
      outline: none;
      border-color: rgba(11, 87, 208, 0.65);
      box-shadow: 0 0 0 3px rgba(11, 87, 208, 0.15);
    }

    .feedback-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      justify-content: flex-end;
      margin-top: 0.3rem;
    }

    .feedback-actions button[type="submit"] {
      border: none;
      border-radius: 12px;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      padding: 0.6rem 1.25rem;
      cursor: pointer;
      transition: background 160ms ease, transform 160ms ease;
    }

    .feedback-actions button[type="submit"]:hover,
    .feedback-actions button[type="submit"]:focus-visible {
      background: var(--accent-strong);
      transform: translateY(-1px);
    }

    .feedback-actions .secondary {
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      border-radius: 12px;
      padding: 0.6rem 1.05rem;
      font-weight: 600;
    }

    .feedback-status {
      border-radius: 12px;
      padding: 0.65rem 0.75rem;
      font-size: 0.9rem;
    }

    .feedback-status[data-state="success"] {
      background: rgba(15, 157, 88, 0.12);
      color: #0b8043;
    }

    .feedback-status[data-state="error"] {
      background: rgba(217, 48, 37, 0.12);
      color: #b31412;
    }

    @media (max-width: 600px) {
      .feedback-fab {
        right: 1rem;
        bottom: 1rem;
        padding-inline: 1.05rem;
      }

      .feedback-fab .feedback-fab-label {
        font-size: 0.86rem;
      }

      .feedback-card {
        border-radius: 16px;
      }
    }

    @media (max-width: 540px) {
      .hero-actions {
        gap: 0.45rem;
      }

      .hero-actions button {
        font-size: clamp(0.8rem, 3.8vw, 0.9rem);
        padding: 0.6rem 0.85rem;
      }
    }

    .hero-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.75rem;
    }

    .hero-stat {
      padding: 0.9rem 1.1rem;
      border-radius: 16px;
      background: var(--surface-elevated);
      border: 1px solid rgba(14, 31, 53, 0.08);
      box-shadow: var(--shadow-soft);
      display: grid;
      gap: 0.35rem;
      align-content: start;
    }

    .hero-stat strong {
      font-size: clamp(1.45rem, 4.2vw, 1.95rem);
      font-weight: 700;
      color: var(--accent);
    }

    .hero-stat span {
      color: var(--muted);
      font-size: clamp(0.85rem, 3vw, 0.98rem);
    }

    .hero-dashboard-shell {
      width: 100%;
      display: grid;
      gap: clamp(1.1rem, 3.2vw, 1.8rem);
      align-items: start;
      justify-items: center;
    }

    .hero-dashboard-logo {
      width: clamp(112px, 21vw, 165px);
      max-width: 100%;
      height: auto;
      filter: drop-shadow(0 18px 30px rgba(15, 33, 66, 0.18));
    }

    .hero-dashboard {
      width: min(100%, 540px);
      margin: 0;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.8));
      border-radius: 22px;
      border: 1px solid rgba(14, 31, 53, 0.08);
      box-shadow: 0 28px 60px -32px rgba(12, 26, 52, 0.55);
      padding: clamp(1.15rem, 3.5vw, 1.8rem);
      display: grid;
      gap: clamp(0.75rem, 2.6vw, 1.2rem);
      backdrop-filter: blur(6px);
    }

    .hero-dashboard .dashboard-header {
      display: grid;
      gap: clamp(0.35rem, 2vw, 0.6rem);
    }

    .dashboard-header-top {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.35rem;
    }

    .dashboard-title {
      margin: 0;
      font-size: clamp(1.05rem, 3.6vw, 1.32rem);
      font-weight: 600;
    }

    .dashboard-header-top .meta {
      margin-left: auto;
      font-size: clamp(0.82rem, 2.6vw, 0.95rem);
    }

    .dashboard-subcopy {
      margin: 0;
      font-size: clamp(0.85rem, 3vw, 0.98rem);
      color: var(--muted);
    }

    .dashboard-top {
      display: grid;
      gap: clamp(0.45rem, 2.2vw, 0.75rem);
      align-items: start;
    }

    .dashboard-grid {
      display: grid;
      gap: clamp(0.35rem, 1.8vw, 0.6rem);
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    @media (max-width: 720px) {
      .dashboard-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
    }

    .dashboard-card {
      --card-color: var(--accent);
      --card-color-strong: var(--accent-strong);
      --card-soft: rgba(11, 87, 208, 0.12);
      --card-outline: rgba(11, 87, 208, 0.22);
      border: 1px solid var(--card-outline);
      border-radius: 12px;
      padding: clamp(0.45rem, 1.7vw, 0.7rem);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.92), rgba(255, 255, 255, 0.78)), var(--card-soft);
      display: grid;
      gap: 0.25rem;
      align-content: start;
    }

    .dashboard-card[data-dashboard-card="supplies"] {
      --card-color: var(--supplies-color);
      --card-color-strong: var(--supplies-color-strong);
      --card-soft: var(--supplies-soft);
      --card-outline: var(--supplies-outline);
    }

    .dashboard-card[data-dashboard-card="it"] {
      --card-color: var(--it-color);
      --card-color-strong: var(--it-color-strong);
      --card-soft: var(--it-soft);
      --card-outline: var(--it-outline);
    }

    .dashboard-card[data-dashboard-card="maintenance"] {
      --card-color: var(--maintenance-color);
      --card-color-strong: var(--maintenance-color-strong);
      --card-soft: var(--maintenance-soft);
      --card-outline: var(--maintenance-outline);
    }

    .dashboard-card h3 {
      margin: 0;
      font-size: clamp(0.92rem, 2.8vw, 1.05rem);
      font-weight: 600;
      color: var(--card-color-strong);
    }

    .dashboard-card .metric-group {
      display: grid;
      gap: 0.25rem;
    }

    .dashboard-card .metric {
      display: grid;
      gap: 0.15rem;
      color: var(--muted);
      font-size: clamp(0.72rem, 2.1vw, 0.82rem);
    }

    .dashboard-card .metric strong {
      font-size: clamp(1.02rem, 3.3vw, 1.28rem);
      font-weight: 600;
      color: var(--text);
    }

    .dashboard-card .metric.highlight {
      color: var(--card-color);
    }

    .dashboard-card .metric.highlight strong {
      color: var(--card-color-strong);
    }

    .dashboard-visual {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.35rem;
    }

    .dashboard-visual canvas {
      width: clamp(220px, var(--dashboard-pie-size), var(--dashboard-pie-size));
      max-width: 100%;
      height: auto;
      aspect-ratio: 1 / 1;
    }

    .dashboard-empty {
      margin: 0;
      color: var(--muted);
      font-size: clamp(0.9rem, 3.2vw, 1rem);
    }

    .page-shell {
      width: min(100%, 1100px);
      margin: 0 auto;
      padding: 0 clamp(1.1rem, 5vw, 2.2rem) clamp(3rem, 7vw, 4rem);
      display: grid;
      gap: clamp(1.75rem, 5vw, 2.75rem);
    }

    nav.tab-nav {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.35rem;
      padding: 0.4rem;
      border-radius: 999px;
      background: var(--surface);
      border: 1px solid rgba(14, 31, 53, 0.1);
      box-shadow: 0 24px 45px -32px rgba(20, 36, 63, 0.45);
      justify-content: center;
      justify-self: center;
      max-width: 100%;
      width: min(100%, 720px);
    }

    main {
      width: 100%;
      margin: 0;
      padding-bottom: clamp(1.5rem, 5vw, 2.5rem);
    }

    .tab-panel {
      display: none;
      flex-direction: column;
      gap: 1.25rem;
      --panel-accent: var(--accent);
      --panel-accent-strong: var(--accent-strong);
      --panel-accent-soft: var(--accent-soft);
      --panel-accent-outline: rgba(11, 87, 208, 0.2);
    }

    .tab-panel[data-tab-panel="supplies"] {
      --panel-accent: var(--supplies-color);
      --panel-accent-strong: var(--supplies-color-strong);
      --panel-accent-soft: var(--supplies-soft);
      --panel-accent-outline: var(--supplies-outline);
    }

    .tab-panel[data-tab-panel="it"] {
      --panel-accent: var(--it-color);
      --panel-accent-strong: var(--it-color-strong);
      --panel-accent-soft: var(--it-soft);
      --panel-accent-outline: var(--it-outline);
    }

    .tab-panel[data-tab-panel="maintenance"] {
      --panel-accent: var(--maintenance-color);
      --panel-accent-strong: var(--maintenance-color-strong);
      --panel-accent-soft: var(--maintenance-soft);
      --panel-accent-outline: var(--maintenance-outline);
    }

    .tab-panel.active {
      display: flex;
    }

    .notice,
    .approver-notice {
      border-radius: 12px;
      background: var(--panel-accent-soft, var(--accent-soft));
      color: inherit;
    }

    .notice {
      width: 100%;
      margin: 0;
      padding: clamp(0.85rem, 4vw, 1.2rem);
      border: 1px solid var(--border);
      font-size: clamp(1rem, 3.6vw, 1.1rem);
    }

    @media (min-width: 680px) {
      .dashboard-top {
        grid-template-columns: minmax(0, 1fr) auto;
        align-items: start;
      }

      .dashboard-visual {
        justify-self: end;
        align-items: flex-end;
      }
    }

    @media (min-width: 880px) {
      header .hero-inner {
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
        align-items: stretch;
      }

      .hero-dashboard-shell {
        justify-items: end;
      }

      .hero-dashboard {
        width: min(100%, 520px);
      }
    }

    @media (min-width: 1080px) {
      .page-shell {
        padding: 0 clamp(1.6rem, 4vw, 3rem) clamp(3.75rem, 6vw, 4.75rem);
      }

      section.card {
        padding: clamp(1.4rem, 3vw, 2.1rem);
      }
    }

    .notice[hidden],
    .approver-notice[hidden] {
      display: none !important;
    }

    .notice[data-variant="warning"],
    .approver-notice[data-variant="warning"] {
      border-color: rgba(217, 48, 37, 0.35);
      background: rgba(217, 48, 37, 0.08);
    }

    .notice[data-variant="info"],
    .approver-notice[data-variant="info"] {
      border-color: var(--panel-accent-outline, rgba(11, 87, 208, 0.35));
      background: var(--panel-accent-soft, var(--accent-soft));
    }

    .notice strong,
    .approver-notice strong {
      display: block;
      font-weight: 600;
      margin-bottom: 0.35rem;
    }

    .notice p,
    .approver-notice p {
      margin: 0;
      color: inherit;
    }

    .notice p + p,
    .approver-notice p + p {
      margin-top: 0.35rem;
    }

    .approver-notice {
      margin-top: 0.75rem;
      padding: clamp(0.75rem, 3.6vw, 1rem);
      border: 1px solid var(--panel-accent-outline, var(--border));
      font-size: clamp(0.95rem, 3.4vw, 1.05rem);
    }

    .form-grid .approver-notice {
      width: 100%;
      grid-column: 1 / -1;
      justify-self: stretch;
    }

    section.card {
      background: var(--surface);
      border-radius: 20px;
      padding: clamp(1.25rem, 5vw, 1.9rem);
      box-shadow: 0 28px 60px -45px rgba(15, 33, 66, 0.5);
      border: 1px solid rgba(14, 31, 53, 0.08);
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    h2 {
      margin: 0;
      font-size: clamp(1.2rem, 4vw, 1.45rem);
      font-weight: 600;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      width: 100%;
      text-align: left;
      color: inherit;
      user-select: none;
    }

    .card-header-text {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .card-header-action {
      --button-bg: var(--surface);
      --button-hover-bg: rgba(11, 87, 208, 0.1);
      --button-fg: var(--supplies-color-strong);
      border: 1px solid var(--supplies-outline);
      padding: 0.55rem 1.05rem;
      min-height: 0;
      font-size: clamp(0.92rem, 3vw, 1.05rem);
      line-height: 1.2;
      margin-left: auto;
      white-space: nowrap;
      box-shadow: none;
      align-self: flex-start;
    }

    .card-title {
      font-size: clamp(1.2rem, 4.4vw, 1.5rem);
      font-weight: 600;
    }

    .card-subtitle {
      font-size: clamp(1rem, 3.7vw, 1.1rem);
      color: var(--muted);
    }

    .card-body {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }

    .form-grid {
      display: grid;
      gap: 0.75rem;
    }

    @media (min-width: 560px) {
      .form-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        align-items: end;
      }

      .form-grid textarea,
      .form-grid .full-width {
        grid-column: 1 / -1;
      }
    }

    label span {
      display: block;
      font-size: clamp(1rem, 3.8vw, 1.15rem);
      font-weight: 600;
      margin-bottom: 0.45rem;
    }

    .checkbox-field {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem 0.85rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--surface-alt);
      line-height: 1.4;
    }

    .checkbox-field input[type="checkbox"] {
      margin-top: 0.2rem;
      width: 1.2rem;
      height: 1.2rem;
      min-width: 1.2rem;
      accent-color: var(--panel-accent, var(--supplies-color));
    }

    .checkbox-field span {
      margin: 0;
      font-size: clamp(0.98rem, 3.6vw, 1.1rem);
      font-weight: 600;
    }

    input[type="number"],
    input[type="text"],
    input[type="search"],
    input[type="date"],
    textarea,
    select,
    button {
      font: inherit;
    }

    textarea,
    input[type="number"],
    input[type="text"],
    input[type="search"],
    input[type="date"],
    select {
      width: 100%;
      padding: 0.75rem 0.85rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--surface-alt);
      color: inherit;
      min-height: 48px;
      font-size: clamp(1.05rem, 4vw, 1.2rem);
    }

    textarea:focus,
    input[type="number"]:focus,
    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus,
    button:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    textarea {
      resize: vertical;
      min-height: 96px;
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 999px;
      padding: 0.8rem 1.35rem;
      font-weight: 600;
      background: var(--button-bg, var(--accent));
      color: var(--button-fg, #fff);
      min-height: 48px;
      transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
      font-size: clamp(1.05rem, 4vw, 1.2rem);
    }

    button[disabled] {
      opacity: 0.65;
      cursor: not-allowed;
    }

    button:not([disabled]):hover {
      background: var(--button-hover-bg, var(--accent-strong));
    }

    button.secondary {
      --button-bg: var(--surface-alt);
      --button-hover-bg: #e9eef7;
      --button-fg: var(--accent);
      background: var(--button-bg);
      color: var(--button-fg);
      border: 1px solid var(--border);
    }

    .tab-nav button {
      --tab-color: var(--accent);
      --tab-color-strong: var(--accent-strong);
      --tab-soft: rgba(11, 87, 208, 0.12);
      --tab-border: rgba(11, 87, 208, 0.18);
      --button-bg: transparent;
      --button-hover-bg: var(--tab-soft);
      --button-fg: var(--muted);
      flex: 1 1 200px;
      min-width: 150px;
      padding: 0.65rem 1rem;
      border-radius: 999px;
      border: 1px solid transparent;
      background: var(--button-bg);
      color: var(--button-fg);
      font-weight: 600;
      font-size: clamp(0.95rem, 3.5vw, 1.05rem);
      text-align: center;
      white-space: nowrap;
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .tab-nav button:not(.active):hover {
      background: var(--tab-soft);
      border-color: var(--tab-border);
    }

    .tab-nav button.active {
      --button-bg: var(--tab-color);
      --button-hover-bg: var(--tab-color-strong);
      --button-fg: #fff;
      border-color: var(--tab-color);
      color: var(--button-fg);
      box-shadow: 0 16px 35px -24px rgba(11, 36, 82, 0.6);
    }

    .tab-nav button:focus-visible {
      outline-color: var(--tab-color);
    }

    .tab-nav button[data-tab-trigger="supplies"] {
      --tab-color: var(--supplies-color);
      --tab-color-strong: var(--supplies-color-strong);
      --tab-soft: var(--supplies-soft);
      --tab-border: var(--supplies-outline);
    }

    .tab-nav button[data-tab-trigger="it"] {
      --tab-color: var(--it-color);
      --tab-color-strong: var(--it-color-strong);
      --tab-soft: var(--it-soft);
      --tab-border: var(--it-outline);
    }

    .tab-nav button[data-tab-trigger="maintenance"] {
      --tab-color: var(--maintenance-color);
      --tab-color-strong: var(--maintenance-color-strong);
      --tab-soft: var(--maintenance-soft);
      --tab-border: var(--maintenance-outline);
    }

    #suppliesSubmitButton {
      --button-bg: var(--supplies-color);
      --button-hover-bg: var(--supplies-color-strong);
    }

    #itSubmitButton {
      --button-bg: var(--it-color);
      --button-hover-bg: var(--it-color-strong);
    }

    #maintenanceSubmitButton {
      --button-bg: var(--maintenance-color);
      --button-hover-bg: var(--maintenance-color-strong);
    }

    .inline-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .inline-buttons button.secondary.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .inline-buttons button.secondary.active:hover:not([disabled]) {
      background: var(--accent-strong);
    }

    .notice-block {
      border-radius: 12px;
      border: 1px solid var(--panel-accent-outline, rgba(11, 87, 208, 0.25));
      background: var(--panel-accent-soft, var(--accent-soft));
      padding: 1rem 1.15rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .notice-block h3 {
      margin: 0;
      font-size: clamp(1.05rem, 3.8vw, 1.2rem);
      font-weight: 600;
      color: var(--panel-accent-strong, var(--accent-strong));
    }

    .notice-block p {
      margin: 0;
      color: var(--muted);
      font-size: clamp(0.95rem, 3.6vw, 1.05rem);
    }

    .skeleton {
      position: relative;
      overflow: hidden;
      background: linear-gradient(90deg, #e4e8ee 25%, #f2f4f8 37%, #e4e8ee 63%);
      background-size: 400% 100%;
      animation: shimmer 1.4s ease infinite;
      border-radius: 12px;
      min-height: 44px;
    }

    .skeleton.sm {
      height: 18px;
      border-radius: 6px;
    }

    @keyframes shimmer {
      0% {
        background-position: 100% 0;
      }
      100% {
        background-position: -100% 0;
      }
    }

    .request-item,
    .catalog-item {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      padding: 0.7rem 0.85rem;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--surface);
      line-height: 1.45;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .catalog-item {
      cursor: pointer;
    }

    .catalog-item:hover {
      border-color: rgba(11, 87, 208, 0.3);
    }

    .catalog-item:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .request-item-head,
    .catalog-item-head {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.4rem;
    }

    .request-item-title,
    .catalog-item-title {
      font-size: clamp(1rem, 3.6vw, 1.15rem);
      font-weight: 600;
      flex: 1 1 160px;
      display: inline-flex;
    }

    .catalog-item-sku {
      margin-left: auto;
      font-size: clamp(0.78rem, 2.8vw, 0.92rem);
      color: var(--muted);
      background: var(--surface-alt);
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 0.25rem 0.55rem;
      line-height: 1;
      white-space: nowrap;
    }

    .request-item .status {
      margin-left: auto;
      font-size: clamp(0.85rem, 2.9vw, 0.95rem);
      padding: 0.3rem 0.65rem;
    }

    .request-item .urgency-badge {
      margin-left: 0;
      font-size: clamp(0.75rem, 2.8vw, 0.9rem);
      padding: 0.25rem 0.6rem;
    }

    .request-item-info,
    .catalog-item-info {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem 0.75rem;
      align-items: center;
    }

    .request-item-info .meta,
    .catalog-item-info .meta,
    .request-item-info .detail-line,
    .catalog-item-info .detail-line {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: clamp(0.85rem, 3vw, 0.95rem);
      color: var(--muted);
      padding: 0.1rem 0;
    }

    .request-item-footer {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem 0.75rem;
      align-items: center;
      margin-top: 0.2rem;
    }

    .request-notes {
      margin-top: 0.4rem;
      padding-top: 0.6rem;
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
    }

    .request-notes-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.35rem;
      font-size: clamp(0.85rem, 3vw, 0.95rem);
    }

    .request-notes-title {
      font-weight: 600;
      color: var(--text);
    }

    .request-notes-count {
      color: var(--muted);
    }

    .request-notes-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .request-note-latest {
      border-color: rgba(11, 87, 208, 0.28);
      background: rgba(11, 87, 208, 0.08);
      box-shadow: 0 10px 28px -24px rgba(11, 40, 84, 0.7);
    }

    .request-notes-archive {
      display: block;
    }

    .request-notes-archive:not([open]) .request-notes-collapsed {
      display: none;
    }

    .request-notes-collapsed {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .request-notes-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.45rem 0.9rem;
      border-radius: 999px;
      border: 1px solid rgba(11, 87, 208, 0.24);
      background: transparent;
      color: var(--accent-strong);
      font-size: clamp(0.82rem, 2.8vw, 0.94rem);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
      list-style: none;
    }

    .request-notes-toggle::-webkit-details-marker {
      display: none;
    }

    .request-notes-toggle:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .request-notes-archive[open] .request-notes-toggle {
      background: rgba(11, 87, 208, 0.08);
      border-color: rgba(11, 87, 208, 0.35);
      box-shadow: 0 12px 30px -26px rgba(11, 40, 84, 0.65);
    }

    .request-notes-toggle:hover {
      background: rgba(11, 87, 208, 0.12);
    }

    .request-notes-empty {
      margin: 0;
      color: var(--muted);
      font-size: clamp(0.82rem, 2.6vw, 0.92rem);
    }

    .request-note {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.55rem 0.65rem;
      background: var(--surface-alt);
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }

    .request-note-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      align-items: center;
      color: var(--muted);
      font-size: clamp(0.78rem, 2.6vw, 0.88rem);
    }

    .request-note-body {
      margin: 0;
      color: var(--text);
      font-size: clamp(0.85rem, 3vw, 0.95rem);
      white-space: pre-wrap;
    }

    .request-note-dot {
      color: var(--muted);
    }

    .request-note-form {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.6rem 0.65rem;
      background: rgba(11, 87, 208, 0.04);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .request-note-form textarea {
      min-height: 72px;
      resize: vertical;
      padding: 0.5rem 0.55rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: clamp(0.85rem, 2.8vw, 0.95rem);
      font-family: inherit;
    }

    .request-note-form textarea:focus {
      border-color: var(--accent);
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .request-note-helper {
      margin: 0;
      color: var(--muted);
      font-size: clamp(0.78rem, 2.6vw, 0.88rem);
    }

    .request-note-actions {
      display: flex;
      justify-content: flex-end;
    }

    .request-item-footer > .inline-buttons,
    .request-item-footer > .supplies-actions {
      flex: 1 1 100%;
    }

    .request-item-footer .supplies-actions {
      margin-top: 0;
    }

    .request-item-footer .supplies-actions .inline-buttons {
      gap: 0.5rem;
    }

    .request-item .eta-field {
      margin: 0;
      flex-direction: row;
      align-items: center;
      gap: 0.3rem;
      max-width: none;
      flex: 0 0 auto;
      padding: 0.1rem 0.35rem;
    }

    .request-item .eta-field span {
      font-size: clamp(0.85rem, 2.9vw, 0.95rem);
      margin: 0;
      display: inline-flex;
      align-items: center;
    }

    .request-item .eta-field input[type="date"] {
      width: min(38vw, 130px);
      min-width: 0;
      min-height: 32px;
      height: 32px;
      padding: 0.2rem 0.5rem;
      font-size: clamp(0.82rem, 2.4vw, 0.95rem);
      border-radius: 8px;
    }

    .catalog-field {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .catalog-combobox {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .catalog-search {
      position: relative;
    }

    .catalog-search::after {
      content: '\1F50D';
      position: absolute;
      right: 3.15rem;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: var(--muted);
      font-size: 1rem;
    }

    .catalog-search input[type="search"] {
      padding-right: 4.75rem;
      -webkit-appearance: none;
    }

    .catalog-clear {
      position: absolute;
      top: 50%;
      right: 0.65rem;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: none;
      background: rgba(32, 39, 49, 0.08);
      color: var(--text);
      font-size: 1.35rem;
      font-weight: 700;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease, transform 0.15s ease, background 0.15s ease;
    }

    .catalog-clear.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .catalog-clear:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .catalog-clear:hover {
      background: rgba(32, 39, 49, 0.14);
      transform: translateY(-50%) scale(1.05);
    }

    datalist option {
      font-size: clamp(1rem, 3.5vw, 1.1rem);
    }

    .input-helper {
      margin-top: 0.35rem;
      font-size: clamp(0.95rem, 3.3vw, 1.05rem);
      color: var(--muted);
      display: block;
    }

    .input-helper.custom-item-alert {
      margin-top: 0.75rem;
      margin-bottom: 0.25rem;
      font-size: clamp(1rem, 3.6vw, 1.1rem);
      font-weight: 700;
      color: var(--danger);
    }

    .urgency-badge {
      display: inline-flex;
      align-items: center;
      font-size: clamp(0.85rem, 3vw, 0.95rem);
      font-weight: 600;
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      border: 1px solid transparent;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .urgency-badge + .urgency-badge {
      margin-left: 0.35rem;
    }

    .urgency-badge[data-urgency="low"] {
      background: rgba(15, 157, 88, 0.12);
      border-color: rgba(15, 157, 88, 0.35);
      color: var(--success);
    }

    .urgency-badge[data-urgency="normal"] {
      background: rgba(251, 188, 5, 0.16);
      border-color: rgba(251, 188, 5, 0.4);
      color: #8c6d00;
    }

    .urgency-badge[data-urgency="critical"] {
      background: rgba(217, 48, 37, 0.12);
      border-color: rgba(217, 48, 37, 0.35);
      color: var(--danger);
    }

    .catalog-item.selected {
      border-color: rgba(11, 87, 208, 0.45);
      background: rgba(11, 87, 208, 0.08);
      box-shadow: 0 0 0 1px rgba(11, 87, 208, 0.18);
    }

    .catalog-item-title {
      font-size: clamp(1rem, 3.6vw, 1.15rem);
    }

    .catalog-item-info .usage {
      color: var(--accent-strong);
      font-weight: 500;
    }

    .catalog-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      align-self: flex-end;
      margin-left: auto;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(11, 87, 208, 0.12);
      color: var(--accent-strong);
      font-size: clamp(0.75rem, 2.9vw, 0.9rem);
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .catalog-badge::before {
      content: '\2605';
      font-size: 0.8rem;
    }

    .meta {
      font-size: clamp(0.95rem, 3.2vw, 1.05rem);
      color: var(--muted);
    }

    .detail-line {
      display: block;
      font-size: clamp(0.95rem, 3.4vw, 1.05rem);
      color: var(--muted);
    }

    .eta-field {
      margin-top: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      width: min(100%, 160px);
      max-width: 160px;
    }

    .eta-field span {
      font-size: clamp(0.9rem, 3.2vw, 1rem);
      font-weight: 600;
    }

    .eta-field input[type="date"] {
      width: min(100%, 140px);
    }

    @media (max-width: 520px) {
      header {
        padding: clamp(1.45rem, 7vw, 2rem) 0 clamp(2rem, 9vw, 2.6rem);
      }

      header .hero-inner {
        padding: 0 clamp(1rem, 6vw, 1.4rem);
      }

      .page-shell {
        padding: 0 clamp(1rem, 6vw, 1.4rem) clamp(3rem, 9vw, 3.6rem);
        gap: clamp(1.35rem, 6vw, 2rem);
      }

      nav.tab-nav {
        width: 100%;
        justify-self: stretch;
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 0.35rem;
        padding: 0.35rem;
        box-shadow: none;
      }

      .tab-nav button {
        width: 100%;
        padding: 0.65rem 0.75rem;
      }

      main {
        padding-bottom: clamp(2rem, 8vw, 2.85rem);
      }

      .catalog-clear {
        width: 34px;
        height: 34px;
      }
    }

    @media (max-width: 360px) {
      button {
        padding-inline: 1.1rem;
      }

      .tab-nav button {
        padding-inline: 0.7rem;
      }
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: clamp(0.95rem, 3.2vw, 1.05rem);
      font-weight: 600;
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      background: var(--surface);
      border: 1px solid var(--border);
    }

    .status[data-state="approved"] {
      border-color: rgba(15, 157, 88, 0.35);
      color: var(--success);
    }

    .status[data-state="completed"] {
      border-color: rgba(15, 157, 88, 0.35);
      color: var(--success);
    }

    .status[data-state="in_progress"],
    .status[data-state="ordered"] {
      border-color: rgba(11, 87, 208, 0.35);
      color: var(--accent);
    }

    .status[data-state="declined"],
    .status[data-state="denied"] {
      border-color: rgba(217, 48, 37, 0.35);
      color: var(--danger);
    }

    .supplies-actions {
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      margin-top: 0.5rem;
    }

    .supplies-actions .inline-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }

    .supplies-actions .inline-buttons button {
      width: 100%;
    }

    .empty {
      text-align: center;
      color: var(--muted);
      padding: 0.75rem 0;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .load-more {
      align-self: center;
    }

    #toast {
      position: fixed;
      left: 50%;
      bottom: 1.25rem;
      transform: translateX(-50%);
      background: rgba(32, 39, 49, 0.94);
      color: #fff;
      padding: 0.75rem 1.25rem;
      border-radius: 999px;
      box-shadow: 0 20px 35px -25px rgba(23, 32, 42, 0.8);
      display: none;
      z-index: 20;
      min-width: 200px;
      text-align: center;
    }

    @media (prefers-reduced-motion: reduce) {
      .skeleton {
        animation: none;
      }
    }

    @media (min-width: 600px) {
      body {
        font-size: 17px;
      }

      .tab-panel {
        gap: 1.5rem;
      }

      nav.tab-nav {
        justify-content: center;
      }
    }

    @media (min-width: 720px) {
      header {
        padding-bottom: clamp(2.2rem, 6vw, 3.25rem);
      }

      .page-shell {
        gap: clamp(1.75rem, 4vw, 2.5rem);
      }
    }

    @media (min-width: 1200px) {
      .tab-panel.active {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
        align-items: stretch;
      }

      .tab-panel.active[data-tab-panel="supplies"] {
        grid-template-columns: repeat(2, minmax(320px, 1fr));
      }

      .tab-panel.active[data-tab-panel="supplies"] #catalogCard {
        grid-column: 1 / -1;
      }

      .tab-panel.active section.card {
        height: 100%;
      }
    }
  </style>
</head>
<body data-active-tab="supplies">
  <header>
    <div class="hero-inner">
      <div class="hero-copy">
        <span class="hero-eyebrow">Operations hub</span>
        <h1 class="hero-title">Manage every request from one streamlined workspace</h1>
        <p class="hero-description">
          Submit supplies, IT, and maintenance needs in seconds. Track approvals and follow-ups without bouncing between
          sheets or inboxes.
        </p>
        <div class="hero-actions">
          <button type="button" data-tab-trigger="supplies" class="active">Start a supplies request</button>
          <button type="button" data-tab-trigger="it">Log IT issue</button>
          <button type="button" data-tab-trigger="maintenance">Log Maintenance issues</button>
        </div>
        <div class="hero-stats">
          <div class="hero-stat">
            <strong data-dashboard-outstanding="all">—</strong>
            <span>Awaiting action</span>
          </div>
          <div class="hero-stat">
            <strong data-dashboard-total="all">—</strong>
            <span>Total requests logged</span>
          </div>
        </div>
      </div>
      <div class="hero-dashboard-shell">
        <img
          class="hero-dashboard-logo"
          src="https://www.dublincleaners.com/wp-content/uploads/2024/12/Dublin-Logos-stacked.png"
          alt="Dublin Cleaners logo"
          loading="lazy"
          decoding="async"
          width="180"
        >
        <section
          class="hero-dashboard"
          id="heroDashboard"
          aria-label="Request activity dashboard"
          aria-live="polite"
        >
          <div class="dashboard-top">
            <div class="dashboard-header">
              <div class="dashboard-header-top">
                <h2 class="dashboard-title">Requests Dashboard</h2>
                <p class="meta" id="dashboardUpdatedAt">Awaiting data…</p>
              </div>
              <p class="dashboard-subcopy">Monitor throughput across all Requests and quickly spot bottlenecks.</p>
            </div>
            <div class="dashboard-visual">
              <canvas id="dashboardPie" width="260" height="260" role="img" aria-label="Outstanding requests by type"></canvas>
            </div>
          </div>
          <div class="dashboard-grid">
            <article class="dashboard-card" data-dashboard-card="supplies">
              <h3>Supplies</h3>
              <div class="metric-group">
                <span class="metric highlight">
                  <strong data-dashboard-outstanding="supplies">—</strong>
                  Open items
                </span>
                <span class="metric">
                  <strong data-dashboard-total="supplies">—</strong>
                  Logged total
                </span>
              </div>
            </article>
            <article class="dashboard-card" data-dashboard-card="it">
              <h3>IT</h3>
              <div class="metric-group">
                <span class="metric highlight">
                  <strong data-dashboard-outstanding="it">—</strong>
                  Open items
                </span>
                <span class="metric">
                  <strong data-dashboard-total="it">—</strong>
                  Logged total
                </span>
              </div>
            </article>
            <article class="dashboard-card" data-dashboard-card="maintenance">
              <h3>Maintenance</h3>
              <div class="metric-group">
                <span class="metric highlight">
                  <strong data-dashboard-outstanding="maintenance">—</strong>
                  Open items
                </span>
                <span class="metric">
                  <strong data-dashboard-total="maintenance">—</strong>
                  Logged total
                </span>
              </div>
            </article>
          </div>
          <p class="dashboard-empty" id="dashboardEmptyMessage" hidden>No requests yet.</p>
        </section>
      </div>
    </div>
  </header>
  <button
    type="button"
    id="feedbackLauncher"
    class="feedback-fab"
    aria-haspopup="dialog"
    aria-controls="feedbackDialog"
    aria-expanded="false"
  >
    <span class="feedback-fab-emoji" aria-hidden="true">💡</span>
    <span class="feedback-fab-label">Share an idea</span>
  </button>

  <div
    id="feedbackDialog"
    class="feedback-dialog"
    role="dialog"
    aria-modal="true"
    aria-labelledby="feedbackTitle"
    hidden
  >
    <div class="feedback-card" role="document">
      <button type="button" id="feedbackCloseButton" class="feedback-close" aria-label="Close feedback form">×</button>
      <div class="feedback-header">
        <h2 id="feedbackTitle">Help us shine brighter ✨</h2>
        <p class="feedback-subtitle">Share a bug or improvement idea—only one quick note is required, and you can stay anonymous.</p>
      </div>
      <form id="feedbackForm" class="feedback-form" novalidate>
        <fieldset>
          <legend>I'm sharing</legend>
          <div class="feedback-type-options">
            <label class="feedback-chip" data-selected="false">
              <input type="radio" name="feedbackType" value="improvement" required>
              <span class="feedback-chip-label">Improvement 🌟</span>
            </label>
            <label class="feedback-chip" data-selected="false">
              <input type="radio" name="feedbackType" value="bug" required>
              <span class="feedback-chip-label">Bug 🐞</span>
            </label>
            <label class="feedback-chip" data-selected="false">
              <input type="radio" name="feedbackType" value="other" required>
              <span class="feedback-chip-label">Other idea 💬</span>
            </label>
          </div>
        </fieldset>
        <p class="feedback-note">Pick the option that fits best. We just need the story—no personal details required.</p>
        <label>
          <span>Quick headline <span class="feedback-optional">(optional)</span></span>
          <input
            id="feedbackSummary"
            name="summary"
            type="text"
            maxlength="120"
            placeholder="e.g., Faster search results for catalog items"
          >
        </label>
        <label>
          <span>Tell us what happened<span class="feedback-required" aria-hidden="true">*</span></span>
          <textarea
            id="feedbackDetails"
            name="details"
            placeholder="Share the bug, idea, or context in your own words."
            required
          ></textarea>
        </label>
        <label>
          <span>How can we follow up? <span class="feedback-optional">(optional)</span></span>
          <input
            id="feedbackContact"
            name="contact"
            type="text"
            inputmode="email"
            autocomplete="off"
            placeholder="Share an email or chat handle, or leave blank to stay anonymous"
          >
        </label>
        <div id="feedbackStatus" class="feedback-status" role="status" aria-live="polite" hidden></div>
        <div class="feedback-actions">
          <button type="button" id="feedbackCancelButton" class="secondary">Not now</button>
          <button type="submit" id="feedbackSubmitButton">Send to the crew 🚀</button>
        </div>
      </form>
    </div>
  </div>
  <div class="page-shell">
    <nav class="tab-nav" aria-label="Request types">
      <button type="button" data-tab-trigger="supplies" class="active">Supplies</button>
      <button type="button" data-tab-trigger="it">IT</button>
      <button type="button" data-tab-trigger="maintenance">Maintenance</button>
    </nav>
    <div id="statusAuthNotice" class="notice" hidden></div>
    <main>
    <div class="tab-panel active" data-tab-panel="supplies">
      <section class="card" id="suppliesFormCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">New supplies request</span>
            <span class="card-subtitle meta">Use the catalog to quickly Search & fill in the item details before submitting.</span>
          </div>
          <button type="button" id="catalogScrollButton" class="card-header-action">Full Catalog</button>
        </div>
        <div class="card-body">
          <form id="suppliesForm" class="form-grid" novalidate>
            <label class="full-width">
              <span>Catalog item</span>
              <div class="catalog-field">
                <div class="catalog-combobox" role="group" aria-label="Catalog search">
                  <div class="catalog-search">
                    <input
                      id="catalogSearch"
                      type="search"
                      name="catalogSearch"
                      placeholder="Search by name, category, or SKU"
                      autocomplete="off"
                      spellcheck="false"
                      list="catalogOptions"
                      aria-autocomplete="list"
                    >
                    <button type="button" id="catalogClearButton" class="catalog-clear" aria-label="Clear selected catalog item">×</button>
                    <datalist id="catalogOptions"></datalist>
                  </div>
                </div>
                <input id="catalogSkuField" name="catalogSku" type="hidden">
              </div>
              <span class="input-helper custom-item-alert">Can't find it? Enter a Custom Item below.</span>
            </label>
            <label class="full-width">
              <span>Item name</span>
              <input
                id="suppliesDescription"
                name="description"
                type="text"
                placeholder="e.g., 2XL rubber gloves"
                autocomplete="off"
                required
              >
            </label>
            <label class="full-width requester-name-field" data-name-field="supplies">
              <span>Your name</span>
              <input id="suppliesRequesterName" name="requesterName" type="text" autocomplete="name">
            </label>
            <label>
              <span>Location</span>
              <select id="suppliesLocation" name="location" required>
                <option value="">Select a location</option>
                <option value="Plant">Plant</option>
                <option value="Short North">Short North</option>
                <option value="South Dublin">South Dublin</option>
                <option value="Muirfield">Muirfield</option>
                <option value="Morse Rd.">Morse Rd.</option>
                <option value="Granville">Granville</option>
                <option value="Newark">Newark</option>
              </select>
            </label>
            <label>
              <span>Quantity</span>
              <input id="suppliesQty" name="qty" type="number" min="1" step="1" required>
            </label>
            <label class="checkbox-field full-width">
              <input
                id="suppliesPlantCheck"
                name="plantCheck"
                type="checkbox"
                required
              >
              <span>I have checked with the Plant & searched all our supply cabinets?</span>
            </label>
            <label class="full-width">
              <span>Notes (optional)</span>
              <textarea id="suppliesNotes" name="notes" autocomplete="off"></textarea>
            </label>
          <div class="inline-buttons full-width">
            <button type="submit" id="suppliesSubmitButton">Submit request</button>
            <button type="button" id="suppliesResetButton" class="secondary">Reset</button>
          </div>
          <aside class="notice-block full-width" role="note" aria-label="Supply request approval process">
            <h3>Supply request approvals</h3>
            <p>All supply requests must be reviewed and approved by a Manager. Approved orders are placed once per week, every MONDAY.</p>
            <p>If your request is not included in that week’s order, it will automatically roll over to the following week. Please plan ahead and submit requests before your supplies run low. This process keeps ordering consistent, efficient, and ensures smooth operations.</p>
          </aside>
          <div
            class="approver-notice"
            data-approver-notice="supplies"
            role="alert"
            hidden
          ></div>
        </form>
      </div>
    </section>

      <section class="card" id="suppliesRequestsCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">Supplies requests</span>
            <span class="card-subtitle meta">Track order status and approvals in one place.</span>
          </div>
        </div>
        <div class="card-body">
          <div id="suppliesRequestsList" class="list" role="list"></div>
          <button type="button" id="suppliesMoreButton" class="load-more secondary">Load more</button>
        </div>
      </section>

      <section class="card" id="catalogCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">Catalog</span>
            <span class="card-subtitle meta">Tap an item to autofill the request form.</span>
          </div>
        </div>
        <div class="card-body">
          <div id="catalogList" class="list" role="list"></div>
          <button type="button" id="catalogMoreButton" class="load-more secondary">Load more</button>
        </div>
      </section>
    </div>

    <div class="tab-panel" data-tab-panel="it">
      <section class="card" id="itFormCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">New IT request</span>
            <span class="card-subtitle meta">Report technology issues or access needs for quick routing.</span>
          </div>
        </div>
        <div class="card-body">
          <form id="itForm" class="form-grid" novalidate>
            <label>
              <span>Location</span>
              <select id="itLocation" name="location" required>
                <option value="">Select a location</option>
                <option value="Plant">Plant</option>
                <option value="Short North">Short North</option>
                <option value="South Dublin">South Dublin</option>
                <option value="Muirfield">Muirfield</option>
                <option value="Morse Rd.">Morse Rd.</option>
                <option value="Granville">Granville</option>
                <option value="Newark">Newark</option>
              </select>
            </label>
            <label class="full-width requester-name-field" data-name-field="it">
              <span>Your name</span>
              <input id="itRequesterName" name="requesterName" type="text" autocomplete="name">
            </label>
            <label class="full-width">
              <span>Issue summary</span>
              <textarea id="itIssue" name="issue" autocomplete="off" required></textarea>
            </label>
            <label>
              <span>Device or system</span>
              <input id="itDevice" name="device" type="text" autocomplete="off">
            </label>
            <label>
              <span>Urgency</span>
              <select id="itUrgency" name="urgency">
                <option value="low">Low</option>
                <option value="normal">Normal</option>
                <option value="critical">Critical</option>
              </select>
            </label>
            <label class="full-width">
              <span>Additional details</span>
              <textarea id="itDetails" name="details" autocomplete="off"></textarea>
            </label>
            <div class="inline-buttons full-width">
              <button type="submit" id="itSubmitButton">Submit request</button>
              <button type="button" id="itResetButton" class="secondary">Reset</button>
            </div>
            <div
              class="approver-notice"
              data-approver-notice="it"
              role="alert"
              hidden
            ></div>
          </form>
        </div>
      </section>

      <section class="card" id="itRequestsCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">IT queue</span>
            <span class="card-subtitle meta">Monitor progress and close items when resolved.</span>
          </div>
        </div>
        <div class="card-body">
          <div id="itRequestsList" class="list" role="list"></div>
          <button type="button" id="itMoreButton" class="load-more secondary">Load more</button>
        </div>
      </section>
    </div>

    <div class="tab-panel" data-tab-panel="maintenance">
      <section class="card" id="maintenanceFormCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">New maintenance request</span>
            <span class="card-subtitle meta">Share location details so facilities can prioritize the work.</span>
          </div>
        </div>
        <div class="card-body">
          <form id="maintenanceForm" class="form-grid" novalidate>
            <label>
              <span>Location</span>
              <select id="maintenanceLocation" name="location" required>
                <option value="">Select a location</option>
                <option value="Plant">Plant</option>
                <option value="Short North">Short North</option>
                <option value="South Dublin">South Dublin</option>
                <option value="Muirfield">Muirfield</option>
                <option value="Morse Rd.">Morse Rd.</option>
                <option value="Granville">Granville</option>
                <option value="Newark">Newark</option>
              </select>
            </label>
            <label class="full-width requester-name-field" data-name-field="maintenance">
              <span>Your name</span>
              <input id="maintenanceRequesterName" name="requesterName" type="text" autocomplete="name">
            </label>
            <label class="full-width">
              <span>Issue description</span>
              <textarea id="maintenanceIssue" name="issue" autocomplete="off" required></textarea>
            </label>
            <label>
              <span>Urgency</span>
              <select id="maintenanceUrgency" name="urgency">
                <option value="low">Low</option>
                <option value="normal">Normal</option>
                <option value="critical">Critical</option>
              </select>
            </label>
            <label class="full-width">
              <span>Access notes (optional)</span>
              <textarea id="maintenanceAccessNotes" name="accessNotes" autocomplete="off"></textarea>
            </label>
            <div class="inline-buttons full-width">
              <button type="submit" id="maintenanceSubmitButton">Submit request</button>
              <button type="button" id="maintenanceResetButton" class="secondary">Reset</button>
            </div>
            <div
              class="approver-notice"
              data-approver-notice="maintenance"
              role="alert"
              hidden
            ></div>
          </form>
        </div>
      </section>

      <section class="card" id="maintenanceRequestsCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">Maintenance pipeline</span>
            <span class="card-subtitle meta">See outstanding work orders and update when finished.</span>
          </div>
        </div>
        <div class="card-body">
          <div id="maintenanceRequestsList" class="list" role="list"></div>
          <button type="button" id="maintenanceMoreButton" class="load-more secondary">Load more</button>
        </div>
      </section>
    </div>
  </main>
  </div>
  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    const SESSION = <?!= JSON.stringify(session) ?>;
  </script>
  <script>
    (function () {
      const hasServer = typeof google !== 'undefined' && google.script && google.script.run;
      const server = hasServer ? google.script.run : null;
      const REQUEST_KEYS = ['supplies', 'it', 'maintenance'];
      const DASHBOARD_COLORS = {
        supplies: '#0b57d0',
        it: '#0f9d58',
        maintenance: '#f29900'
      };
      const NOTE_SUPPORTED_TYPES = new Set(['it', 'maintenance']);
      const HIDE_ETA_STATUSES = new Set(['denied', 'declined']);
      const DASHBOARD_REFRESH_INTERVAL = 60000;
      const DASHBOARD_DEBOUNCE = 500;
      const PERSIST_DELAY = 240;
      const persistTimers = {};
      let warmScheduled = false;
      let syncingCatalogToDescription = false;
      let dashboardAutoRefreshId = null;
      let dashboardDeferredRefreshId = null;
      const FORM_TEMPLATES = {
        supplies: { description: '', qty: 1, notes: '', catalogSku: '', location: '', requesterName: '', plantConfirmed: false },
        it: { location: '', issue: '', device: '', urgency: 'normal', details: '', requesterName: '' },
        maintenance: { location: '', issue: '', urgency: 'normal', accessNotes: '', requesterName: '' }
      };
      const LOCAL_KEYS = {
        supplies: 'request-manager:supplies',
        it: 'request-manager:it',
        maintenance: 'request-manager:maintenance'
      };
      const DEVICE_STORAGE_KEY = 'request-manager:device-id';
      const EMPTY_REQUEST_MESSAGES = {
        supplies: 'No supplies requests are pending right now.',
        it: 'No IT tickets are in the queue right now.',
        maintenance: 'No maintenance work orders are pending right now.'
      };

      const state = {
        activeTab: 'supplies',
        forms: {
          supplies: Object.assign({}, FORM_TEMPLATES.supplies),
          it: Object.assign({}, FORM_TEMPLATES.it),
          maintenance: Object.assign({}, FORM_TEMPLATES.maintenance)
        },
        requesterName: '',
        deviceId: '',
        requests: {
          supplies: [],
          it: [],
          maintenance: []
        },
        noteDrafts: {
          it: {},
          maintenance: {}
        },
        nextTokens: {
          supplies: '',
          it: '',
          maintenance: ''
        },
        loading: {
          supplies: false,
          it: false,
          maintenance: false
        },
        loaded: {
          supplies: false,
          it: false,
          maintenance: false
        },
        catalog: {
          items: [],
          nextToken: '',
          loading: false,
          search: '',
          fullyLoaded: false
        },
        dashboard: {
          loading: false,
          metrics: makeEmptyDashboardMetrics(),
          totals: {
            totalRequests: 0,
            outstandingRequests: 0
          },
          generatedAt: ''
        }
      };

      const dom = {
        tabButtons: Array.from(document.querySelectorAll('[data-tab-trigger]')),
        panels: Array.from(document.querySelectorAll('[data-tab-panel]')),
        tabAnchors: {
          supplies: document.getElementById('suppliesFormCard'),
          it: document.getElementById('itFormCard'),
          maintenance: document.getElementById('maintenanceFormCard')
        },
        statusNotice: document.getElementById('statusAuthNotice'),
        toast: document.getElementById('toast'),
        supplies: {
          form: document.getElementById('suppliesForm'),
          location: document.getElementById('suppliesLocation'),
          qty: document.getElementById('suppliesQty'),
          notes: document.getElementById('suppliesNotes'),
          description: document.getElementById('suppliesDescription'),
          requesterName: document.getElementById('suppliesRequesterName'),
          requesterNameRow: document.querySelector('[data-name-field="supplies"]'),
          submit: document.getElementById('suppliesSubmitButton'),
          reset: document.getElementById('suppliesResetButton'),
          list: document.getElementById('suppliesRequestsList'),
          more: document.getElementById('suppliesMoreButton'),
          catalogSearch: document.getElementById('catalogSearch'),
          catalogOptions: document.getElementById('catalogOptions'),
          catalogSku: document.getElementById('catalogSkuField'),
          catalogList: document.getElementById('catalogList'),
          catalogMore: document.getElementById('catalogMoreButton'),
          catalogClear: document.getElementById('catalogClearButton'),
          catalogScroll: document.getElementById('catalogScrollButton'),
          plantCheck: document.getElementById('suppliesPlantCheck'),
          catalogCard: document.getElementById('catalogCard'),
          approverNotice: document.querySelector('[data-approver-notice="supplies"]')
        },
        it: {
          form: document.getElementById('itForm'),
          location: document.getElementById('itLocation'),
          issue: document.getElementById('itIssue'),
          device: document.getElementById('itDevice'),
          urgency: document.getElementById('itUrgency'),
          details: document.getElementById('itDetails'),
          requesterName: document.getElementById('itRequesterName'),
          requesterNameRow: document.querySelector('[data-name-field="it"]'),
          submit: document.getElementById('itSubmitButton'),
          reset: document.getElementById('itResetButton'),
          list: document.getElementById('itRequestsList'),
          more: document.getElementById('itMoreButton'),
          approverNotice: document.querySelector('[data-approver-notice="it"]')
        },
        maintenance: {
          form: document.getElementById('maintenanceForm'),
          location: document.getElementById('maintenanceLocation'),
          issue: document.getElementById('maintenanceIssue'),
          urgency: document.getElementById('maintenanceUrgency'),
          accessNotes: document.getElementById('maintenanceAccessNotes'),
          requesterName: document.getElementById('maintenanceRequesterName'),
          requesterNameRow: document.querySelector('[data-name-field="maintenance"]'),
          submit: document.getElementById('maintenanceSubmitButton'),
          reset: document.getElementById('maintenanceResetButton'),
          list: document.getElementById('maintenanceRequestsList'),
          more: document.getElementById('maintenanceMoreButton'),
          approverNotice: document.querySelector('[data-approver-notice="maintenance"]')
        },
        dashboard: {
          container: document.getElementById('heroDashboard'),
          updatedAt: document.getElementById('dashboardUpdatedAt'),
          empty: document.getElementById('dashboardEmptyMessage'),
          pie: document.getElementById('dashboardPie'),
          metrics: REQUEST_KEYS.reduce((acc, type) => {
            acc[type] = {
              total: document.querySelector(`[data-dashboard-total="${type}"]`),
              outstanding: document.querySelector(`[data-dashboard-outstanding="${type}"]`)
            };
            return acc;
          }, {}),
          overall: {
            total: document.querySelector('[data-dashboard-total="all"]'),
            outstanding: document.querySelector('[data-dashboard-outstanding="all"]')
          }
        },
        feedback: {
          launcher: document.getElementById('feedbackLauncher'),
          dialog: document.getElementById('feedbackDialog'),
          form: document.getElementById('feedbackForm'),
          close: document.getElementById('feedbackCloseButton'),
          cancel: document.getElementById('feedbackCancelButton'),
          submit: document.getElementById('feedbackSubmitButton'),
          status: document.getElementById('feedbackStatus'),
          summary: document.getElementById('feedbackSummary'),
          details: document.getElementById('feedbackDetails'),
          contact: document.getElementById('feedbackContact'),
          chips: Array.from(document.querySelectorAll('.feedback-chip')),
          typeInputs: Array.from(document.querySelectorAll('input[name="feedbackType"]'))
        }
      };

      const initialSessionEmail = SESSION && SESSION.email ? String(SESSION.email) : '';
      const canManageStatuses = Boolean(SESSION && SESSION.canManageStatuses);
      const requiresRequesterName = !initialSessionEmail;
      const statusAuth = SESSION && SESSION.statusAuth ? SESSION.statusAuth : null;
      const feedbackState = { open: false, submitting: false, closeTimer: null };

      renderStatusAuthNotice(statusAuth);
      configureRequesterNameRequirement();
      attachNavHandlers();
      attachFormHandlers();
      attachFeedbackHandlers();
      ensureDeviceId();
      REQUEST_KEYS.forEach(type => {
        hydrateFormFromCache(type);
      });
      initializeRequesterName();
      REQUEST_KEYS.forEach(type => {
        renderForm(type);
      });
      setActiveTab(state.activeTab);
      renderDashboard();
      if (hasServer) {
        loadDashboardMetrics({ silent: false });
        startDashboardAutoRefresh();
        loadCatalog({ append: false, fetchAll: true });
        ensureRequestsLoaded('supplies');
      } else {
        renderCatalog();
        REQUEST_KEYS.forEach(type => {
          state.loaded[type] = true;
          renderRequests(type);
        });
        showDashboardOfflineMessage();
      }

      function loadDashboardMetrics(options) {
        if (!server) {
          state.dashboard.loading = false;
          renderDashboard();
          return;
        }
        const silent = Boolean(options && options.silent);
        if (!silent) {
          state.dashboard.loading = true;
          renderDashboard();
        }
        const payload = { cid: makeCid() };
        server
          .withSuccessHandler(response => {
            state.dashboard.loading = false;
            if (!response || !response.ok) {
              if (!silent) {
                handleError(response, 'getDashboardMetrics', payload);
              } else {
                console.error('[RequestManager]', 'getDashboardMetrics', response);
              }
              return;
            }
            const metrics = makeEmptyDashboardMetrics();
            REQUEST_KEYS.forEach(type => {
              const entry = response.metrics && response.metrics[type] ? response.metrics[type] : null;
              const total = entry && Number(entry.total);
              const outstanding = entry && Number(entry.outstanding);
              metrics[type] = {
                total: Number.isFinite(total) && total > 0 ? total : 0,
                outstanding: Number.isFinite(outstanding) && outstanding > 0 ? outstanding : 0
              };
            });
            state.dashboard.metrics = metrics;
            const totals = response.totals || {};
            const totalRequests = Number(totals.totalRequests);
            const outstandingRequests = Number(totals.outstandingRequests);
            state.dashboard.totals = {
              totalRequests: Number.isFinite(totalRequests) && totalRequests >= 0
                ? totalRequests
                : REQUEST_KEYS.reduce((sum, type) => sum + metrics[type].total, 0),
              outstandingRequests: Number.isFinite(outstandingRequests) && outstandingRequests >= 0
                ? outstandingRequests
                : REQUEST_KEYS.reduce((sum, type) => sum + metrics[type].outstanding, 0)
            };
            state.dashboard.generatedAt = typeof response.generatedAt === 'string' ? response.generatedAt : '';
            renderDashboard();
          })
          .withFailureHandler(err => {
            state.dashboard.loading = false;
            if (!silent) {
              handleError(err, 'getDashboardMetrics', payload);
            } else {
              console.error('[RequestManager]', 'getDashboardMetrics', err);
            }
            renderDashboard();
          })
          .getDashboardMetrics(payload);
      }

      function renderDashboard() {
        const container = dom.dashboard && dom.dashboard.container;
        if (!container) {
          return;
        }
        const loading = Boolean(state.dashboard.loading);
        const metrics = state.dashboard.metrics || makeEmptyDashboardMetrics();
        const totals = state.dashboard.totals || { totalRequests: 0, outstandingRequests: 0 };
        container.setAttribute('aria-busy', loading ? 'true' : 'false');
        if (dom.dashboard.overall.total) {
          dom.dashboard.overall.total.textContent = loading ? '…' : formatDashboardCount(totals.totalRequests || 0);
        }
        if (dom.dashboard.overall.outstanding) {
          dom.dashboard.overall.outstanding.textContent = loading ? '…' : formatDashboardCount(totals.outstandingRequests || 0);
        }
        REQUEST_KEYS.forEach(type => {
          const elements = dom.dashboard.metrics[type];
          const entry = metrics[type] || { total: 0, outstanding: 0 };
          const totalLabel = loading ? '…' : formatDashboardCount(entry.total);
          const outstandingLabel = loading ? '…' : formatDashboardCount(entry.outstanding);
          if (elements) {
            if (elements.total) {
              elements.total.textContent = totalLabel;
            }
            if (elements.outstanding) {
              elements.outstanding.textContent = outstandingLabel;
            }
          }
        });
        updateDashboardEmptyState(metrics, loading);
        updateDashboardTimestamp();
        drawDashboardPie();
      }

      function updateDashboardEmptyState(metrics, loading) {
        const empty = dom.dashboard && dom.dashboard.empty;
        if (!empty) {
          return;
        }
        if (!hasServer) {
          empty.hidden = false;
          empty.textContent = 'Connect to Google Apps Script to load live data.';
          return;
        }
        const hasRequests = REQUEST_KEYS.some(type => {
          const entry = metrics[type] || { total: 0 };
          return Number(entry.total) > 0;
        });
        if (!hasRequests) {
          empty.hidden = false;
          empty.textContent = loading && !state.dashboard.generatedAt ? 'Loading dashboard…' : 'No requests yet.';
          return;
        }
        empty.hidden = true;
      }

      function updateDashboardTimestamp() {
        const label = dom.dashboard && dom.dashboard.updatedAt;
        if (!label) {
          return;
        }
        if (!hasServer) {
          label.textContent = 'Offline preview';
          return;
        }
        if (state.dashboard.loading && !state.dashboard.generatedAt) {
          label.textContent = 'Loading…';
          return;
        }
        if (!state.dashboard.generatedAt) {
          label.textContent = 'Awaiting data…';
          return;
        }
        const timestamp = new Date(state.dashboard.generatedAt);
        if (!Number.isNaN(timestamp.getTime())) {
          label.textContent = `Updated ${timestamp.toLocaleString()}`;
        } else {
          label.textContent = 'Updated moments ago';
        }
      }

      function drawDashboardPie() {
        const canvas = dom.dashboard && dom.dashboard.pie;
        if (!canvas || typeof canvas.getContext !== 'function') {
          return;
        }
        const rect = canvas.getBoundingClientRect();
        const displayWidth = rect.width || canvas.width || 220;
        const displayHeight = rect.height || canvas.height || 220;
        const ratio = window.devicePixelRatio || 1;
        const targetWidth = Math.max(1, Math.round(displayWidth * ratio));
        const targetHeight = Math.max(1, Math.round(displayHeight * ratio));
        if (canvas.width !== targetWidth || canvas.height !== targetHeight) {
          canvas.width = targetWidth;
          canvas.height = targetHeight;
        }
        const ctx = canvas.getContext('2d');
        if (!ctx) {
          return;
        }
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        if (ratio !== 1) {
          ctx.scale(ratio, ratio);
        }
        ctx.clearRect(0, 0, displayWidth, displayHeight);
        const metrics = state.dashboard.metrics || makeEmptyDashboardMetrics();
        const values = REQUEST_KEYS.map(type => {
          const entry = metrics[type] || { outstanding: 0 };
          const value = Number(entry.outstanding);
          return Number.isFinite(value) && value > 0 ? value : 0;
        });
        const total = values.reduce((sum, value) => sum + value, 0);
        const centerX = displayWidth / 2;
        const centerY = displayHeight / 2;
        const radius = Math.max(10, Math.min(centerX, centerY) - 6);
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
        ctx.fillStyle = '#eef2f7';
        ctx.fill();
        ctx.lineWidth = 1;
        ctx.strokeStyle = '#d7dce1';
        ctx.stroke();
        if (!total) {
          return;
        }
        let startAngle = -Math.PI / 2;
        values.forEach((value, index) => {
          if (!value) {
            return;
          }
          const type = REQUEST_KEYS[index];
          const endAngle = startAngle + (value / total) * Math.PI * 2;
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.arc(centerX, centerY, radius, startAngle, endAngle, false);
          ctx.closePath();
          ctx.fillStyle = DASHBOARD_COLORS[type] || '#0b57d0';
          ctx.fill();
          startAngle = endAngle;
        });
        const innerRadius = Math.max(radius * 0.55, radius - 44);
        ctx.beginPath();
        ctx.arc(centerX, centerY, innerRadius, 0, Math.PI * 2);
        ctx.fillStyle = '#ffffff';
        ctx.fill();
        ctx.fillStyle = '#202731';
        ctx.font = '600 16px "Segoe UI", sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(formatDashboardCount(total), centerX, centerY - 8);
        ctx.font = '500 12px "Segoe UI", sans-serif';
        ctx.fillStyle = '#5c6774';
        ctx.fillText('outstanding', centerX, centerY + 10);
      }

      function formatDashboardCount(value) {
        const number = Number(value);
        if (!Number.isFinite(number)) {
          return '0';
        }
        return number.toLocaleString();
      }

      function makeEmptyDashboardMetrics() {
        return REQUEST_KEYS.reduce((acc, type) => {
          acc[type] = { total: 0, outstanding: 0 };
          return acc;
        }, {});
      }

      function requestDashboardRefresh(delay) {
        if (!hasServer) {
          return;
        }
        const wait = typeof delay === 'number' && delay >= 0 ? delay : DASHBOARD_DEBOUNCE;
        if (dashboardDeferredRefreshId) {
          window.clearTimeout(dashboardDeferredRefreshId);
        }
        dashboardDeferredRefreshId = window.setTimeout(() => {
          dashboardDeferredRefreshId = null;
          loadDashboardMetrics({ silent: true });
        }, wait);
      }

      function startDashboardAutoRefresh() {
        if (!hasServer) {
          return;
        }
        stopDashboardAutoRefresh();
        dashboardAutoRefreshId = window.setInterval(() => {
          loadDashboardMetrics({ silent: true });
        }, DASHBOARD_REFRESH_INTERVAL);
      }

      function stopDashboardAutoRefresh() {
        if (dashboardAutoRefreshId) {
          window.clearInterval(dashboardAutoRefreshId);
          dashboardAutoRefreshId = null;
        }
        if (dashboardDeferredRefreshId) {
          window.clearTimeout(dashboardDeferredRefreshId);
          dashboardDeferredRefreshId = null;
        }
      }

      function showDashboardOfflineMessage() {
        const empty = dom.dashboard && dom.dashboard.empty;
        if (empty) {
          empty.hidden = false;
          empty.textContent = 'Connect to Google Apps Script to load live data.';
        }
        const label = dom.dashboard && dom.dashboard.updatedAt;
        if (label) {
          label.textContent = 'Offline preview';
        }
      }

      function clearApproverNotices() {
        REQUEST_KEYS.forEach(type => {
          const container = dom[type] && dom[type].approverNotice;
          if (!container) {
            return;
          }
          while (container.firstChild) {
            container.removeChild(container.firstChild);
          }
          delete container.dataset.variant;
          container.hidden = true;
        });
      }

function renderApproverUnavailable(auth) {
        const messageText = auth && auth.reason === 'missing_email'
          ? 'We could not confirm your Google Account email. To Approve a Request, Sign in with an authorized account.'
          : `${auth && auth.email ? auth.email : 'This account'} is not on the approver allowlist.`;
        const hintText = 'An administrator can add approver emails.';
        REQUEST_KEYS.forEach(type => {
          const container = dom[type] && dom[type].approverNotice;
          if (!container) {
            return;
          }
          container.dataset.variant = 'warning';
          const title = document.createElement('strong');
          title.textContent = 'Approver access unavailable';
          container.appendChild(title);
          const message = document.createElement('p');
          message.textContent = messageText;
          container.appendChild(message);
          const hint = document.createElement('p');
          hint.textContent = hintText;
          container.appendChild(hint);
          container.hidden = false;
        });
      }

      function renderStatusAuthNotice(auth) {
        const notice = dom.statusNotice;
        if (notice) {
          while (notice.firstChild) {
            notice.removeChild(notice.firstChild);
          }
          delete notice.dataset.variant;
          notice.hidden = true;
        }
        clearApproverNotices();
        if (!auth) {
          return;
        }
        if (!auth.authorized) {
          renderApproverUnavailable(auth);
          return;
        }
        if (auth.allowlistSource === 'script_property' && notice) {
          notice.dataset.variant = 'info';
          const title = document.createElement('strong');
          title.textContent = 'Managed approver list active';
          notice.appendChild(title);
          const message = document.createElement('p');
          message.textContent = 'Approver permissions are being served from the SUPPLIES_TRACKING_STATUS_EMAILS script property fallback.';
          notice.appendChild(message);
          notice.hidden = false;
        }
      }

      function attachNavHandlers() {
        dom.tabButtons.forEach(button => {
          button.addEventListener('click', () => {
            const type = button.getAttribute('data-tab-trigger');
            if (type && REQUEST_KEYS.indexOf(type) !== -1) {
              const shouldScroll = Boolean(button.closest('.hero-actions'));
              setActiveTab(type);
              if (shouldScroll) {
                window.requestAnimationFrame(() => {
                  scrollToTab(type);
                });
              }
            }
          });
        });
      }

      function scrollToTab(type) {
        const anchor = dom.tabAnchors && dom.tabAnchors[type];
        const nav = document.querySelector('.tab-nav');
        if (
          !anchor ||
          !nav ||
          typeof anchor.getBoundingClientRect !== 'function' ||
          typeof nav.getBoundingClientRect !== 'function'
        ) {
          return;
        }

        const navRect = nav.getBoundingClientRect();
        const navStyles = typeof window.getComputedStyle === 'function' ? window.getComputedStyle(nav) : null;
        const navSpacing = navStyles ? parseFloat(navStyles.marginBottom || '0') : 0;
        const navOffset = navRect.height + navSpacing;
        const extraSpacing = 16;
        const navSafePadding = 12;

        const anchorRect = anchor.getBoundingClientRect();
        const anchorTop = anchorRect.top + window.pageYOffset;
        const navTop = navRect.top + window.pageYOffset;

        const anchorTarget = anchorTop - navOffset - extraSpacing;
        const navTarget = navTop - navSafePadding;
        const targetTop = Math.max(Math.min(anchorTarget, navTarget), 0);

        window.scrollTo({ top: targetTop, behavior: 'smooth' });
      }

      function attachFormHandlers() {
        dom.supplies.form.addEventListener('submit', evt => handleSubmit(evt, 'supplies'));
        dom.supplies.reset.addEventListener('click', () => {
          resetForm('supplies');
        });
        dom.supplies.location.addEventListener('change', () => {
          setFormState('supplies', { location: dom.supplies.location.value });
          persistForm('supplies');
        });
        dom.supplies.qty.addEventListener('input', () => {
          const qty = Number(dom.supplies.qty.value);
          const sanitized = Number.isFinite(qty) && qty > 0 ? Math.floor(qty) : 1;
          setFormState('supplies', { qty: sanitized });
          dom.supplies.qty.value = sanitized;
          persistForm('supplies');
        });
        dom.supplies.notes.addEventListener('input', () => {
          setFormState('supplies', { notes: dom.supplies.notes.value });
          persistForm('supplies');
        });
        dom.supplies.description.addEventListener('input', () => {
          const value = dom.supplies.description.value || '';
          const trimmed = value.trim();
          if (!syncingCatalogToDescription) {
            let matchedSku = '';
            if (trimmed) {
              const match = state.catalog.items.find(item => item.description.toLowerCase() === trimmed.toLowerCase());
              if (match) {
                matchedSku = match.sku;
              }
            }
            setFormState('supplies', { description: value, catalogSku: matchedSku });
            dom.supplies.catalogSku.value = matchedSku;
          } else {
            setFormState('supplies', { description: value });
          }
          persistForm('supplies');
          if (state.catalog.items.length) {
            renderCatalog();
          }
        });
        dom.supplies.catalogSearch.addEventListener('focus', () => {
          ensureFullCatalogLoaded();
          updateCatalogSearchAffordances();
        });
        dom.supplies.catalogSearch.addEventListener('click', () => {
          ensureFullCatalogLoaded();
        });
        if (dom.supplies.requesterName) {
          dom.supplies.requesterName.addEventListener('input', () => {
            handleRequesterNameInput('supplies');
          });
        }
        const handleCatalogSearchInput = () => {
          const rawValue = dom.supplies.catalogSearch.value || '';
          state.catalog.search = rawValue;
          ensureFullCatalogLoaded();
          const option = findCatalogOption(rawValue);
          if (option) {
            selectCatalogSku(option.dataset ? option.dataset.sku || '' : '', { searchValue: rawValue, updateSearch: false });
          } else {
            selectCatalogSku('', { searchValue: rawValue, updateSearch: false, preserveDescription: true });
          }
          if (state.catalog.items.length) {
            renderCatalog();
          }
          updateCatalogSearchAffordances();
        };
        dom.supplies.catalogSearch.addEventListener('input', handleCatalogSearchInput);
        dom.supplies.catalogSearch.addEventListener('change', handleCatalogSearchInput);
        if (dom.supplies.catalogClear) {
          dom.supplies.catalogClear.addEventListener('click', () => {
            dom.supplies.catalogSearch.value = '';
            state.catalog.search = '';
            selectCatalogSku('', { updateSearch: false, preserveDescription: true });
            renderCatalog();
            updateCatalogSearchAffordances();
            dom.supplies.catalogSearch.focus();
          });
        }
        if (dom.supplies.catalogScroll) {
          dom.supplies.catalogScroll.addEventListener('click', () => {
            state.catalog.search = '';
            if (dom.supplies.catalogSearch) {
              dom.supplies.catalogSearch.value = '';
            }
            selectCatalogSku('', { updateSearch: false, preserveDescription: true });
            ensureFullCatalogLoaded();
            renderCatalog();
            if (dom.supplies.catalogCard) {
              window.requestAnimationFrame(() => {
                dom.supplies.catalogCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
              });
            }
          });
        }
        if (dom.supplies.plantCheck) {
          dom.supplies.plantCheck.addEventListener('change', () => {
            setFormState('supplies', { plantConfirmed: dom.supplies.plantCheck.checked });
            persistForm('supplies');
          });
        }
        dom.supplies.more.addEventListener('click', () => {
          if (!state.loading.supplies && state.nextTokens.supplies) {
            loadRequests('supplies', { append: true });
          }
        });
        dom.supplies.catalogMore.addEventListener('click', () => {
          if (!state.catalog.loading) {
            loadCatalog({ append: false, fetchAll: true });
          }
        });
        dom.it.form.addEventListener('submit', evt => handleSubmit(evt, 'it'));
        dom.it.reset.addEventListener('click', () => {
          resetForm('it');
        });
        dom.it.location.addEventListener('change', () => {
          setFormState('it', { location: dom.it.location.value });
          persistForm('it');
        });
        if (dom.it.requesterName) {
          dom.it.requesterName.addEventListener('input', () => {
            handleRequesterNameInput('it');
          });
        }
        dom.it.issue.addEventListener('input', () => {
          setFormState('it', { issue: dom.it.issue.value });
          persistForm('it');
        });
        dom.it.device.addEventListener('input', () => {
          setFormState('it', { device: dom.it.device.value });
          persistForm('it');
        });
        dom.it.urgency.addEventListener('change', () => {
          setFormState('it', { urgency: dom.it.urgency.value });
          persistForm('it');
        });
        dom.it.details.addEventListener('input', () => {
          setFormState('it', { details: dom.it.details.value });
          persistForm('it');
        });
        dom.it.more.addEventListener('click', () => {
          if (!state.loading.it && state.nextTokens.it) {
            loadRequests('it', { append: true });
          }
        });

        dom.maintenance.form.addEventListener('submit', evt => handleSubmit(evt, 'maintenance'));
        dom.maintenance.reset.addEventListener('click', () => {
          resetForm('maintenance');
        });
        dom.maintenance.location.addEventListener('change', () => {
          setFormState('maintenance', { location: dom.maintenance.location.value });
          persistForm('maintenance');
        });
        if (dom.maintenance.requesterName) {
          dom.maintenance.requesterName.addEventListener('input', () => {
            handleRequesterNameInput('maintenance');
          });
        }
        dom.maintenance.issue.addEventListener('input', () => {
          setFormState('maintenance', { issue: dom.maintenance.issue.value });
          persistForm('maintenance');
        });
        dom.maintenance.urgency.addEventListener('change', () => {
          setFormState('maintenance', { urgency: dom.maintenance.urgency.value });
          persistForm('maintenance');
        });
        dom.maintenance.accessNotes.addEventListener('input', () => {
          setFormState('maintenance', { accessNotes: dom.maintenance.accessNotes.value });
          persistForm('maintenance');
        });
        dom.maintenance.more.addEventListener('click', () => {
          if (!state.loading.maintenance && state.nextTokens.maintenance) {
            loadRequests('maintenance', { append: true });
          }
        });
      }

      function attachFeedbackHandlers() {
        const feedback = dom.feedback;
        if (!feedback || !feedback.launcher || !feedback.dialog || !feedback.form) {
          return;
        }
        if (feedback.submit && !feedback.submit.dataset.defaultLabel) {
          feedback.submit.dataset.defaultLabel = feedback.submit.textContent || 'Send';
        }
        feedback.launcher.addEventListener('click', () => {
          if (feedbackState.submitting) {
            return;
          }
          openFeedbackDialog();
        });
        if (feedback.close) {
          feedback.close.addEventListener('click', () => {
            closeFeedbackDialog({ restoreFocus: true });
          });
        }
        if (feedback.cancel) {
          feedback.cancel.addEventListener('click', () => {
            closeFeedbackDialog({ restoreFocus: true });
          });
        }
        feedback.dialog.addEventListener('click', evt => {
          if (feedbackState.submitting) {
            return;
          }
          if (evt.target === feedback.dialog) {
            closeFeedbackDialog({ restoreFocus: true });
          }
        });
        feedback.form.addEventListener('submit', handleFeedbackSubmit);
        const typeInputs = feedback.typeInputs || [];
        typeInputs.forEach(input => {
          const chip = input.closest('.feedback-chip');
          updateFeedbackChipState(chip, Boolean(input.checked));
          input.addEventListener('change', () => {
            typeInputs.forEach(other => {
              const otherChip = other.closest('.feedback-chip');
              updateFeedbackChipState(otherChip, Boolean(other.checked));
            });
          });
          input.addEventListener('focus', () => {
            const owner = input.closest('.feedback-chip');
            if (owner) {
              owner.dataset.focused = 'true';
            }
          });
          input.addEventListener('blur', () => {
            const owner = input.closest('.feedback-chip');
            if (owner) {
              delete owner.dataset.focused;
            }
          });
        });
        document.addEventListener('keydown', handleFeedbackKeydown);
      }

      function openFeedbackDialog() {
        const feedback = dom.feedback;
        if (!feedback || !feedback.dialog) {
          return;
        }
        if (feedbackState.closeTimer) {
          window.clearTimeout(feedbackState.closeTimer);
          feedbackState.closeTimer = null;
        }
        feedbackState.open = true;
        feedback.dialog.hidden = false;
        if (feedback.launcher) {
          feedback.launcher.setAttribute('aria-expanded', 'true');
        }
        clearFeedbackStatus();
        window.requestAnimationFrame(() => {
          if (feedback.details) {
            feedback.details.focus();
          } else if (feedback.summary) {
            feedback.summary.focus();
          }
        });
      }

      function closeFeedbackDialog(options) {
        const feedback = dom.feedback;
        if (!feedback || !feedback.dialog) {
          return;
        }
        if (feedbackState.closeTimer) {
          window.clearTimeout(feedbackState.closeTimer);
          feedbackState.closeTimer = null;
        }
        feedbackState.open = false;
        feedback.dialog.hidden = true;
        if (feedback.launcher) {
          feedback.launcher.setAttribute('aria-expanded', 'false');
        }
        if (options && options.restoreFocus && feedback.launcher) {
          feedback.launcher.focus();
        }
        if (options && options.reset) {
          resetFeedbackForm();
        }
        clearFeedbackStatus();
      }

      function handleFeedbackKeydown(evt) {
        if (!feedbackState.open || feedbackState.submitting || evt.defaultPrevented) {
          return;
        }
        if (evt.key === 'Escape') {
          evt.preventDefault();
          closeFeedbackDialog({ restoreFocus: true });
        }
      }

      function handleFeedbackSubmit(evt) {
        evt.preventDefault();
        const feedback = dom.feedback;
        if (!feedback || !feedback.form || feedbackState.submitting) {
          return;
        }
        if (!feedback.form.checkValidity()) {
          feedback.form.reportValidity();
          return;
        }
        clearFeedbackStatus();
        setFeedbackSubmitting(true);
        const selectedType = getSelectedFeedbackType();
        const payload = {
          cid: makeCid(),
          clientRequestId: makeClientRequestId('feedback'),
          feedback: {
            type: selectedType,
            summary: sanitizeFeedbackText(feedback.summary && feedback.summary.value),
            details: sanitizeFeedbackText(feedback.details && feedback.details.value),
            contact: sanitizeFeedbackText(feedback.contact && feedback.contact.value)
          }
        };
        const onSuccess = () => {
          setFeedbackSubmitting(false);
          setFeedbackStatus('Love it! We\'ll make sure the team sees this insight.', 'success');
          resetFeedbackForm({ preserveStatus: true });
          feedbackState.closeTimer = window.setTimeout(() => {
            closeFeedbackDialog({ restoreFocus: true, reset: true });
          }, 2400);
          showToast('Thanks! Your idea is on its way ✉️');
        };
        const onError = err => {
          setFeedbackSubmitting(false);
          const message = resolveErrorMessage(err);
          setFeedbackStatus(message, 'error');
        };
        if (!server) {
          window.setTimeout(onSuccess, 300);
          return;
        }
        server
          .withSuccessHandler(response => {
            if (!response || !response.ok) {
              onError(response);
              return;
            }
            onSuccess();
          })
          .withFailureHandler(onError)
          .submitAppFeedback(payload);
      }

      function setFeedbackSubmitting(submitting) {
        const feedback = dom.feedback;
        feedbackState.submitting = Boolean(submitting);
        if (!feedback) {
          return;
        }
        const typeInputs = feedback.typeInputs || [];
        typeInputs.forEach(input => {
          input.disabled = feedbackState.submitting;
        });
        ['summary', 'details', 'contact'].forEach(key => {
          const field = feedback[key];
          if (field) {
            field.disabled = feedbackState.submitting;
          }
        });
        if (feedback.submit) {
          const defaultLabel = feedback.submit.dataset.defaultLabel || 'Send';
          feedback.submit.disabled = feedbackState.submitting;
          feedback.submit.textContent = feedbackState.submitting ? 'Sending…' : defaultLabel;
        }
        if (feedback.cancel) {
          feedback.cancel.disabled = feedbackState.submitting;
        }
        if (feedback.close) {
          feedback.close.disabled = feedbackState.submitting;
        }
      }

      function setFeedbackStatus(message, state) {
        const feedback = dom.feedback;
        if (!feedback || !feedback.status) {
          return;
        }
        if (!message) {
          clearFeedbackStatus();
          return;
        }
        feedback.status.hidden = false;
        feedback.status.dataset.state = state === 'error' ? 'error' : 'success';
        feedback.status.textContent = message;
      }

      function clearFeedbackStatus() {
        const feedback = dom.feedback;
        if (!feedback || !feedback.status) {
          return;
        }
        feedback.status.hidden = true;
        feedback.status.textContent = '';
        delete feedback.status.dataset.state;
      }

      function resetFeedbackForm(options) {
        const feedback = dom.feedback;
        if (!feedback || !feedback.form) {
          return;
        }
        feedback.form.reset();
        const typeInputs = feedback.typeInputs || [];
        typeInputs.forEach(input => {
          const chip = input.closest('.feedback-chip');
          updateFeedbackChipState(chip, Boolean(input.checked));
        });
        if (!options || !options.preserveStatus) {
          clearFeedbackStatus();
        }
      }

      function updateFeedbackChipState(chip, selected) {
        if (!chip) {
          return;
        }
        chip.dataset.selected = selected ? 'true' : 'false';
      }

      function getSelectedFeedbackType() {
        const feedback = dom.feedback;
        if (!feedback) {
          return '';
        }
        const match = (feedback.typeInputs || []).find(input => input.checked);
        return match ? sanitizeFeedbackText(match.value) : '';
      }

      function sanitizeFeedbackText(value) {
        return typeof value === 'string' ? value.trim() : '';
      }

      function setActiveTab(type) {
        state.activeTab = type;
        if (document && document.body) {
          document.body.dataset.activeTab = type;
        }
        dom.tabButtons.forEach(button => {
          button.classList.toggle('active', button.getAttribute('data-tab-trigger') === type);
        });
        dom.panels.forEach(panel => {
          panel.classList.toggle('active', panel.getAttribute('data-tab-panel') === type);
        });
        ensureRequestsLoaded(type);
        scheduleWarmCache();
      }

      function ensureRequestsLoaded(type) {
        if (state.loaded[type] || !hasServer) {
          return;
        }
        loadRequests(type, { append: false });
      }

      function scheduleWarmCache() {
        if (!hasServer || warmScheduled) {
          return;
        }
        warmScheduled = true;
        const idle = typeof window.requestIdleCallback === 'function'
          ? window.requestIdleCallback
          : callback => setTimeout(() => callback({ didTimeout: false }), 600);
        idle(() => {
          const others = REQUEST_KEYS.filter(tab => tab !== state.activeTab);
          others.forEach((type, index) => {
            setTimeout(() => {
              if (!state.loaded[type]) {
                loadRequests(type, { append: false });
              }
            }, index * 220);
          });
        });
      }

      function handleSubmit(event, type) {
        event.preventDefault();
        const formState = state.forms[type];
        const validationError = validateForm(type, formState);
        if (validationError) {
          handleError({ message: validationError }, `${type}:validation`);
          return;
        }
        const deviceId = ensureDeviceId();
        if (!deviceId) {
          handleError({ message: 'Unable to identify this device. Please enable local storage and try again.' }, `${type}:device`);
          return;
        }
        if (!server) {
          showToast('Connect to Google Apps Script to submit requests.');
          return;
        }
        disableForm(type, true);
        const payload = Object.assign({
          cid: makeCid(),
          clientRequestId: makeClientRequestId(type),
          type,
          deviceId
        }, formState);
        if (requiresRequesterName) {
          payload.requesterName = state.requesterName || formState.requesterName || '';
        }
        server
          .withSuccessHandler(response => {
            disableForm(type, false);
            if (!response || !response.ok || !response.request) {
              handleError(response, 'createRequest', payload);
              return;
            }
            showToast('Request submitted');
            setRequesterName('', { skipPersist: true });
            REQUEST_KEYS.forEach(key => {
              resetForm(key, { preserveRequesterName: false });
            });
            state.requests[type].unshift(response.request);
            renderRequests(type);
            requestDashboardRefresh(DASHBOARD_DEBOUNCE);
          })
          .withFailureHandler(err => {
            disableForm(type, false);
            handleError(err, 'createRequest', payload);
          })
          .createRequest(payload);
      }

      function validateForm(type, formState) {
        if (requiresRequesterName) {
          const nameValue = (state.requesterName || formState.requesterName || '').trim();
          if (!nameValue) {
            return 'Your name is required.';
          }
        }
        switch (type) {
          case 'supplies':
            if (!formState.location || !formState.location.trim()) {
              return 'Location is required.';
            }
            if (!formState.description || !formState.description.trim()) {
              return 'Item name is required.';
            }
            if (!formState.qty || Number(formState.qty) <= 0) {
              return 'Quantity must be at least 1.';
            }
            if (!formState.plantConfirmed) {
              return 'Please confirm you have checked with The Plant & our supplies cabinet first.';
            }
            return '';
          case 'it':
            if (!formState.location || !formState.location.trim()) {
              return 'Location is required.';
            }
            if (!formState.issue || !formState.issue.trim()) {
              return 'Issue summary is required.';
            }
            return '';
          case 'maintenance':
            if (!formState.location || !formState.location.trim()) {
              return 'Location is required.';
            }
            if (!formState.issue || !formState.issue.trim()) {
              return 'Issue description is required.';
            }
            return '';
          default:
            return 'Unsupported request type.';
        }
      }

      function resetForm(type, options) {
        const opts = options || {};
        const preserveRequester = opts.preserveRequesterName !== false;
        state.forms[type] = Object.assign({}, FORM_TEMPLATES[type]);
        if (requiresRequesterName) {
          state.forms[type].requesterName = preserveRequester ? (state.requesterName || '') : '';
        }
        if (type === 'supplies') {
          state.catalog.search = '';
          if (dom.supplies.catalogSearch) {
            dom.supplies.catalogSearch.value = '';
          }
        }
        renderForm(type);
        if (type === 'supplies' && state.catalog.items.length) {
          renderCatalog();
        }
        if (opts.skipPersistenceClear) {
          if (opts.persistImmediately) {
            persistForm(type, { immediate: true });
          }
        } else {
          clearPersistedForm(type);
        }
      }

      function renderForm(type) {
        const formState = state.forms[type];
        if (type === 'supplies') {
          dom.supplies.catalogSku.value = formState.catalogSku || '';
          dom.supplies.location.value = formState.location || '';
          dom.supplies.qty.value = formState.qty || 1;
          dom.supplies.description.value = formState.description || '';
          dom.supplies.notes.value = formState.notes || '';
          if (dom.supplies.plantCheck) {
            dom.supplies.plantCheck.checked = Boolean(formState.plantConfirmed);
          }
          if (dom.supplies.requesterName) {
            dom.supplies.requesterName.value = requiresRequesterName
              ? (formState.requesterName || state.requesterName || '')
              : '';
          }
        } else if (type === 'it') {
          dom.it.location.value = formState.location || '';
          dom.it.issue.value = formState.issue || '';
          dom.it.device.value = formState.device || '';
          const itUrgency = normalizeUrgency(formState.urgency) || 'normal';
          dom.it.urgency.value = itUrgency;
          state.forms.it.urgency = itUrgency;
          dom.it.details.value = formState.details || '';
          if (dom.it.requesterName) {
            dom.it.requesterName.value = requiresRequesterName
              ? (formState.requesterName || state.requesterName || '')
              : '';
          }
        } else if (type === 'maintenance') {
          dom.maintenance.location.value = formState.location || '';
          dom.maintenance.issue.value = formState.issue || '';
          const maintenanceUrgency = normalizeUrgency(formState.urgency) || 'normal';
          dom.maintenance.urgency.value = maintenanceUrgency;
          state.forms.maintenance.urgency = maintenanceUrgency;
          dom.maintenance.accessNotes.value = formState.accessNotes || '';
          if (dom.maintenance.requesterName) {
            dom.maintenance.requesterName.value = requiresRequesterName
              ? (formState.requesterName || state.requesterName || '')
              : '';
          }
        }
      }

      function loadRequests(type, { append }) {
        if (state.loading[type]) {
          return;
        }
        if (!server) {
          state.loaded[type] = true;
          renderRequests(type);
          return;
        }
        state.loading[type] = true;
        const moreButton = dom[type].more;
        if (moreButton) {
          moreButton.disabled = true;
        }
        toggleRequestsSkeleton(type, true);
        const payload = {
          cid: makeCid(),
          type,
          pageSize: 10,
          scope: 'all',
          nextToken: append ? state.nextTokens[type] : ''
        };
        server
          .withSuccessHandler(response => {
            state.loading[type] = false;
            state.loaded[type] = true;
            toggleRequestsSkeleton(type, false);
            if (!response || !response.ok) {
              handleError(response, 'listRequests', payload);
              return;
            }
            state.nextTokens[type] = response.nextToken || '';
            const items = Array.isArray(response.requests) ? response.requests : [];
            state.requests[type] = append ? state.requests[type].concat(items) : items;
            renderRequests(type);
          })
          .withFailureHandler(err => {
            state.loading[type] = false;
            state.loaded[type] = true;
            toggleRequestsSkeleton(type, false);
            handleError(err, 'listRequests', payload);
          })
          .listRequests(payload);
      }

      function renderRequests(type) {
        const list = dom[type].list;
        const moreButton = dom[type].more;
        list.textContent = '';
        if (!state.requests[type].length) {
          if (state.loading[type]) {
            list.appendChild(buildSkeletonBlock());
          } else {
            const empty = document.createElement('p');
            empty.className = 'empty';
            const message = EMPTY_REQUEST_MESSAGES[type];
            empty.textContent = hasServer ? message : 'Connect to Google Apps Script to load requests.';
            list.appendChild(empty);
          }
          if (moreButton) {
            moreButton.disabled = true;
          }
          return;
        }
        const fragment = document.createDocumentFragment();
        state.requests[type].forEach(request => {
          const item = document.createElement('article');
          item.className = 'request-item';
          item.dataset.requestType = type;
          item.dataset.requestId = request.id;

          const head = document.createElement('div');
          head.className = 'request-item-head';

          const title = document.createElement('strong');
          title.className = 'request-item-title';
          title.textContent = request.summary || 'Request';
          head.appendChild(title);

          if ((type === 'it' || type === 'maintenance') && request.fields) {
            const urgencyKey = normalizeUrgency(request.fields.urgency);
            if (urgencyKey) {
              const urgencyBadge = document.createElement('span');
              urgencyBadge.className = 'urgency-badge request-urgency';
              urgencyBadge.dataset.urgency = urgencyKey;
              urgencyBadge.textContent = formatUrgencyLabel(urgencyKey);
              head.appendChild(urgencyBadge);
            }
          }

          const status = document.createElement('span');
          status.className = 'status';
          const statusValue = String(request.status || '').toLowerCase();
          const stateKey = statusValue.replace(/\s+/g, '_');
          status.dataset.state = stateKey;
          status.textContent = formatStatus(stateKey);
          head.appendChild(status);
          item.appendChild(head);

          const info = document.createElement('div');
          info.className = 'request-item-info';

          const meta = document.createElement('span');
          meta.className = 'meta';
          meta.textContent = buildRequestMeta(request, type);
          info.appendChild(meta);

          if (Array.isArray(request.details)) {
            request.details.forEach(detail => {
              if (!detail) return;
              const line = document.createElement('span');
              line.className = 'detail-line';
              line.textContent = detail;
              info.appendChild(line);
            });
          }

          const submittedLine = document.createElement('span');
          submittedLine.className = 'detail-line';
          submittedLine.textContent = `Submitted by: ${request.requester || 'Unknown requester'}`;
          info.appendChild(submittedLine);

          const statusLineText = buildStatusActorLine(type, stateKey, request.approver);
          if (statusLineText) {
            const statusLine = document.createElement('span');
            statusLine.className = 'detail-line';
            statusLine.textContent = statusLineText;
            info.appendChild(statusLine);
          }

          item.appendChild(info);

          if (supportsNotes(type)) {
            const notesSection = buildRequestNotesSection(request, type);
            if (notesSection) {
              item.appendChild(notesSection);
            }
          }

          const footer = document.createElement('div');
          footer.className = 'request-item-footer';

          const showEtaField = type === 'supplies' && shouldShowEtaField(stateKey);

          if (showEtaField) {
            const etaWrapper = document.createElement('label');
            etaWrapper.className = 'eta-field';

            const etaText = document.createElement('span');
            etaText.textContent = 'ETA';
            etaWrapper.appendChild(etaText);

            const etaInput = document.createElement('input');
            etaInput.type = 'date';
            etaInput.autocomplete = 'off';
            const previousEta = getRequestEta(request);
            etaInput.value = previousEta;
            etaInput.setAttribute('aria-label', `ETA for ${request.summary || 'request'}`);
            const etaStatusAllowed = canEditEtaStatus(stateKey);
            const etaEditable = server && canManageStatuses && etaStatusAllowed;
            if (!etaEditable) {
              etaInput.disabled = true;
            }
            if (!canManageStatuses) {
              etaInput.title = 'Only authorized approvers can update ETA.';
            } else if (!etaStatusAllowed) {
              etaInput.title = 'ETA can be set after approval only.';
            } else {
              etaInput.title = '';
            }
            if (etaEditable) {
              etaInput.addEventListener('change', () => {
                const nextValue = etaInput.value;
                if (nextValue === previousEta) {
                  return;
                }
                handleUpdateEta(type, request, nextValue, etaInput, previousEta);
              });
            }
            etaWrapper.appendChild(etaInput);
            footer.appendChild(etaWrapper);
          }

          if (type === 'supplies' && canManageStatuses) {
            const buttonRow = document.createElement('div');
            buttonRow.className = 'inline-buttons';
            let hasButtons = false;

            if (stateKey === 'pending') {
              const approved = document.createElement('button');
              approved.type = 'button';
              approved.className = 'secondary';
              approved.textContent = 'Approved';
              approved.addEventListener('click', () => handleUpdateStatus(type, request.id, 'approved'));
              buttonRow.appendChild(approved);

              const denied = document.createElement('button');
              denied.type = 'button';
              denied.className = 'secondary';
              denied.textContent = 'Denied';
              denied.addEventListener('click', () => handleUpdateStatus(type, request.id, 'denied'));
              buttonRow.appendChild(denied);
              hasButtons = true;
            }

            if (hasButtons) {
              const controls = document.createElement('div');
              controls.className = 'supplies-actions';
              controls.appendChild(buttonRow);
              footer.appendChild(controls);
            }
          } else if (canManageStatuses && (stateKey === 'pending' || stateKey === 'in_progress')) {
            const actions = document.createElement('div');
            actions.className = 'inline-buttons';
            const complete = document.createElement('button');
            complete.type = 'button';
            complete.className = 'secondary';
            complete.textContent = 'Complete';
            complete.addEventListener('click', () => handleUpdateStatus(type, request.id, 'completed'));
            actions.appendChild(complete);

            const progress = document.createElement('button');
            progress.type = 'button';
            progress.className = 'secondary';
            progress.textContent = 'In Progress';
            progress.addEventListener('click', () => handleUpdateStatus(type, request.id, 'in_progress'));
            progress.classList.toggle('active', stateKey === 'in_progress');
            progress.setAttribute('aria-pressed', stateKey === 'in_progress' ? 'true' : 'false');
            actions.appendChild(progress);

            const denied = document.createElement('button');
            denied.type = 'button';
            denied.className = 'secondary';
            denied.textContent = 'Denied';
            denied.addEventListener('click', () => handleUpdateStatus(type, request.id, 'denied'));
            actions.appendChild(denied);

            footer.appendChild(actions);
          }

          if (footer.childElementCount) {
            item.appendChild(footer);
          }

          fragment.appendChild(item);
        });
        list.appendChild(fragment);
        if (moreButton) {
          moreButton.disabled = !state.nextTokens[type];
        }
      }

      function handleUpdateStatus(type, requestId, status) {
        if (!canManageStatuses) {
          showToast('You are not authorized to update requests.');
          return;
        }
        if (!server) {
          showToast('Connect to Google Apps Script to update statuses.');
          return;
        }
        const payload = {
          cid: makeCid(),
          clientRequestId: makeClientRequestId(type),
          type,
          requestId,
          status
        };
        const item = dom[type].list.querySelector(`article[data-request-id="${requestId}"]`);
        const interactive = item
          ? Array.from(item.querySelectorAll('button'))
          : [];
        interactive.forEach(element => { element.disabled = true; });
        server
          .withSuccessHandler(response => {
            interactive.forEach(element => { element.disabled = false; });
            if (!response || !response.ok || !response.request) {
              handleError(response, 'updateRequestStatus', payload);
              return;
            }
            const updated = response.request;
            const index = state.requests[type].findIndex(entry => entry.id === updated.id);
            if (index >= 0) {
              state.requests[type][index] = updated;
              renderRequests(type);
            }
            showToast('Request updated');
            requestDashboardRefresh(DASHBOARD_DEBOUNCE);
          })
          .withFailureHandler(err => {
            interactive.forEach(element => { element.disabled = false; });
            handleError(err, 'updateRequestStatus', payload);
          })
          .updateRequestStatus(payload);
      }

      function handleAddNote(type, request, textarea, submitButton) {
        if (!canManageStatuses) {
          showToast('You are not authorized to add notes.');
          return;
        }
        const currentValue = textarea.value || '';
        setNoteDraft(type, request.id, currentValue);
        const trimmed = currentValue.trim();
        if (!trimmed) {
          showToast('Add a note before submitting.');
          return;
        }
        if (!server) {
          showToast('Connect to Google Apps Script to add notes.');
          return;
        }
        const payload = {
          cid: makeCid(),
          clientRequestId: makeClientRequestId(type),
          type,
          requestId: request.id,
          note: trimmed
        };
        textarea.disabled = true;
        submitButton.disabled = true;
        server
          .withSuccessHandler(response => {
            textarea.disabled = false;
            submitButton.disabled = false;
            if (!response || !response.ok || !response.request) {
              handleError(response, 'addRequestNote', payload);
              return;
            }
            const updated = response.request;
            const index = state.requests[type].findIndex(entry => entry.id === updated.id);
            if (index >= 0) {
              state.requests[type][index] = updated;
            }
            clearNoteDraft(type, request.id);
            renderRequests(type);
            showToast('Note added');
          })
          .withFailureHandler(err => {
            textarea.disabled = false;
            submitButton.disabled = false;
            handleError(err, 'addRequestNote', payload);
          })
          .addRequestNote(payload);
      }

      function handleUpdateEta(type, request, etaValue, input, previousEta) {
        if (!canManageStatuses) {
          showToast('You are not authorized to update requests.');
          input.value = previousEta;
          return;
        }
        if (!server) {
          showToast('Connect to Google Apps Script to update ETA dates.');
          input.value = previousEta;
          return;
        }
        if (!request || !request.id) {
          input.value = previousEta;
          handleError({ message: 'Request not found.' }, 'updateRequestEta');
          return;
        }
        if (!canEditEtaStatus(request && request.status)) {
          input.value = previousEta;
          showToast('ETA can be set after approval only.');
          return;
        }
        const payload = {
          cid: makeCid(),
          clientRequestId: makeClientRequestId(type),
          type,
          requestId: request.id,
          status: request.status || 'pending',
          eta: etaValue
        };
        input.disabled = true;
        server
          .withSuccessHandler(response => {
            input.disabled = false;
            if (!response || !response.ok || !response.request) {
              input.value = previousEta;
              handleError(response, 'updateRequestEta', payload);
              return;
            }
            const updated = response.request;
            const index = state.requests[type].findIndex(entry => entry.id === updated.id);
            if (index >= 0) {
              state.requests[type][index] = updated;
              renderRequests(type);
            }
            const updatedEta = getRequestEta(updated);
            showToast(updatedEta ? 'ETA updated' : 'ETA cleared');
            requestDashboardRefresh(DASHBOARD_DEBOUNCE);
          })
          .withFailureHandler(err => {
            input.disabled = false;
            input.value = previousEta;
            handleError(err, 'updateRequestEta', payload);
          })
          .updateRequestStatus(payload);
      }

      function shouldShowEtaField(status) {
        const key = typeof status === 'string'
          ? status.trim().toLowerCase().replace(/\s+/g, '_')
          : '';
        return !HIDE_ETA_STATUSES.has(key);
      }

      function canEditEtaStatus(status) {
        const key = typeof status === 'string'
          ? status.trim().toLowerCase().replace(/\s+/g, '_')
          : '';
        return key === 'approved' || key === 'ordered' || key === 'completed';
      }

      function buildRequestMeta(request, type) {
        const parts = [];
        if (request.ts) {
          try {
            parts.push(new Date(request.ts).toLocaleString());
          } catch (err) {
            parts.push(request.ts);
          }
        }
        const scopeType = typeof type === 'string' ? type : '';
        if (scopeType !== 'supplies' && request.requester) {
          parts.push(request.requester);
        }
        return parts.join(' • ');
      }

      function normalizeUrgency(value) {
        const text = typeof value === 'string' ? value.trim().toLowerCase() : '';
        if (!text) {
          return '';
        }
        if (text === 'high') {
          return 'critical';
        }
        if (text === 'medium') {
          return 'normal';
        }
        return text === 'low' || text === 'normal' || text === 'critical' ? text : '';
      }

      function formatUrgencyLabel(value) {
        switch (value) {
          case 'low':
            return 'Low';
          case 'critical':
            return 'Critical';
          case 'normal':
          default:
            return 'Normal';
        }
      }

      function getRequestEta(request) {
        if (!request || !request.fields) {
          return '';
        }
        return String(request.fields.eta || '');
      }

      function loadCatalog({ append, fetchAll }) {
        if (state.catalog.loading || !server) {
          if (!server) {
            state.catalog.loading = false;
            renderCatalog();
          }
          return;
        }
        state.catalog.loading = true;
        if (fetchAll) {
          state.catalog.fullyLoaded = false;
        }
        dom.supplies.catalogMore.disabled = true;
        toggleCatalogSkeleton(true);
        updateCatalogControls();
        const payload = {
          cid: makeCid()
        };
        if (fetchAll) {
          payload.fetchAll = true;
        } else {
          payload.pageSize = 20;
          payload.nextToken = append ? state.catalog.nextToken : '';
        }
        server
          .withSuccessHandler(response => {
            state.catalog.loading = false;
            toggleCatalogSkeleton(false);
            if (!response || !response.ok) {
              handleError(response, 'listCatalog', payload);
              return;
            }
            state.catalog.nextToken = response.nextToken || '';
            const items = Array.isArray(response.items) ? response.items : [];
            state.catalog.items = append && !fetchAll ? state.catalog.items.concat(items) : items;
            state.catalog.fullyLoaded = fetchAll || !state.catalog.nextToken;
            renderCatalog();
            updateCatalogControls();
          })
          .withFailureHandler(err => {
            state.catalog.loading = false;
            toggleCatalogSkeleton(false);
            handleError(err, 'listCatalog', payload);
            updateCatalogControls();
          })
          .listCatalog(payload);
      }

      function renderCatalog() {
        dom.supplies.catalogList.textContent = '';
        if (dom.supplies.catalogOptions) {
          dom.supplies.catalogOptions.textContent = '';
        }
        let selectedSku = state.forms.supplies.catalogSku || '';
        const searchValue = state.catalog.search || '';
        dom.supplies.catalogSearch.value = searchValue;
        updateCatalogSearchAffordances();
        updateCatalogControls();

        if (!state.catalog.items.length) {
          dom.supplies.catalogSearch.disabled = !state.catalog.loading;
          if (state.catalog.loading) {
            dom.supplies.catalogList.appendChild(buildSkeletonBlock());
          } else {
            const empty = document.createElement('p');
            empty.className = 'empty';
            empty.textContent = hasServer ? 'No catalog items found.' : 'Catalog requires Google Apps Script.';
            dom.supplies.catalogList.appendChild(empty);
          }
          return;
        }

        dom.supplies.catalogSearch.disabled = false;

        const descriptionValue = (state.forms.supplies.description || '').trim();
        if (!selectedSku && descriptionValue) {
          const match = state.catalog.items.find(item => item.description.toLowerCase() === descriptionValue.toLowerCase());
          if (match) {
            selectCatalogSku(match.sku, { updateSearch: false });
            selectedSku = match.sku;
          }
        }

        dom.supplies.catalogSku.value = selectedSku;

        const normalizedSearch = searchValue.trim().toLowerCase();
        let filteredItems = state.catalog.items.slice();
        if (normalizedSearch) {
          filteredItems = state.catalog.items.filter(item => {
            const displayCost = formatCurrencyDisplay(item.estimatedCost);
            const haystack = `${item.description} ${item.category} ${item.sku} ${item.supplier || ''} ${item.estimatedCost || ''} ${displayCost}`.toLowerCase();
            return haystack.indexOf(normalizedSearch) !== -1;
          });
          const skuToHighlight = state.forms.supplies.catalogSku || '';
          if (skuToHighlight && !filteredItems.some(item => item.sku === skuToHighlight)) {
            const selectedItem = findCatalogItem(skuToHighlight);
            if (selectedItem) {
              filteredItems.unshift(selectedItem);
            }
          }
        }

        if (!filteredItems.length) {
          const empty = document.createElement('p');
          empty.className = 'empty';
          if (normalizedSearch) {
            empty.textContent = state.catalog.loading && !state.catalog.fullyLoaded
              ? 'Loading more catalog items to finish your search…'
              : 'No catalog items match your search. Try another keyword.';
          } else {
            empty.textContent = hasServer ? 'No catalog items found.' : 'Catalog requires Google Apps Script.';
          }
          dom.supplies.catalogList.appendChild(empty);
          return;
        }

        const popularItems = state.catalog.items.filter(item => Number(item.usageCount) > 0);
        const topRank = Math.min(5, popularItems.length);
        const topSkuSet = new Set(popularItems.slice(0, topRank).map(item => item.sku));

        if (dom.supplies.catalogOptions) {
          const datalistFragment = document.createDocumentFragment();
          const limit = 25;
          const datalistItems = filteredItems.slice(0, limit);
          if (selectedSku) {
            const selectedItem = findCatalogItem(selectedSku);
            if (selectedItem && !datalistItems.some(entry => entry.sku === selectedSku)) {
              datalistItems.unshift(selectedItem);
            }
          }
          datalistItems.slice(0, limit).forEach(item => {
            const option = document.createElement('option');
            option.value = formatCatalogOptionValue(item, topSkuSet.has(item.sku));
            option.dataset.sku = item.sku;
            option.dataset.description = item.description;
            option.dataset.category = item.category || '';
            datalistFragment.appendChild(option);
          });
          dom.supplies.catalogOptions.appendChild(datalistFragment);
        }

        const fragment = document.createDocumentFragment();
        filteredItems.forEach(item => {
          const card = document.createElement('article');
          card.className = 'catalog-item';
          if (item.sku === selectedSku) {
            card.classList.add('selected');
          }
          card.tabIndex = 0;
          card.setAttribute('role', 'listitem');

          const costDisplay = formatCurrencyDisplay(item.estimatedCost);

          const head = document.createElement('div');
          head.className = 'catalog-item-head';

          const name = document.createElement('strong');
          name.className = 'catalog-item-title';
          name.textContent = item.description;
          head.appendChild(name);

          const skuLabel = document.createElement('span');
          skuLabel.className = 'catalog-item-sku';
          skuLabel.textContent = item.sku || 'SKU pending';
          head.appendChild(skuLabel);

          card.appendChild(head);

          if (topSkuSet.has(item.sku) && Number(item.usageCount) > 0) {
            const badge = document.createElement('span');
            badge.className = 'catalog-badge';
            badge.textContent = 'Most requested';
            card.appendChild(badge);
          }

          const info = document.createElement('div');
          info.className = 'catalog-item-info';

          if (item.category) {
            const category = document.createElement('span');
            category.className = 'meta';
            category.textContent = `Category: ${item.category}`;
            info.appendChild(category);
          }

          if (item.supplier) {
            const supplier = document.createElement('span');
            supplier.className = 'detail-line';
            supplier.textContent = `Supplier: ${item.supplier}`;
            info.appendChild(supplier);
          }

          if (costDisplay) {
            const cost = document.createElement('span');
            cost.className = 'detail-line';
            cost.textContent = `Estimated cost: ${costDisplay}`;
            info.appendChild(cost);
          }

          if (Number(item.usageCount) > 0) {
            const usage = document.createElement('span');
            usage.className = 'detail-line usage';
            usage.textContent = item.usageCount === 1 ? 'Requested 1 time' : `Requested ${item.usageCount} times`;
            info.appendChild(usage);
          }

          card.appendChild(info);
          const handleSelect = () => {
            selectCatalogSku(item.sku);
            renderCatalog();
          };
          card.addEventListener('click', () => {
            handleSelect();
          });
          card.addEventListener('keydown', evt => {
            if (evt.key === 'Enter' || evt.key === ' ') {
              evt.preventDefault();
              handleSelect();
            }
          });
          fragment.appendChild(card);
        });
        dom.supplies.catalogList.appendChild(fragment);
        if (state.catalog.loading && !state.catalog.fullyLoaded) {
          const loading = document.createElement('p');
          loading.className = 'meta';
          loading.textContent = 'Loading remaining catalog items…';
          dom.supplies.catalogList.appendChild(loading);
        }
      }

      function updateCatalogSearchAffordances() {
        if (!dom.supplies.catalogClear) {
          return;
        }
        const hasValue = Boolean(dom.supplies.catalogSearch.value);
        const hasSelection = Boolean(dom.supplies.catalogSku.value);
        dom.supplies.catalogClear.classList.toggle('visible', hasValue || hasSelection);
      }

      function selectCatalogSku(sku, options) {
        const opts = options || {};
        const item = sku ? findCatalogItem(sku) : null;
        const shouldUpdateSearch = opts.updateSearch !== false;
        const searchValue = 'searchValue' in opts
          ? opts.searchValue
          : item
            ? formatCatalogOptionValue(item, false)
            : '';
        if (shouldUpdateSearch) {
          state.catalog.search = searchValue;
          dom.supplies.catalogSearch.value = searchValue;
        }
        const preserveDescription = Boolean(opts.preserveDescription);
        const nextDescription = item && !preserveDescription ? item.description : dom.supplies.description.value;
        if (item && !preserveDescription) {
          syncingCatalogToDescription = true;
          dom.supplies.description.value = item.description;
          syncingCatalogToDescription = false;
        }
        dom.supplies.catalogSku.value = sku || '';
        setFormState('supplies', { catalogSku: sku || '', description: nextDescription });
        updateCatalogSearchAffordances();
        if (opts.persist !== false) {
          persistForm('supplies');
        }
      }

      function formatCurrencyDisplay(value, decimalsHint) {
        const text = value === undefined || value === null ? '' : String(value).trim();
        if (!text) {
          return '';
        }
        const numericPart = text.replace(/[^0-9.,-]/g, '');
        if (!numericPart) {
          if (/^\$/i.test(text)) {
            return text;
          }
          if (/[A-Za-z]/.test(text) || /[^0-9.,\s-]/.test(text)) {
            return text;
          }
          return `$${text}`;
        }
        const normalized = numericPart.replace(/,/g, '');
        const amount = Number(normalized);
        if (!Number.isFinite(amount)) {
          if (/^\$/i.test(text)) {
            return text;
          }
          return `$${text}`;
        }
        const decimalMatch = normalized.match(/\.(\d+)/);
        const decimalsRaw = decimalMatch ? decimalMatch[1].length : 0;
        const safeDecimals = decimalsRaw > 0
          ? Math.min(decimalsRaw, 4)
          : (typeof decimalsHint === 'number' && decimalsHint >= 0 ? decimalsHint : 2);
        let formatted;
        try {
          formatted = amount.toLocaleString('en-US', {
            minimumFractionDigits: safeDecimals,
            maximumFractionDigits: safeDecimals
          });
        } catch (err) {
          formatted = amount.toFixed(safeDecimals);
        }
        const prefixMatch = text.match(/^[^0-9-]*/);
        const prefix = prefixMatch ? prefixMatch[0] : '';
        const suffixMatch = text.match(/[^0-9.,-]*$/);
        const suffix = suffixMatch ? suffixMatch[0] : '';
        const labelPrefix = prefix || '$';
        const labelSuffix = suffix || '';
        return `${labelPrefix}${formatted}${labelSuffix}`.trim();
      }

      function formatCatalogOptionValue(item, highlight) {
        if (!item) {
          return '';
        }
        const prefix = highlight ? '★ ' : '';
        const categoryLabel = item.category ? ` · ${item.category}` : '';
        const supplierLabel = item.supplier ? ` · ${item.supplier}` : '';
        const costDisplay = formatCurrencyDisplay(item.estimatedCost);
        const costLabel = costDisplay ? ` (${costDisplay})` : '';
        return `${prefix}${item.description}${categoryLabel}${supplierLabel} — ${item.sku}${costLabel}`;
      }

      function findCatalogOption(value) {
        if (!dom.supplies.catalogOptions) {
          return null;
        }
        const options = Array.from(dom.supplies.catalogOptions.querySelectorAll('option'));
        return options.find(option => option.value === value) || null;
      }
      function findCatalogItem(sku) {
        if (!sku) {
          return null;
        }
        const item = state.catalog.items.find(entry => entry.sku === sku);
        return item || null;
      }

      function ensureFullCatalogLoaded() {
        if (!hasServer) {
          return;
        }
        if (state.catalog.fullyLoaded || state.catalog.loading) {
          return;
        }
        loadCatalog({ append: false, fetchAll: true });
      }

      function updateCatalogControls() {
        const button = dom.supplies.catalogMore;
        if (!button) {
          return;
        }
        if (!hasServer) {
          button.hidden = true;
          return;
        }
        button.hidden = false;
        if (state.catalog.loading) {
          button.disabled = true;
          button.textContent = state.catalog.fullyLoaded ? 'Refreshing…' : 'Loading all items…';
          return;
        }
        if (state.catalog.fullyLoaded) {
          button.disabled = false;
          button.textContent = 'Refresh catalog';
        } else {
          button.disabled = false;
          button.textContent = 'Load all items';
        }
      }

      function setFormState(type, partial) {
        state.forms[type] = Object.assign({}, state.forms[type], partial);
      }

      function handleRequesterNameInput(type) {
        if (!requiresRequesterName) {
          return;
        }
        const input = dom[type] && dom[type].requesterName;
        if (!input) {
          return;
        }
        setRequesterName(input.value || '', { sourceType: type });
      }

      function setRequesterName(value, options) {
        const sourceType = options && options.sourceType;
        const skipPersist = Boolean(options && options.skipPersist);
        const text = typeof value === 'string' ? value : '';
        state.requesterName = text;
        REQUEST_KEYS.forEach(type => {
          state.forms[type] = Object.assign({}, state.forms[type], { requesterName: text });
          const input = dom[type] && dom[type].requesterName;
          if (input) {
            if (!requiresRequesterName) {
              input.value = '';
            } else if (type !== sourceType || document.activeElement !== input) {
              input.value = text;
            }
          }
          if (!skipPersist) {
            persistForm(type);
          }
        });
      }

      function initializeRequesterName() {
        if (!requiresRequesterName) {
          setRequesterName('', { skipPersist: true });
          return;
        }
        const cached = REQUEST_KEYS
          .map(type => state.forms[type] && state.forms[type].requesterName ? String(state.forms[type].requesterName) : '')
          .find(name => typeof name === 'string' && name.trim());
        if (cached) {
          setRequesterName(cached, { skipPersist: true });
        } else {
          setRequesterName('', { skipPersist: true });
        }
      }

      function configureRequesterNameRequirement() {
        if (!requiresRequesterName) {
          state.requesterName = '';
        }
        REQUEST_KEYS.forEach(type => {
          const wrapper = dom[type] && dom[type].requesterNameRow;
          const input = dom[type] && dom[type].requesterName;
          if (!wrapper || !input) {
            return;
          }
          if (requiresRequesterName) {
            wrapper.hidden = false;
            input.required = true;
            input.disabled = false;
          } else {
            wrapper.hidden = true;
            input.required = false;
            input.disabled = true;
            input.value = '';
          }
        });
      }

      function sanitizeDeviceId(value) {
        return typeof value === 'string' ? value.replace(/[^0-9A-Za-z_-]/g, '').slice(0, 80) : '';
      }

      function generateDeviceId() {
        try {
          if (window.crypto && typeof window.crypto.getRandomValues === 'function') {
            const buffer = new Uint8Array(16);
            window.crypto.getRandomValues(buffer);
            return Array.from(buffer, byte => byte.toString(16).padStart(2, '0')).join('');
          }
        } catch (err) {
          // ignore crypto errors
        }
        return `dev-${Math.random().toString(36).slice(2, 10)}${Date.now().toString(36)}`;
      }

      function ensureDeviceId() {
        if (state.deviceId) {
          return state.deviceId;
        }
        let stored = '';
        try {
          stored = localStorage.getItem(DEVICE_STORAGE_KEY) || '';
        } catch (err) {
          stored = '';
        }
        let deviceId = sanitizeDeviceId(stored);
        if (!deviceId) {
          deviceId = sanitizeDeviceId(generateDeviceId());
          if (!deviceId) {
            return '';
          }
          try {
            localStorage.setItem(DEVICE_STORAGE_KEY, deviceId);
          } catch (err) {
            // ignore storage errors
          }
        }
        state.deviceId = deviceId;
        return deviceId;
      }

      function persistForm(type, options) {
        const immediate = options && options.immediate;
        if (immediate) {
          flushPersist(type);
          return;
        }
        clearTimeout(persistTimers[type]);
        persistTimers[type] = setTimeout(() => {
          flushPersist(type);
        }, PERSIST_DELAY);
      }

      function flushPersist(type) {
        try {
          localStorage.setItem(LOCAL_KEYS[type], JSON.stringify(state.forms[type]));
        } catch (err) {
          // ignore storage errors
        }
      }

      function clearPersistedForm(type) {
        if (persistTimers[type]) {
          clearTimeout(persistTimers[type]);
          persistTimers[type] = null;
        }
        try {
          localStorage.removeItem(LOCAL_KEYS[type]);
        } catch (err) {
          // ignore storage errors
        }
      }

      function flushAllPersists() {
        REQUEST_KEYS.forEach(type => {
          if (persistTimers[type]) {
            clearTimeout(persistTimers[type]);
            persistTimers[type] = null;
          }
          flushPersist(type);
        });
      }

      function hydrateFormFromCache(type) {
        try {
          const raw = localStorage.getItem(LOCAL_KEYS[type]);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === 'object') {
              state.forms[type] = Object.assign({}, FORM_TEMPLATES[type], parsed);
              if (type === 'it') {
                const form = state.forms[type];
                if ((!form.urgency || form.urgency === undefined) && form.impact) {
                  form.urgency = form.impact;
                }
                delete form.impact;
                form.urgency = normalizeUrgency(form.urgency) || 'normal';
              } else if (type === 'maintenance') {
                state.forms[type].urgency = normalizeUrgency(state.forms[type].urgency) || 'normal';
              }
            }
          }
        } catch (err) {
          // ignore cache issues
        }
      }

      window.addEventListener('beforeunload', () => {
        stopDashboardAutoRefresh();
        flushAllPersists();
      });
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          flushAllPersists();
          stopDashboardAutoRefresh();
        } else if (document.visibilityState === 'visible') {
          if (hasServer) {
            requestDashboardRefresh(0);
            startDashboardAutoRefresh();
          }
        }
      });

      function toggleRequestsSkeleton(type, active) {
        if (!active || state.requests[type].length) {
          return;
        }
        const list = dom[type].list;
        list.textContent = '';
        list.appendChild(buildSkeletonBlock());
        const moreButton = dom[type].more;
        if (moreButton) {
          moreButton.disabled = true;
        }
      }

      function toggleCatalogSkeleton(active) {
        if (!active || state.catalog.items.length) {
          return;
        }
        dom.supplies.catalogList.textContent = '';
        dom.supplies.catalogList.appendChild(buildSkeletonBlock());
        dom.supplies.catalogMore.disabled = true;
      }

      function buildSkeletonBlock() {
        const wrapper = document.createElement('div');
        wrapper.className = 'request-item';
        const title = document.createElement('div');
        title.className = 'skeleton';
        title.style.height = '20px';
        wrapper.appendChild(title);
        const line = document.createElement('div');
        line.className = 'skeleton sm';
        wrapper.appendChild(line);
        return wrapper;
      }

      function formatStatus(status) {
        switch (status) {
          case 'completed':
            return 'Completed';
          case 'in_progress':
            return 'In progress';
          case 'ordered':
            return 'Ordered';
          case 'approved':
            return 'Approved';
          case 'denied':
            return 'Denied';
          case 'declined':
            return 'Declined';
          default:
            return 'Pending review';
        }
      }

      function supportsNotes(type) {
        return NOTE_SUPPORTED_TYPES.has(type);
      }

      function getNoteDraft(type, requestId) {
        if (!supportsNotes(type)) {
          return '';
        }
        const drafts = state.noteDrafts[type];
        if (!drafts) {
          return '';
        }
        return drafts[requestId] || '';
      }

      function setNoteDraft(type, requestId, value) {
        if (!supportsNotes(type)) {
          return;
        }
        if (!state.noteDrafts[type]) {
          state.noteDrafts[type] = {};
        }
        state.noteDrafts[type][requestId] = value;
      }

      function clearNoteDraft(type, requestId) {
        if (!supportsNotes(type)) {
          return;
        }
        const drafts = state.noteDrafts[type];
        if (drafts && Object.prototype.hasOwnProperty.call(drafts, requestId)) {
          delete drafts[requestId];
        }
      }

      function formatNoteTimestamp(ts) {
        if (!ts) {
          return 'Unknown time';
        }
        const parsed = new Date(ts);
        if (!isNaN(parsed.getTime())) {
          return parsed.toLocaleString();
        }
        return ts;
      }

      function buildStatusActorLine(type, statusKey, approver) {
        const actorName = approver ? approver : 'Not recorded';
        switch (statusKey) {
          case 'denied':
          case 'declined':
            return `Denied by: ${actorName}`;
          case 'approved':
            return `Approved by: ${actorName}`;
          case 'ordered':
            return `Ordered by: ${actorName}`;
          case 'completed':
            return `Completed by: ${actorName}`;
          case 'in_progress':
            return `In progress by: ${actorName}`;
          case 'pending':
            return type === 'supplies' ? 'Approval decision pending' : 'Update pending';
          default:
            return `Status: ${formatStatus(statusKey)}${approver ? ` by ${actorName}` : ''}`;
        }
      }

      function buildRequestNotesSection(request, type) {
        const notes = Array.isArray(request.notes) ? request.notes : [];
        const wrapper = document.createElement('section');
        wrapper.className = 'request-notes';

        const header = document.createElement('div');
        header.className = 'request-notes-header';

        const title = document.createElement('span');
        title.className = 'request-notes-title';
        title.textContent = 'Notes';
        header.appendChild(title);

        const count = document.createElement('span');
        count.className = 'request-notes-count';
        if (notes.length) {
          count.textContent = `${notes.length} ${notes.length === 1 ? 'note' : 'notes'}`;
        } else {
          count.textContent = 'No notes yet';
        }
        header.appendChild(count);

        wrapper.appendChild(header);

        const list = document.createElement('div');
        list.className = 'request-notes-list';
        if (notes.length) {
          const [latestNote, ...otherNotes] = notes;
          const latestEntry = buildRequestNoteEntry(latestNote);
          latestEntry.classList.add('request-note-latest');
          list.appendChild(latestEntry);

          if (otherNotes.length) {
            const archive = document.createElement('details');
            archive.className = 'request-notes-archive';

            const summary = document.createElement('summary');
            summary.className = 'request-notes-toggle';
            const summaryLabel = document.createElement('span');
            const additionalLabel = otherNotes.length === 1 ? 'Show 1 more note' : `Show ${otherNotes.length} more notes`;
            const collapseLabel = 'Hide additional notes';
            summaryLabel.textContent = additionalLabel;
            summary.appendChild(summaryLabel);
            archive.appendChild(summary);

            const restContainer = document.createElement('div');
            restContainer.className = 'request-notes-collapsed';

            otherNotes.forEach(note => {
              const entry = buildRequestNoteEntry(note);
              restContainer.appendChild(entry);
            });

            archive.appendChild(restContainer);

            archive.addEventListener('toggle', () => {
              summaryLabel.textContent = archive.open ? collapseLabel : additionalLabel;
            });

            list.appendChild(archive);
          }
        }

        if (!notes.length) {
          const empty = document.createElement('p');
          empty.className = 'request-notes-empty';
          empty.textContent = 'No notes yet.';
          list.appendChild(empty);
        }

        wrapper.appendChild(list);

        if (canManageStatuses) {
          const form = document.createElement('form');
          form.className = 'request-note-form';
          form.noValidate = true;

          const textarea = document.createElement('textarea');
          textarea.placeholder = 'Add a note for this request…';
          textarea.value = getNoteDraft(type, request.id);
          textarea.addEventListener('input', () => {
            setNoteDraft(type, request.id, textarea.value);
          });
          if (!server) {
            textarea.disabled = true;
          }
          form.appendChild(textarea);

          if (!server) {
            const helper = document.createElement('p');
            helper.className = 'request-note-helper';
            helper.textContent = 'Connect to Google Apps Script to add notes.';
            form.appendChild(helper);
          }

          const actions = document.createElement('div');
          actions.className = 'request-note-actions';

          const submit = document.createElement('button');
          submit.type = 'submit';
          submit.className = 'secondary';
          submit.textContent = 'Add note';
          if (!server) {
            submit.disabled = true;
          }
          actions.appendChild(submit);
          form.appendChild(actions);

          form.addEventListener('submit', event => {
            event.preventDefault();
            handleAddNote(type, request, textarea, submit);
          });

          wrapper.appendChild(form);
        }

        return wrapper;
      }

      function buildRequestNoteEntry(note) {
        const entry = document.createElement('article');
        entry.className = 'request-note';

        const meta = document.createElement('div');
        meta.className = 'request-note-meta';

        const actorText = typeof note.actor === 'string' ? note.actor.trim() : '';
        if (actorText) {
          const actor = document.createElement('span');
          actor.textContent = actorText;
          meta.appendChild(actor);
        }

        const timestampRaw = typeof note.ts === 'string' ? note.ts : '';
        const timestampLabel = timestampRaw ? formatNoteTimestamp(timestampRaw) : '';
        if (timestampLabel) {
          if (meta.childElementCount) {
            meta.appendChild(makeMetaDot());
          }
          const time = document.createElement('time');
          time.className = 'request-note-ts';
          time.dateTime = timestampRaw;
          time.textContent = timestampLabel;
          meta.appendChild(time);
        }

        if (!meta.childElementCount) {
          meta.textContent = 'Note';
        }

        entry.appendChild(meta);

        const bodyText = typeof note.note === 'string' ? note.note : '';
        if (bodyText) {
          const body = document.createElement('p');
          body.className = 'request-note-body';
          body.textContent = bodyText;
          entry.appendChild(body);
        }

        return entry;
      }

      function makeMetaDot() {
        const dot = document.createElement('span');
        dot.className = 'request-note-dot';
        dot.textContent = '•';
        dot.setAttribute('aria-hidden', 'true');
        return dot;
      }

      function disableForm(type, disabled) {
        if (type === 'supplies') {
          dom.supplies.submit.disabled = disabled;
          dom.supplies.location.disabled = disabled;
          dom.supplies.qty.disabled = disabled;
          dom.supplies.notes.disabled = disabled;
          dom.supplies.catalogSearch.disabled = disabled;
          dom.supplies.reset.disabled = disabled;
          if (dom.supplies.requesterName && requiresRequesterName) {
            dom.supplies.requesterName.disabled = disabled;
          }
        } else if (type === 'it') {
          dom.it.submit.disabled = disabled;
          dom.it.location.disabled = disabled;
          dom.it.issue.disabled = disabled;
          dom.it.device.disabled = disabled;
          dom.it.urgency.disabled = disabled;
          dom.it.details.disabled = disabled;
          dom.it.reset.disabled = disabled;
          if (dom.it.requesterName && requiresRequesterName) {
            dom.it.requesterName.disabled = disabled;
          }
        } else if (type === 'maintenance') {
          dom.maintenance.submit.disabled = disabled;
          dom.maintenance.location.disabled = disabled;
          dom.maintenance.issue.disabled = disabled;
          dom.maintenance.urgency.disabled = disabled;
          dom.maintenance.accessNotes.disabled = disabled;
          dom.maintenance.reset.disabled = disabled;
          if (dom.maintenance.requesterName && requiresRequesterName) {
            dom.maintenance.requesterName.disabled = disabled;
          }
        }
      }

      function showToast(message) {
        dom.toast.textContent = message;
        dom.toast.style.display = 'block';
        clearTimeout(showToast.timer);
        showToast.timer = setTimeout(() => {
          dom.toast.style.display = 'none';
        }, 2800);
      }

      function resolveErrorMessage(err) {
        if (!err) {
          return 'Something went wrong. Please try again.';
        }
        if (typeof err === 'string') {
          return err;
        }
        if (typeof err.message === 'string' && err.message.trim()) {
          return err.message.trim();
        }
        if (typeof err.statusText === 'string' && err.statusText.trim()) {
          return err.statusText.trim();
        }
        if (typeof err.details === 'string' && err.details.trim()) {
          return err.details.trim();
        }
        if (Array.isArray(err.details) && err.details.length) {
          const firstDetail = err.details.find(detail => typeof detail === 'string' && detail.trim());
          if (firstDetail) {
            return firstDetail.trim();
          }
        }
        if (Array.isArray(err.errors) && err.errors.length) {
          const firstError = err.errors.find(detail => typeof detail === 'string' && detail.trim());
          if (firstError) {
            return firstError.trim();
          }
        }
        if (typeof err.error === 'string' && err.error.trim()) {
          return err.error.trim();
        }
        return 'Something went wrong. Please try again.';
      }

      function handleError(err, context, payload) {
        const message = resolveErrorMessage(err);
        console.error('[RequestManager]', context, message, err);
        showToast(message);
        if (!server) {
          return;
        }
        try {
          server
            .withFailureHandler(() => { })
            .logClientError({
              cid: makeCid(),
              context,
              message,
              stack: err && err.stack ? String(err.stack) : '',
              payload
            });
        } catch (loggingError) {
          // ignore logging issues
        }
      }

      function makeCid() {
        return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 8)}`;
      }

      function makeClientRequestId(type) {
        return `${initialSessionEmail || 'user'}-${type}-${makeCid()}`;
      }
    })();
  </script>

  <script>
    (function() {
      function sanitizeText(value) {
        if (typeof value !== 'string') {
          return '';
        }
        return value.trim();
      }

      function parseQty(value) {
        const num = Number(value);
        if (!Number.isFinite(num) || num < 1) {
          return 0;
        }
        return Math.floor(num);
      }

      const DATE_TIME_OPTIONS = Object.freeze({
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
      });

      function validatePayload(payload) {
        const fields = {
          description: '',
          qty: '',
          location: '',
          notes: ''
        };
        const value = {
          description: sanitizeText(payload && payload.description),
          qty: parseQty(payload && payload.qty),
          location: sanitizeText(payload && payload.location),
          notes: sanitizeText(payload && payload.notes)
        };
        if (!value.description) {
          fields.description = 'Describe what you need.';
        }
        if (!value.qty) {
          fields.qty = 'Quantity must be at least 1.';
        }
        const valid = !fields.description && !fields.qty;
        return { valid, fields, value };
      }

      function buildClientRequestId() {
        const buffer = new Uint32Array(4);
        if (window.crypto && typeof window.crypto.getRandomValues === 'function') {
          window.crypto.getRandomValues(buffer);
          return Array.from(buffer).map(num => num.toString(16).padStart(8, '0')).join('');
        }
        return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2)}`;
      }

      function formatDate(value) {
        if (!value) {
          return '';
        }
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
          return String(value);
        }
        try {
          return date.toLocaleString(undefined, DATE_TIME_OPTIONS);
        } catch (err) {
          return date.toLocaleString();
        }
      }

      window.RequestsAppHelpers = {
        sanitizeText,
        parseQty,
        validatePayload,
        buildClientRequestId,
        formatDate
      };
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Supplies Tracker</title>
  <style>
    body{font-family:Arial,sans-serif;margin:0;padding:0;}
    header{display:flex;align-items:center;justify-content:space-between;padding:0.5rem;background:#1a73e8;color:#fff;}
    header h1{font-size:1.25rem;margin:0;}
    nav{display:flex;gap:0.5rem;padding:0.5rem;background:#f5f5f5;flex-wrap:wrap;}
    nav button{flex:1 1 auto;}
    .btn{background:#1a73e8;color:#fff;border:none;border-radius:4px;padding:0.5rem 1rem;}
    .btn:disabled{background:#9e9e9e;}
    .hidden{display:none;}
    .input{padding:0.5rem;border:1px solid #ccc;border-radius:4px;}
    table{width:100%;border-collapse:collapse;margin-top:0.5rem;}
    th,td{padding:0.5rem;border-bottom:1px solid #ddd;}
    .stripe-odd{background:#fff;}
    .stripe-even{background:#f2f2f2;}
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;}
    .modal-content{background:#fff;padding:1rem;border-radius:4px;max-height:90%;overflow:auto;}
  </style>
</head>
<body>
  <header>
    <h1>Supplies Order & Tracking</h1>
    <button id="manageBtn" class="btn hidden">Manage Access</button>
  </header>

  <div id="loginPrompt" class="p-2 hidden">
    <p>Please log into your Google account, then refresh.</p>
    <button id="loginBtn" class="btn">Reload</button>
  </div>

  <nav id="nav" class="hidden">
    <button class="btn" data-view="request" id="navReq">Request</button>
    <button class="btn" data-view="my" id="navMy">My Requests</button>
    <button class="btn" data-view="approvals" id="navAppr">Approvals</button>
    <button class="btn" data-view="catalog" id="navCat">Catalog</button>
    <button class="btn" data-view="dev" id="navDev">Developer Console</button>
  </nav>

  <main id="main" class="p-2"></main>

  <div id="userModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="userModalTitle">
    <div class="modal-content">
      <h2 id="userModalTitle">Manage Access</h2>
      <table><thead><tr><th>Email</th><th>Role</th><th>Active</th><th>Actions</th></tr></thead><tbody id="userTable"></tbody></table>
      <div id="addRow" style="margin-top:0.5rem;">
        <input id="newEmail" class="input" placeholder="email">
        <select id="newRole" class="input"></select>
        <button id="addUserBtn" class="btn">Add</button>
        <button id="closeModal" class="btn">Close</button>
      </div>
    </div>
  </div>

  <script type="module">
    const BOOTSTRAP = <?!= JSON.stringify(BOOTSTRAP) ?>;
    const { email, role, isLoggedIn, devConsoleAllowed, csrf } = BOOTSTRAP;
    const webAppUrl = window.location.href;
    const ALL_ROLES = ['viewer','requester','approver','developer','super_admin'];

    const hasRole = (...r) => r.includes(role);

    const loginPrompt = document.getElementById('loginPrompt');
    const nav = document.getElementById('nav');
    const main = document.getElementById('main');
    const manageBtn = document.getElementById('manageBtn');

    function applyZebra(container){
      [...container.children].filter(el=>el.offsetParent!==null).forEach((el,i)=>{
        el.classList.remove('stripe-even','stripe-odd');
        el.classList.add(i%2?'stripe-even':'stripe-odd');
      });
    }

    document.getElementById('loginBtn').onclick = () => location.reload();

    if (!isLoggedIn) {
      loginPrompt.classList.remove('hidden');
    } else {
      nav.classList.remove('hidden');
      if (!hasRole('requester','approver','developer','super_admin')) document.getElementById('navReq').classList.add('hidden');
      if (!hasRole('approver','developer','super_admin')) document.getElementById('navAppr').classList.add('hidden');
      if (!hasRole('developer','super_admin')) document.getElementById('navCat').classList.add('hidden');
      if (!devConsoleAllowed) document.getElementById('navDev').classList.add('hidden');
      document.querySelectorAll('#nav button').forEach(b => b.addEventListener('click', () => navigate(b.dataset.view)));
      if (devConsoleAllowed) {
        manageBtn.classList.remove('hidden');
        manageBtn.onclick = openUserModal;
      }
      navigate('request');
    }

    async function api(action, payload = {}) {
      const res = await fetch(webAppUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, payload, csrf })
      });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || json.message || 'Error');
      return json.data;
    }

    let currentView = '';
    function navigate(v) {
      currentView = v;
      main.innerHTML = '';
      if (v === 'request') return renderRequest();
      if (v === 'my') return loadMy();
      if (v === 'approvals') return loadApprovals();
      if (v === 'catalog') return renderCatalog();
      if (v === 'dev') return renderDev();
    }

    // ----- Request View -----
    async function renderRequest() {
      if (!hasRole('requester','approver','developer','super_admin')) return;
      main.innerHTML = `<h2>Request Supplies</h2><div id="chips"></div><input id="search" class="input" placeholder="Search"><table><thead><tr><th>Description</th><th>Category</th><th>Qty</th><th></th></tr></thead><tbody id="stock"></tbody></table><h3>Cart</h3><ul id="cart"></ul><button id="submitBtn" class="btn" disabled>Submit</button>`;
      const tbody = document.getElementById('stock');
      const chipsDiv = document.getElementById('chips');
      ['All','Office','Cleaning','Operations'].forEach(c => {
        const sp=document.createElement('span');sp.textContent=c;sp.className='chip'+(c==='All'?' active':'');sp.style.marginRight='0.5rem';sp.onclick=()=>{chipsDiv.querySelectorAll('span').forEach(ch=>ch.classList.remove('active'));sp.classList.add('active');filter();};chipsDiv.appendChild(sp);
      });
      document.getElementById('search').oninput = filter;
      const items = await api('catalog.list', {});
      function filter(){
        const q=document.getElementById('search').value.toLowerCase();
        const cat=chipsDiv.querySelector('.active').textContent;
        tbody.innerHTML='';
        items.filter(it=>{
          const matchText=it.description.toLowerCase().includes(q);
          const matchCat=cat==='All'||it.category===cat;
          return !it.archived && matchText && matchCat;
        }).forEach(it=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${it.description}</td><td>${it.category}</td><td><button class="qm">-</button><input type="number" value="1" min="1" style="width:3rem;" class="qty"><button class="qp">+</button></td><td><button class="add btn" data-desc="${it.description}">Add</button></td>`;
          const qty=tr.querySelector('.qty');
          tr.querySelector('.qm').onclick=()=>qty.value=Math.max(1,qty.value-1);
          tr.querySelector('.qp').onclick=()=>qty.value=Number(qty.value)+1;
          tr.querySelector('.add').onclick=()=>addLine(it.description,Number(qty.value));
          tbody.appendChild(tr);
        });
        applyZebra(tbody);
      }
      filter();
      const cartList=document.getElementById('cart');
      const cart=[];
      function addLine(desc,qty){cart.push({description:desc,qty});renderCart();}
      function renderCart(){cartList.innerHTML='';cart.forEach((l,i)=>{const li=document.createElement('li');li.textContent=`${l.qty}Ã— ${l.description}`;cartList.appendChild(li);});applyZebra(cartList);document.getElementById('submitBtn').disabled=cart.length===0;}
      document.getElementById('submitBtn').onclick=async()=>{if(cart.length===0)return;await api('orders.submit',{lines:cart});cart.length=0;renderCart();toast('Request sent');navigate('my');};
    }

    // ----- My Requests -----
    async function loadMy(){
      const rows = await api('orders.mine');
      main.innerHTML='<h2>My Requests</h2><table><thead><tr><th>Date</th><th>Description</th><th>Qty</th><th>Status</th><th>Approver</th></tr></thead><tbody></tbody></table>';
      const tbody=main.querySelector('tbody');
      rows.forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${r.ts}</td><td>${r.description}</td><td>${r.qty}</td><td>${r.status}</td><td>${r.approver}</td>`;tbody.appendChild(tr);});
      applyZebra(tbody);
    }

    // ----- Approvals -----
    async function loadApprovals(){
      if (!hasRole('approver','developer','super_admin')) return;
      const rows = await api('orders.pending');
      main.innerHTML='<h2>Pending Approvals</h2><table><thead><tr><th>Date</th><th>Requester</th><th>Description</th><th>Qty</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>';
      const tbody=main.querySelector('tbody');
      rows.forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${r.ts}</td><td>${r.requester}</td><td>${r.description}</td><td>${r.qty}</td><td>${r.status}</td><td><button class="btn ap">Approve</button> <button class="btn dn">Deny</button></td>`;tr.querySelector('.ap').onclick=()=>decide(r.id,'APPROVED');tr.querySelector('.dn').onclick=()=>decide(r.id,'DENIED');tbody.appendChild(tr);});
      applyZebra(tbody);
      async function decide(id,decision){await api('orders.decide',{id,decision});loadApprovals();}
    }

    // ----- Catalog -----
    async function renderCatalog(){
      if (!hasRole('developer','super_admin')) return;
      main.innerHTML='<h2>Catalog Manager</h2><div><input id="nDesc" class="input" placeholder="Description"> <select id="nCat" class="input"><option>Office</option><option>Cleaning</option><option>Operations</option></select> <button id="nAdd" class="btn">Add</button></div><table><thead><tr><th>Description</th><th>Category</th><th>Archived</th><th></th></tr></thead><tbody></tbody></table>';
      const tbody=main.querySelector('tbody');
      async function load(){
        const items=await api('catalog.list',{includeArchived:true});
        tbody.innerHTML='';
        items.forEach(it=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${it.description}</td><td>${it.category}</td><td>${it.archived}</td><td><button class="btn tg">${it.archived?'Unarchive':'Archive'}</button></td>`;tr.querySelector('.tg').onclick=async()=>{await api('catalog.archive',{sku:it.sku,archived:!it.archived});load();};tbody.appendChild(tr);});
        applyZebra(tbody);
      }
      load();
      document.getElementById('nAdd').onclick=async()=>{const desc=main.querySelector('#nDesc').value.trim();const cat=main.querySelector('#nCat').value;if(desc){await api('catalog.add',{description:desc,category:cat});main.querySelector('#nDesc').value='';load();}};
    }

    function renderDev(){
      main.innerHTML='<h2>Developer Console</h2><p>Developer tools placeholder.</p>';
    }

    // ----- Users Modal -----
    function roleSelect(val){return `<select class="roleSel">${ALL_ROLES.map(r=>`<option value="${r}" ${r===val?'selected':''}>${r}</option>`).join('')}</select>`;}

    async function openUserModal(){
      await loadUsers();
      document.getElementById('userModal').classList.remove('hidden');
    }
    document.getElementById('closeModal').onclick=()=>document.getElementById('userModal').classList.add('hidden');
    window.addEventListener('keydown',e=>{if(e.key==='Escape')document.getElementById('userModal').classList.add('hidden');});

    async function loadUsers(){
      const tbody=document.getElementById('userTable');
      const users=await api('users.list');
      tbody.innerHTML='';
      users.forEach(u=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${u.email}</td><td>${roleSelect(u.role)}</td><td><input type="checkbox" class="act" ${u.active?'checked':''}></td><td><button class="btn save">Save</button> <button class="btn dis">Disable</button></td>`;
        tr.querySelector('.save').onclick=async()=>{
          const role=tr.querySelector('.roleSel').value;
          const active=tr.querySelector('.act').checked;
          tr.querySelector('.save').disabled=true;
          try{await api('users.upsert',{email:u.email,role,active});toast('Saved');}catch(err){toast(err.message);}
          tr.querySelector('.save').disabled=false;
          loadUsers();
        };
        tr.querySelector('.dis').onclick=async()=>{
          tr.querySelector('.dis').disabled=true;
          try{await api('users.remove',{email:u.email});toast('Disabled');}catch(err){toast(err.message);}
          tr.querySelector('.dis').disabled=false;
          loadUsers();
        };
        tbody.appendChild(tr);
      });
      applyZebra(tbody);
      const nr=document.getElementById('newRole');
      nr.innerHTML=ALL_ROLES.map(r=>`<option value="${r}">${r}</option>`).join('');
    }

    document.getElementById('addUserBtn').onclick=async()=>{
      const email=document.getElementById('newEmail').value.trim().toLowerCase();
      const role=document.getElementById('newRole').value;
      if(!email||!/^[^@]+@[^@]+\.[^@]+$/.test(email))return toast('Valid email required');
      document.getElementById('addUserBtn').disabled=true;
      try{await api('users.upsert',{email,role,active:true});toast('User added');}catch(err){toast(err.message);} 
      document.getElementById('addUserBtn').disabled=false;
      document.getElementById('newEmail').value='';
      loadUsers();
    };

    function toast(msg){const div=document.createElement('div');div.textContent=msg;Object.assign(div.style,{position:'fixed',bottom:'1rem',left:'50%',transform:'translateX(-50%)',background:'#323232',color:'#fff',padding:'0.5rem 1rem',borderRadius:'4px',zIndex:'1000'});document.body.appendChild(div);setTimeout(()=>div.remove(),3000);}
  </script>
</body>
</html>


<!-- index.html -->
<!DOCTYPE html><html>
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <style>
    :root{--bg:#0b0c0f;--card:#12141a;--text:#eaeaea;--muted:#9aa0a6;--accent:#4c8bf5;}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial;}
    .tabs{display:flex;gap:8px;padding:12px;position:sticky;top:0;background:var(--bg);border-bottom:1px solid #222}
    .tab{padding:8px 12px;border-radius:10px;background:#1c1f27;cursor:pointer}
    .tab.active{background:var(--accent);color:white}
    .container{padding:12px}
    .card{background:var(--card);border:1px solid #222;border-radius:14px;padding:12px;margin-bottom:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #222}
    th{color:var(--muted);text-align:left}
    input,select,button,textarea{background:#10131a;color:var(--text);border:1px solid #2a2f3a;border-radius:10px;padding:8px}
    button.primary{background:var(--accent);border:none;color:white}
    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#222;color:#fff;padding:10px 14px;border-radius:10px;display:none}
  </style>
</head>
<body>
  <div class="tabs">
    <div class="tab active" data-view="request">Request</div>
    <div class="tab" data-view="mine">My Requests</div>
    <div class="tab" data-view="approvals">Approvals</div>
  </div>
  <div class="container">
    <section id="view-request" class="card">
      <h3>Request Supplies</h3>
      <div class="row">
        <input id="item" placeholder="Item description">
        <input id="qty" type="number" min="1" placeholder="Qty">
        <input id="est_cost" type="number" step="0.01" placeholder="Est. Cost">
        <select id="override"><option value="false">Override? No</option><option value="true">Override? Yes</option></select>
        <input id="cost_center" placeholder="Cost Center">
        <input id="gl_code" placeholder="GL Code">
      </div>
      <textarea id="justification" placeholder="Justification (40+ chars if override)"></textarea>
      <div style="margin-top:10px">
        <button class="primary" id="btn-submit">Submit</button>
      </div>
    </section>

    <section id="view-mine" class="card" style="display:none">
      <h3>My Requests</h3>
      <table id="tbl-mine"><thead><tr>
        <th>TS</th><th>Item</th><th>Qty</th><th>Est Cost</th><th>Status</th>
      </tr></thead><tbody></tbody></table>
    </section>

    <section id="view-approvals" class="card" style="display:none">
      <h3>Approvals</h3>
      <div style="margin-bottom:8px;display:flex;gap:8px">
        <button id="btn-approve" class="primary">Approve Selected</button>
        <button id="btn-deny">Deny Selected</button>
        <input id="decision-comment" placeholder="Comment (optional)">
      </div>
      <table id="tbl-approvals"><thead><tr>
        <th></th><th>TS</th><th>Requester</th><th>Item</th><th>Qty</th><th>Est Cost</th><th>Status</th>
      </tr></thead><tbody></tbody></table>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    const tabs = document.querySelectorAll('.tab');
    const views = {
      request: document.getElementById('view-request'),
      mine: document.getElementById('view-mine'),
      approvals: document.getElementById('view-approvals'),
    };
    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
      const v = t.dataset.view;
      Object.entries(views).forEach(([k,el])=> el.style.display = (k===v)?'block':'none');
      if(v==='mine') refreshMine();
      if(v==='approvals') refreshApprovals();
    }));

    document.getElementById('btn-submit').addEventListener('click', async () => {
      const payload = readRequestForm();
      const ok = validatePayload(payload);
      if(!ok) return;
      run('router_', {action:'submitOrder', payload: JSON.stringify(payload)}, (res)=>{
        if(!res.ok){ return toast(res.error||'Submit failed'); }
        toast('Submitted');
        // Navigate to My Requests and refresh
        document.querySelector('.tab[data-view="mine"]').click();
      }, (err)=> toast('Submit failed: '+err));
    });

    document.getElementById('btn-approve').addEventListener('click', ()=> bulkDecision('APPROVED'));
    document.getElementById('btn-deny').addEventListener('click', ()=> bulkDecision('DENIED'));

    function readRequestForm(){
      return {
        item: val('#item'),
        qty: Number(val('#qty')||0),
        est_cost: Number(val('#est_cost')||0),
        override: val('#override')==='true',
        justification: val('#justification')||'',
        cost_center: val('#cost_center')||'',
        gl_code: val('#gl_code')||'',
      };
    }
    function validatePayload(p){
      if(!p.item) return toast('Item is required'), false;
      if(!(p.qty>0)) return toast('Qty must be > 0'), false;
      if(p.override && (!p.justification || p.justification.trim().length<40))
        return toast('Justification must be at least 40 characters for overrides.'), false;
      return true;
    }
    function refreshMine(){
      run('router_', {action:'listMyRequests'}, (res)=>{
        if(!res.ok) return toast(res.error||'Load failed');
        renderRows('#tbl-mine tbody', res.data, (o)=>`
          <tr><td>${fmt(o.ts)}</td><td>${esc(o.item)}</td><td>${o.qty}</td><td>${money(o.est_cost)}</td><td>${o.status}</td></tr>
        `);
      }, (e)=> toast('Load failed: '+e));
    }
    function refreshApprovals(){
      run('router_', {action:'listApprovals'}, (res)=>{
        if(!res.ok) return toast(res.error||'Load failed');
        renderRows('#tbl-approvals tbody', res.data, (o)=>`
          <tr data-id="${o.id}">
            <td><input type="checkbox" class="pick"></td>
            <td>${fmt(o.ts)}</td><td>${esc(o.requester)}</td><td>${esc(o.item)}</td>
            <td>${o.qty}</td><td>${money(o.est_cost)}</td><td>${o.status}</td>
          </tr>
        `);
      }, (e)=> toast('Load failed: '+e));
    }
    function bulkDecision(decision){
      const ids = [...document.querySelectorAll('#tbl-approvals tbody .pick:checked')]
        .map(cb => cb.closest('tr').dataset.id);
      if(ids.length===0) return toast('Select at least one row');
      const comment = val('#decision-comment');
      run('router_', {action:'bulkDecision', payload: JSON.stringify({ids, decision, comment})}, (res)=>{
        if(!res.ok) return toast(res.error||'Update failed');
        toast(decision+' complete');
        refreshApprovals();
      }, (e)=> toast('Update failed: '+e));
    }

    function run(fn, args, onSuccess, onFailure){
      google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure)[fn](args.action, args.payload);
    }
    function renderRows(sel, arr, tpl){ const body=document.querySelector(sel); body.innerHTML = arr.map(tpl).join(''); }
    const val = (s)=>document.querySelector(s).value;
    const esc = (s)=> s? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;') : '';
    const fmt = (d)=> d ? new Date(d).toLocaleString() : '';
    const money = (n)=> isFinite(n)? ('$'+Number(n).toFixed(2)) : '';
    function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1800); }
  </script>
</body></html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Request Manager</title>
  <style>
    :root {
      color-scheme: light;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --surface: #ffffff;
      --surface-alt: #f5f6f8;
      --border: #d7dce1;
      --text: #202731;
      --muted: #5c6774;
      --accent: #0b57d0;
      --accent-strong: #0a47ac;
      --success: #0f9d58;
      --danger: #d93025;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--surface-alt);
      color: var(--text);
      font-size: 16px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    header {
      padding: clamp(1.25rem, 6vw, 1.75rem) clamp(1rem, 6vw, 2.25rem) clamp(0.75rem, 4vw, 1.25rem);
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      align-items: center;
    }

    header img.logo {
      width: clamp(120px, 32vw, 125px);
      height: auto;
      display: block;
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.35rem, 4.5vw, 1.75rem);
      font-weight: 600;
    }

    header p {
      margin: 0;
      color: var(--muted);
      font-size: clamp(0.9rem, 3.5vw, 1rem);
      max-width: 40rem;
    }

    nav.tab-nav {
      display: flex;
      gap: 0.5rem;
      padding: 0 clamp(0.75rem, 6vw, 2rem) clamp(0.75rem, 4vw, 1.25rem);
      overflow-x: auto;
      scrollbar-width: none;
    }

    nav.tab-nav::-webkit-scrollbar {
      display: none;
    }

    main {
      padding: 0 clamp(0.75rem, 6vw, 2rem) 2.5rem;
      width: min(100%, 720px);
      margin: 0 auto;
    }

    .tab-panel {
      display: none;
      flex-direction: column;
      gap: 1.25rem;
    }

    .tab-panel.active {
      display: flex;
    }

    section.card {
      background: var(--surface);
      border-radius: 16px;
      padding: clamp(1rem, 5vw, 1.5rem);
      box-shadow: 0 12px 24px -18px rgba(23, 32, 42, 0.3);
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    h2 {
      margin: 0;
      font-size: 1.15rem;
      font-weight: 600;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      width: 100%;
      text-align: left;
      color: inherit;
      user-select: none;
    }

    .card-header-text {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .card-title {
      font-size: 1.15rem;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .card-body {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }

    .form-grid {
      display: grid;
      gap: 0.75rem;
    }

    @media (min-width: 560px) {
      .form-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        align-items: end;
      }

      .form-grid textarea,
      .form-grid .full-width {
        grid-column: 1 / -1;
      }
    }

    label span {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.35rem;
    }

    input[type="number"],
    input[type="text"],
    input[type="date"],
    textarea,
    select,
    button {
      font: inherit;
    }

    textarea,
    input[type="number"],
    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: 0.65rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--surface-alt);
      color: inherit;
      min-height: 44px;
    }

    textarea:focus,
    input[type="number"]:focus,
    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus,
    button:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    textarea {
      resize: vertical;
      min-height: 96px;
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 999px;
      padding: 0.75rem 1.25rem;
      font-weight: 600;
      background: var(--accent);
      color: #fff;
      min-height: 44px;
      transition: background 0.2s ease;
    }

    button[disabled] {
      opacity: 0.65;
      cursor: not-allowed;
    }

    button:not([disabled]):hover {
      background: var(--accent-strong);
    }

    button.secondary {
      background: var(--surface-alt);
      color: var(--accent);
      border: 1px solid var(--border);
    }

    button.secondary:hover:not([disabled]) {
      background: #e9eef7;
    }

    .tab-nav button {
      flex: 1 1 auto;
      min-width: 0;
      padding: 0.65rem 1rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--muted);
      font-weight: 600;
    }

    .tab-nav button:not(.active):hover {
      background: #eef2f9;
    }

    .tab-nav button.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .inline-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .inline-buttons button.secondary.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .inline-buttons button.secondary.active:hover:not([disabled]) {
      background: var(--accent-strong);
    }

    .skeleton {
      position: relative;
      overflow: hidden;
      background: linear-gradient(90deg, #e4e8ee 25%, #f2f4f8 37%, #e4e8ee 63%);
      background-size: 400% 100%;
      animation: shimmer 1.4s ease infinite;
      border-radius: 12px;
      min-height: 44px;
    }

    .skeleton.sm {
      height: 18px;
      border-radius: 6px;
    }

    @keyframes shimmer {
      0% {
        background-position: 100% 0;
      }
      100% {
        background-position: -100% 0;
      }
    }

    .request-item,
    .catalog-item {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      padding: 0.85rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface-alt);
    }

    .catalog-item.selected {
      border-color: rgba(11, 87, 208, 0.4);
      background: rgba(11, 87, 208, 0.08);
    }

    .request-item strong,
    .catalog-item strong {
      font-size: 1rem;
    }

    .meta {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .detail-line {
      display: block;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .eta-field {
      margin-top: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      max-width: 220px;
    }

    .eta-field span {
      font-size: 0.8rem;
      font-weight: 600;
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.85rem;
      font-weight: 600;
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
      background: var(--surface);
      border: 1px solid var(--border);
    }

    .status[data-state="approved"] {
      border-color: rgba(15, 157, 88, 0.35);
      color: var(--success);
    }

    .status[data-state="completed"] {
      border-color: rgba(15, 157, 88, 0.35);
      color: var(--success);
    }

    .status[data-state="in_progress"],
    .status[data-state="ordered"] {
      border-color: rgba(11, 87, 208, 0.35);
      color: var(--accent);
    }

    .status[data-state="declined"],
    .status[data-state="denied"] {
      border-color: rgba(217, 48, 37, 0.35);
      color: var(--danger);
    }

    .supplies-actions {
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      margin-top: 0.5rem;
    }

    .supplies-actions .inline-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }

    .supplies-actions .inline-buttons button {
      width: 100%;
    }

    .empty {
      text-align: center;
      color: var(--muted);
      padding: 0.75rem 0;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .load-more {
      align-self: center;
    }

    #toast {
      position: fixed;
      left: 50%;
      bottom: 1.25rem;
      transform: translateX(-50%);
      background: rgba(32, 39, 49, 0.94);
      color: #fff;
      padding: 0.75rem 1.25rem;
      border-radius: 999px;
      box-shadow: 0 20px 35px -25px rgba(23, 32, 42, 0.8);
      display: none;
      z-index: 20;
      min-width: 200px;
      text-align: center;
    }

    @media (prefers-reduced-motion: reduce) {
      .skeleton {
        animation: none;
      }
    }

    @media (min-width: 600px) {
      body {
        font-size: 17px;
      }

      .tab-panel {
        gap: 1.5rem;
      }

      nav.tab-nav {
        justify-content: center;
      }
    }

    @media (min-width: 720px) {
      main {
        width: min(100%, 900px);
      }

      header {
        text-align: left;
        align-items: center;
        flex-direction: row;
        justify-content: space-between;
      }

      header .hero-copy {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        align-items: flex-start;
      }

      header p {
        max-width: 28rem;
      }
    }

    @media (min-width: 960px) {
      main {
        width: min(100%, 1080px);
      }

      .tab-panel.active {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
        align-items: stretch;
      }

      .tab-panel.active section.card {
        height: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <img
      class="logo"
      src="https://www.dublincleaners.com/wp-content/uploads/2024/12/Dublin-Logos-stacked.png"
      alt="Dublin Cleaners logo"
      loading="lazy"
      decoding="async"
      width="150"
    >
    <div class="hero-copy">
      <h1>Request Manager</h1>
      <p>Submit and track supplies, IT, and maintenance needs from one workspace.</p>
    </div>
  </header>
  <nav class="tab-nav" aria-label="Request types">
    <button type="button" data-tab-trigger="supplies" class="active">Supplies</button>
    <button type="button" data-tab-trigger="it">IT</button>
    <button type="button" data-tab-trigger="maintenance">Maintenance</button>
  </nav>
  <main>
    <div class="tab-panel active" data-tab-panel="supplies">
      <section class="card" id="suppliesFormCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">New supplies request</span>
            <span class="card-subtitle meta">Use the catalog to quickly fill in the item details before submitting.</span>
          </div>
        </div>
        <div class="card-body">
          <form id="suppliesForm" class="form-grid" novalidate>
            <label class="full-width">
              <span>Pick an Item</span>
              <select id="catalogSelect" name="catalogSku" required></select>
            </label>
            <label>
              <span>Location</span>
              <select id="suppliesLocation" name="location" required>
                <option value="">Select a location</option>
                <option value="Plant">Plant</option>
                <option value="Short North">Short North</option>
                <option value="South Dublin">South Dublin</option>
                <option value="Muirfield">Muirfield</option>
                <option value="Morse Rd.">Morse Rd.</option>
                <option value="Granville">Granville</option>
                <option value="Newark">Newark</option>
              </select>
            </label>
            <label>
              <span>Quantity</span>
              <input id="suppliesQty" name="qty" type="number" min="1" step="1" required>
            </label>
            <label class="full-width">
              <span>Notes (optional)</span>
              <textarea id="suppliesNotes" name="notes" autocomplete="off"></textarea>
            </label>
            <div class="inline-buttons full-width">
              <button type="submit" id="suppliesSubmitButton">Submit request</button>
              <button type="button" id="suppliesResetButton" class="secondary">Reset</button>
            </div>
          </form>
        </div>
      </section>

      <section class="card" id="suppliesRequestsCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">Supplies requests</span>
            <span class="card-subtitle meta">Track order status and approvals in one place.</span>
          </div>
        </div>
        <div class="card-body">
          <div id="suppliesRequestsList" class="list" role="list"></div>
          <button type="button" id="suppliesMoreButton" class="load-more secondary">Load more</button>
        </div>
      </section>

      <section class="card" id="catalogCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">Catalog</span>
            <span class="card-subtitle meta">Tap an item to autofill the request form.</span>
          </div>
        </div>
        <div class="card-body">
          <div id="catalogList" class="list" role="list"></div>
          <button type="button" id="catalogMoreButton" class="load-more secondary">Load more</button>
        </div>
      </section>
    </div>

    <div class="tab-panel" data-tab-panel="it">
      <section class="card" id="itFormCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">New IT request</span>
            <span class="card-subtitle meta">Report technology issues or access needs for quick routing.</span>
          </div>
        </div>
        <div class="card-body">
          <form id="itForm" class="form-grid" novalidate>
            <label>
              <span>Location</span>
              <select id="itLocation" name="location" required>
                <option value="">Select a location</option>
                <option value="Plant">Plant</option>
                <option value="Short North">Short North</option>
                <option value="South Dublin">South Dublin</option>
                <option value="Muirfield">Muirfield</option>
                <option value="Morse Rd.">Morse Rd.</option>
                <option value="Granville">Granville</option>
                <option value="Newark">Newark</option>
              </select>
            </label>
            <label class="full-width">
              <span>Issue summary</span>
              <textarea id="itIssue" name="issue" autocomplete="off" required></textarea>
            </label>
            <label>
              <span>Device or system</span>
              <input id="itDevice" name="device" type="text" autocomplete="off">
            </label>
            <label>
              <span>Urgency</span>
              <select id="itUrgency" name="urgency">
                <option value="low">Low</option>
                <option value="normal">Normal</option>
                <option value="high">High</option>
                <option value="critical">Critical</option>
              </select>
            </label>
            <label class="full-width">
              <span>Additional details</span>
              <textarea id="itDetails" name="details" autocomplete="off"></textarea>
            </label>
            <div class="inline-buttons full-width">
              <button type="submit" id="itSubmitButton">Submit request</button>
              <button type="button" id="itResetButton" class="secondary">Reset</button>
            </div>
          </form>
        </div>
      </section>

      <section class="card" id="itRequestsCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">IT queue</span>
            <span class="card-subtitle meta">Monitor progress and close items when resolved.</span>
          </div>
        </div>
        <div class="card-body">
          <div id="itRequestsList" class="list" role="list"></div>
          <button type="button" id="itMoreButton" class="load-more secondary">Load more</button>
        </div>
      </section>
    </div>

    <div class="tab-panel" data-tab-panel="maintenance">
      <section class="card" id="maintenanceFormCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">New maintenance request</span>
            <span class="card-subtitle meta">Share location details so facilities can prioritize the work.</span>
          </div>
        </div>
        <div class="card-body">
          <form id="maintenanceForm" class="form-grid" novalidate>
            <label>
              <span>Location</span>
              <select id="maintenanceLocation" name="location" required>
                <option value="">Select a location</option>
                <option value="Plant">Plant</option>
                <option value="Short North">Short North</option>
                <option value="South Dublin">South Dublin</option>
                <option value="Muirfield">Muirfield</option>
                <option value="Morse Rd.">Morse Rd.</option>
                <option value="Granville">Granville</option>
                <option value="Newark">Newark</option>
              </select>
            </label>
            <label class="full-width">
              <span>Issue description</span>
              <textarea id="maintenanceIssue" name="issue" autocomplete="off" required></textarea>
            </label>
            <label>
              <span>Urgency</span>
              <select id="maintenanceUrgency" name="urgency">
                <option value="low">Low</option>
                <option value="normal">Normal</option>
                <option value="high">High</option>
                <option value="critical">Critical</option>
              </select>
            </label>
            <label class="full-width">
              <span>Access notes (optional)</span>
              <textarea id="maintenanceAccessNotes" name="accessNotes" autocomplete="off"></textarea>
            </label>
            <div class="inline-buttons full-width">
              <button type="submit" id="maintenanceSubmitButton">Submit request</button>
              <button type="button" id="maintenanceResetButton" class="secondary">Reset</button>
            </div>
          </form>
        </div>
      </section>

      <section class="card" id="maintenanceRequestsCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">Maintenance pipeline</span>
            <span class="card-subtitle meta">See outstanding work orders and update when finished.</span>
          </div>
        </div>
        <div class="card-body">
          <div id="maintenanceRequestsList" class="list" role="list"></div>
          <button type="button" id="maintenanceMoreButton" class="load-more secondary">Load more</button>
        </div>
      </section>
    </div>
  </main>
  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    const SESSION = <?!= JSON.stringify(session) ?>;
  </script>
  <script>
    (function () {
      const hasServer = typeof google !== 'undefined' && google.script && google.script.run;
      const server = hasServer ? google.script.run : null;
      const REQUEST_KEYS = ['supplies', 'it', 'maintenance'];
      const PERSIST_DELAY = 240;
      const persistTimers = {};
      let warmScheduled = false;
      const FORM_TEMPLATES = {
        supplies: { description: '', qty: 1, notes: '', catalogSku: '', location: '' },
        it: { location: '', issue: '', device: '', urgency: 'normal', details: '' },
        maintenance: { location: '', issue: '', urgency: 'normal', accessNotes: '' }
      };
      const LOCAL_KEYS = {
        supplies: 'request-manager:supplies',
        it: 'request-manager:it',
        maintenance: 'request-manager:maintenance'
      };
      const EMPTY_MESSAGES = {
        supplies: 'No supplies requests yet. Submit your first request above.',
        it: 'No IT requests yet. Log an issue to get started.',
        maintenance: 'No maintenance requests yet. Report one above.'
      };

      const state = {
        activeTab: 'supplies',
        forms: {
          supplies: Object.assign({}, FORM_TEMPLATES.supplies),
          it: Object.assign({}, FORM_TEMPLATES.it),
          maintenance: Object.assign({}, FORM_TEMPLATES.maintenance)
        },
        requests: {
          supplies: [],
          it: [],
          maintenance: []
        },
        nextTokens: {
          supplies: '',
          it: '',
          maintenance: ''
        },
        loading: {
          supplies: false,
          it: false,
          maintenance: false
        },
        loaded: {
          supplies: false,
          it: false,
          maintenance: false
        },
        catalog: {
          items: [],
          nextToken: '',
          loading: false
        }
      };

      const dom = {
        tabButtons: Array.from(document.querySelectorAll('[data-tab-trigger]')),
        panels: Array.from(document.querySelectorAll('[data-tab-panel]')),
        toast: document.getElementById('toast'),
        supplies: {
          form: document.getElementById('suppliesForm'),
          location: document.getElementById('suppliesLocation'),
          qty: document.getElementById('suppliesQty'),
          notes: document.getElementById('suppliesNotes'),
          submit: document.getElementById('suppliesSubmitButton'),
          reset: document.getElementById('suppliesResetButton'),
          list: document.getElementById('suppliesRequestsList'),
          more: document.getElementById('suppliesMoreButton'),
          catalogSelect: document.getElementById('catalogSelect'),
          catalogList: document.getElementById('catalogList'),
          catalogMore: document.getElementById('catalogMoreButton')
        },
        it: {
          form: document.getElementById('itForm'),
          location: document.getElementById('itLocation'),
          issue: document.getElementById('itIssue'),
          device: document.getElementById('itDevice'),
          urgency: document.getElementById('itUrgency'),
          details: document.getElementById('itDetails'),
          submit: document.getElementById('itSubmitButton'),
          reset: document.getElementById('itResetButton'),
          list: document.getElementById('itRequestsList'),
          more: document.getElementById('itMoreButton')
        },
        maintenance: {
          form: document.getElementById('maintenanceForm'),
          location: document.getElementById('maintenanceLocation'),
          issue: document.getElementById('maintenanceIssue'),
          urgency: document.getElementById('maintenanceUrgency'),
          accessNotes: document.getElementById('maintenanceAccessNotes'),
          submit: document.getElementById('maintenanceSubmitButton'),
          reset: document.getElementById('maintenanceResetButton'),
          list: document.getElementById('maintenanceRequestsList'),
          more: document.getElementById('maintenanceMoreButton')
        }
      };

      const initialSessionEmail = SESSION && SESSION.email ? String(SESSION.email) : '';

      attachNavHandlers();
      attachFormHandlers();
      REQUEST_KEYS.forEach(type => {
        hydrateFormFromCache(type);
        renderForm(type);
      });
      setActiveTab(state.activeTab);
      if (hasServer) {
        loadCatalog({ append: false });
        ensureRequestsLoaded('supplies');
      } else {
        renderCatalog();
        REQUEST_KEYS.forEach(type => {
          state.loaded[type] = true;
          renderRequests(type);
        });
      }

      function attachNavHandlers() {
        dom.tabButtons.forEach(button => {
          button.addEventListener('click', () => {
            const type = button.getAttribute('data-tab-trigger');
            if (type && REQUEST_KEYS.indexOf(type) !== -1) {
              setActiveTab(type);
            }
          });
        });
      }

      function attachFormHandlers() {
        dom.supplies.form.addEventListener('submit', evt => handleSubmit(evt, 'supplies'));
        dom.supplies.reset.addEventListener('click', () => {
          resetForm('supplies');
        });
        dom.supplies.location.addEventListener('change', () => {
          setFormState('supplies', { location: dom.supplies.location.value });
          persistForm('supplies');
        });
        dom.supplies.qty.addEventListener('input', () => {
          const qty = Number(dom.supplies.qty.value);
          const sanitized = Number.isFinite(qty) && qty > 0 ? Math.floor(qty) : 1;
          setFormState('supplies', { qty: sanitized });
          dom.supplies.qty.value = sanitized;
          persistForm('supplies');
        });
        dom.supplies.notes.addEventListener('input', () => {
          setFormState('supplies', { notes: dom.supplies.notes.value });
          persistForm('supplies');
        });
        dom.supplies.catalogSelect.addEventListener('change', () => {
          const option = dom.supplies.catalogSelect.options[dom.supplies.catalogSelect.selectedIndex];
          const sku = option ? option.value : '';
          const description = option && option.dataset ? (option.dataset.description || '') : '';
          setFormState('supplies', { catalogSku: sku, description });
          persistForm('supplies');
          if (state.catalog.items.length) {
            renderCatalog();
          }
        });
        dom.supplies.more.addEventListener('click', () => {
          if (!state.loading.supplies && state.nextTokens.supplies) {
            loadRequests('supplies', { append: true });
          }
        });
        dom.supplies.catalogMore.addEventListener('click', () => {
          if (!state.catalog.loading && state.catalog.nextToken) {
            loadCatalog({ append: true });
          }
        });

        dom.it.form.addEventListener('submit', evt => handleSubmit(evt, 'it'));
        dom.it.reset.addEventListener('click', () => {
          resetForm('it');
        });
        dom.it.location.addEventListener('change', () => {
          setFormState('it', { location: dom.it.location.value });
          persistForm('it');
        });
        dom.it.issue.addEventListener('input', () => {
          setFormState('it', { issue: dom.it.issue.value });
          persistForm('it');
        });
        dom.it.device.addEventListener('input', () => {
          setFormState('it', { device: dom.it.device.value });
          persistForm('it');
        });
        dom.it.urgency.addEventListener('change', () => {
          setFormState('it', { urgency: dom.it.urgency.value });
          persistForm('it');
        });
        dom.it.details.addEventListener('input', () => {
          setFormState('it', { details: dom.it.details.value });
          persistForm('it');
        });
        dom.it.more.addEventListener('click', () => {
          if (!state.loading.it && state.nextTokens.it) {
            loadRequests('it', { append: true });
          }
        });

        dom.maintenance.form.addEventListener('submit', evt => handleSubmit(evt, 'maintenance'));
        dom.maintenance.reset.addEventListener('click', () => {
          resetForm('maintenance');
        });
        dom.maintenance.location.addEventListener('change', () => {
          setFormState('maintenance', { location: dom.maintenance.location.value });
          persistForm('maintenance');
        });
        dom.maintenance.issue.addEventListener('input', () => {
          setFormState('maintenance', { issue: dom.maintenance.issue.value });
          persistForm('maintenance');
        });
        dom.maintenance.urgency.addEventListener('change', () => {
          setFormState('maintenance', { urgency: dom.maintenance.urgency.value });
          persistForm('maintenance');
        });
        dom.maintenance.accessNotes.addEventListener('input', () => {
          setFormState('maintenance', { accessNotes: dom.maintenance.accessNotes.value });
          persistForm('maintenance');
        });
        dom.maintenance.more.addEventListener('click', () => {
          if (!state.loading.maintenance && state.nextTokens.maintenance) {
            loadRequests('maintenance', { append: true });
          }
        });
      }

      function setActiveTab(type) {
        state.activeTab = type;
        dom.tabButtons.forEach(button => {
          button.classList.toggle('active', button.getAttribute('data-tab-trigger') === type);
        });
        dom.panels.forEach(panel => {
          panel.classList.toggle('active', panel.getAttribute('data-tab-panel') === type);
        });
        ensureRequestsLoaded(type);
        scheduleWarmCache();
      }

      function ensureRequestsLoaded(type) {
        if (state.loaded[type] || !hasServer) {
          return;
        }
        loadRequests(type, { append: false });
      }

      function scheduleWarmCache() {
        if (!hasServer || warmScheduled) {
          return;
        }
        warmScheduled = true;
        const idle = typeof window.requestIdleCallback === 'function'
          ? window.requestIdleCallback
          : callback => setTimeout(() => callback({ didTimeout: false }), 600);
        idle(() => {
          const others = REQUEST_KEYS.filter(tab => tab !== state.activeTab);
          others.forEach((type, index) => {
            setTimeout(() => {
              if (!state.loaded[type]) {
                loadRequests(type, { append: false });
              }
            }, index * 220);
          });
        });
      }

      function handleSubmit(event, type) {
        event.preventDefault();
        const formState = state.forms[type];
        const validationError = validateForm(type, formState);
        if (validationError) {
          handleError({ message: validationError }, `${type}:validation`);
          return;
        }
        if (!server) {
          showToast('Connect to Google Apps Script to submit requests.');
          return;
        }
        disableForm(type, true);
        const payload = Object.assign({
          cid: makeCid(),
          clientRequestId: makeClientRequestId(type),
          type
        }, formState);
        server
          .withSuccessHandler(response => {
            disableForm(type, false);
            if (!response || !response.ok || !response.request) {
              handleError(response, 'createRequest', payload);
              return;
            }
            showToast('Request submitted');
            resetForm(type);
            state.requests[type].unshift(response.request);
            renderRequests(type);
          })
          .withFailureHandler(err => {
            disableForm(type, false);
            handleError(err, 'createRequest', payload);
          })
          .createRequest(payload);
      }

      function validateForm(type, formState) {
        switch (type) {
          case 'supplies':
            if (!formState.location || !formState.location.trim()) {
              return 'Location is required.';
            }
            if (!formState.description || !formState.description.trim()) {
              return 'Please pick an item before submitting.';
            }
            if (!formState.qty || Number(formState.qty) <= 0) {
              return 'Quantity must be at least 1.';
            }
            return '';
          case 'it':
            if (!formState.location || !formState.location.trim()) {
              return 'Location is required.';
            }
            if (!formState.issue || !formState.issue.trim()) {
              return 'Issue summary is required.';
            }
            return '';
          case 'maintenance':
            if (!formState.location || !formState.location.trim()) {
              return 'Location is required.';
            }
            if (!formState.issue || !formState.issue.trim()) {
              return 'Issue description is required.';
            }
            return '';
          default:
            return 'Unsupported request type.';
        }
      }

      function resetForm(type) {
        state.forms[type] = Object.assign({}, FORM_TEMPLATES[type]);
        renderForm(type);
        if (type === 'supplies' && state.catalog.items.length) {
          renderCatalog();
        }
        persistForm(type, { immediate: true });
      }

      function renderForm(type) {
        const formState = state.forms[type];
        if (type === 'supplies') {
          dom.supplies.catalogSelect.value = formState.catalogSku || '';
          dom.supplies.location.value = formState.location || '';
          dom.supplies.qty.value = formState.qty || 1;
          dom.supplies.notes.value = formState.notes || '';
        } else if (type === 'it') {
          dom.it.location.value = formState.location || '';
          dom.it.issue.value = formState.issue || '';
          dom.it.device.value = formState.device || '';
          dom.it.urgency.value = formState.urgency || 'normal';
          dom.it.details.value = formState.details || '';
        } else if (type === 'maintenance') {
          dom.maintenance.location.value = formState.location || '';
          dom.maintenance.issue.value = formState.issue || '';
          dom.maintenance.urgency.value = formState.urgency || 'normal';
          dom.maintenance.accessNotes.value = formState.accessNotes || '';
        }
      }

      function loadRequests(type, { append }) {
        if (state.loading[type]) {
          return;
        }
        if (!server) {
          state.loaded[type] = true;
          renderRequests(type);
          return;
        }
        state.loading[type] = true;
        const moreButton = dom[type].more;
        if (moreButton) {
          moreButton.disabled = true;
        }
        toggleRequestsSkeleton(type, true);
        const payload = {
          cid: makeCid(),
          type,
          pageSize: 10,
          nextToken: append ? state.nextTokens[type] : ''
        };
        server
          .withSuccessHandler(response => {
            state.loading[type] = false;
            state.loaded[type] = true;
            toggleRequestsSkeleton(type, false);
            if (!response || !response.ok) {
              handleError(response, 'listRequests', payload);
              return;
            }
            state.nextTokens[type] = response.nextToken || '';
            const items = Array.isArray(response.requests) ? response.requests : [];
            state.requests[type] = append ? state.requests[type].concat(items) : items;
            renderRequests(type);
          })
          .withFailureHandler(err => {
            state.loading[type] = false;
            state.loaded[type] = true;
            toggleRequestsSkeleton(type, false);
            handleError(err, 'listRequests', payload);
          })
          .listRequests(payload);
      }

      function renderRequests(type) {
        const list = dom[type].list;
        const moreButton = dom[type].more;
        list.textContent = '';
        if (!state.requests[type].length) {
          if (state.loading[type]) {
            list.appendChild(buildSkeletonBlock());
          } else {
            const empty = document.createElement('p');
            empty.className = 'empty';
            empty.textContent = hasServer ? EMPTY_MESSAGES[type] : 'Connect to Google Apps Script to load requests.';
            list.appendChild(empty);
          }
          if (moreButton) {
            moreButton.disabled = true;
          }
          return;
        }
        const fragment = document.createDocumentFragment();
        state.requests[type].forEach(request => {
          const item = document.createElement('article');
          item.className = 'request-item';
          item.dataset.requestType = type;
          item.dataset.requestId = request.id;

          const title = document.createElement('strong');
          title.textContent = request.summary || 'Request';
          item.appendChild(title);

          const meta = document.createElement('span');
          meta.className = 'meta';
          meta.textContent = buildRequestMeta(request);
          item.appendChild(meta);

          const status = document.createElement('span');
          status.className = 'status';
          const statusValue = String(request.status || '').toLowerCase();
          const stateKey = statusValue.replace(/\s+/g, '_');
          status.dataset.state = stateKey;
          status.textContent = formatStatus(stateKey);
          item.appendChild(status);

          if (type === 'supplies') {
            const etaWrapper = document.createElement('label');
            etaWrapper.className = 'eta-field';

            const etaText = document.createElement('span');
            etaText.textContent = 'ETA';
            etaWrapper.appendChild(etaText);

            const etaInput = document.createElement('input');
            etaInput.type = 'date';
            etaInput.autocomplete = 'off';
            const previousEta = getRequestEta(request);
            etaInput.value = previousEta;
            etaInput.setAttribute('aria-label', `ETA for ${request.summary || 'request'}`);
            if (!server) {
              etaInput.disabled = true;
            }
            etaInput.addEventListener('change', () => {
              const nextValue = etaInput.value;
              if (nextValue === previousEta) {
                return;
              }
              handleUpdateEta(type, request, nextValue, etaInput, previousEta);
            });
            etaWrapper.appendChild(etaInput);
            item.appendChild(etaWrapper);
          }

          if (Array.isArray(request.details)) {
            request.details.forEach(detail => {
              if (!detail) return;
              const line = document.createElement('span');
              line.className = 'detail-line';
              line.textContent = detail;
              item.appendChild(line);
            });
          }

          if (type === 'supplies') {
            const buttonRow = document.createElement('div');
            buttonRow.className = 'inline-buttons';
            let hasButtons = false;

            if (stateKey === 'pending') {
              const approved = document.createElement('button');
              approved.type = 'button';
              approved.className = 'secondary';
              approved.textContent = 'Approved';
              approved.addEventListener('click', () => handleUpdateStatus(type, request.id, 'approved'));
              buttonRow.appendChild(approved);

              const denied = document.createElement('button');
              denied.type = 'button';
              denied.className = 'secondary';
              denied.textContent = 'Denied';
              denied.addEventListener('click', () => handleUpdateStatus(type, request.id, 'denied'));
              buttonRow.appendChild(denied);
              hasButtons = true;
            }

            if (hasButtons) {
              const controls = document.createElement('div');
              controls.className = 'supplies-actions';
              controls.appendChild(buttonRow);
              item.appendChild(controls);
            }
          } else if (stateKey === 'pending' || stateKey === 'in_progress') {
            const actions = document.createElement('div');
            actions.className = 'inline-buttons';
            const complete = document.createElement('button');
            complete.type = 'button';
            complete.className = 'secondary';
            complete.textContent = 'Complete';
            complete.addEventListener('click', () => handleUpdateStatus(type, request.id, 'completed'));
            actions.appendChild(complete);

            const progress = document.createElement('button');
            progress.type = 'button';
            progress.className = 'secondary';
            progress.textContent = 'In Progress';
            progress.addEventListener('click', () => handleUpdateStatus(type, request.id, 'in_progress'));
            progress.classList.toggle('active', stateKey === 'in_progress');
            progress.setAttribute('aria-pressed', stateKey === 'in_progress' ? 'true' : 'false');
            actions.appendChild(progress);

            const denied = document.createElement('button');
            denied.type = 'button';
            denied.className = 'secondary';
            denied.textContent = 'Denied';
            denied.addEventListener('click', () => handleUpdateStatus(type, request.id, 'denied'));
            actions.appendChild(denied);

            item.appendChild(actions);
          }

          fragment.appendChild(item);
        });
        list.appendChild(fragment);
        if (moreButton) {
          moreButton.disabled = !state.nextTokens[type];
        }
      }

      function handleUpdateStatus(type, requestId, status) {
        if (!server) {
          showToast('Connect to Google Apps Script to update statuses.');
          return;
        }
        const payload = {
          cid: makeCid(),
          clientRequestId: makeClientRequestId(type),
          type,
          requestId,
          status
        };
        const item = dom[type].list.querySelector(`article[data-request-id="${requestId}"]`);
        const interactive = item
          ? Array.from(item.querySelectorAll('button'))
          : [];
        interactive.forEach(element => { element.disabled = true; });
        server
          .withSuccessHandler(response => {
            interactive.forEach(element => { element.disabled = false; });
            if (!response || !response.ok || !response.request) {
              handleError(response, 'updateRequestStatus', payload);
              return;
            }
            const updated = response.request;
            const index = state.requests[type].findIndex(entry => entry.id === updated.id);
            if (index >= 0) {
              state.requests[type][index] = updated;
              renderRequests(type);
            }
            showToast('Request updated');
          })
          .withFailureHandler(err => {
            interactive.forEach(element => { element.disabled = false; });
            handleError(err, 'updateRequestStatus', payload);
          })
          .updateRequestStatus(payload);
      }

      function handleUpdateEta(type, request, etaValue, input, previousEta) {
        if (!server) {
          showToast('Connect to Google Apps Script to update ETA dates.');
          input.value = previousEta;
          return;
        }
        if (!request || !request.id) {
          input.value = previousEta;
          handleError({ message: 'Request not found.' }, 'updateRequestEta');
          return;
        }
        const payload = {
          cid: makeCid(),
          clientRequestId: makeClientRequestId(type),
          type,
          requestId: request.id,
          status: request.status || 'pending',
          eta: etaValue
        };
        input.disabled = true;
        server
          .withSuccessHandler(response => {
            input.disabled = false;
            if (!response || !response.ok || !response.request) {
              input.value = previousEta;
              handleError(response, 'updateRequestEta', payload);
              return;
            }
            const updated = response.request;
            const index = state.requests[type].findIndex(entry => entry.id === updated.id);
            if (index >= 0) {
              state.requests[type][index] = updated;
              renderRequests(type);
            }
            const updatedEta = getRequestEta(updated);
            showToast(updatedEta ? 'ETA updated' : 'ETA cleared');
          })
          .withFailureHandler(err => {
            input.disabled = false;
            input.value = previousEta;
            handleError(err, 'updateRequestEta', payload);
          })
          .updateRequestStatus(payload);
      }

      function buildRequestMeta(request) {
        const parts = [];
        if (request.ts) {
          try {
            parts.push(new Date(request.ts).toLocaleString());
          } catch (err) {
            parts.push(request.ts);
          }
        }
        if (request.requester) {
          parts.push(request.requester);
        }
        if (request.approver && request.status !== 'pending') {
          parts.push(`by ${request.approver}`);
        }
        return parts.join(' • ');
      }

      function getRequestEta(request) {
        if (!request || !request.fields) {
          return '';
        }
        return String(request.fields.eta || '');
      }

      function loadCatalog({ append }) {
        if (state.catalog.loading || !server) {
          if (!server) {
            state.catalog.loading = false;
            renderCatalog();
          }
          return;
        }
        state.catalog.loading = true;
        dom.supplies.catalogMore.disabled = true;
        toggleCatalogSkeleton(true);
        const payload = {
          cid: makeCid(),
          pageSize: 20,
          nextToken: append ? state.catalog.nextToken : ''
        };
        server
          .withSuccessHandler(response => {
            state.catalog.loading = false;
            toggleCatalogSkeleton(false);
            if (!response || !response.ok) {
              handleError(response, 'listCatalog', payload);
              return;
            }
            state.catalog.nextToken = response.nextToken || '';
            const items = Array.isArray(response.items) ? response.items : [];
            state.catalog.items = append ? state.catalog.items.concat(items) : items;
            renderCatalog();
          })
          .withFailureHandler(err => {
            state.catalog.loading = false;
            toggleCatalogSkeleton(false);
            handleError(err, 'listCatalog', payload);
          })
          .listCatalog(payload);
      }

      function renderCatalog() {
        dom.supplies.catalogList.textContent = '';
        dom.supplies.catalogSelect.textContent = '';
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = state.catalog.items.length ? 'Pick an item' : 'Catalog unavailable';
        dom.supplies.catalogSelect.appendChild(defaultOption);

        if (!state.catalog.items.length) {
          if (state.catalog.loading) {
            dom.supplies.catalogList.appendChild(buildSkeletonBlock());
            dom.supplies.catalogMore.disabled = true;
          } else {
            const empty = document.createElement('p');
            empty.className = 'empty';
            empty.textContent = hasServer ? 'No catalog items found.' : 'Catalog requires Google Apps Script.';
            dom.supplies.catalogList.appendChild(empty);
            dom.supplies.catalogMore.disabled = true;
          }
          dom.supplies.catalogSelect.disabled = !state.catalog.items.length;
          return;
        }

        let selectedSku = state.forms.supplies.catalogSku || '';
        let shouldPersist = false;
        if (!selectedSku && state.forms.supplies.description) {
          const match = state.catalog.items.find(item => item.description === state.forms.supplies.description);
          if (match) {
            selectedSku = match.sku;
            setFormState('supplies', { catalogSku: match.sku, description: match.description });
            shouldPersist = true;
          }
        }

        const fragment = document.createDocumentFragment();
        state.catalog.items.forEach(item => {
          const option = document.createElement('option');
          option.value = item.sku;
          option.textContent = `${item.description} · ${item.category}`;
          option.dataset.description = item.description;
          if (item.sku === selectedSku) {
            option.selected = true;
          }
          dom.supplies.catalogSelect.appendChild(option);

          const card = document.createElement('article');
          card.className = 'catalog-item';
          if (item.sku === selectedSku) {
            card.classList.add('selected');
          }
          card.tabIndex = 0;
          card.setAttribute('role', 'listitem');
          const name = document.createElement('strong');
          name.textContent = item.description;
          card.appendChild(name);
          const meta = document.createElement('span');
          meta.className = 'meta';
          meta.textContent = `${item.category} • ${item.sku}`;
          card.appendChild(meta);
          const handleSelect = () => {
            dom.supplies.catalogSelect.value = item.sku;
            dom.supplies.catalogSelect.dispatchEvent(new Event('change'));
          };
          card.addEventListener('click', () => {
            handleSelect();
          });
          card.addEventListener('keydown', evt => {
            if (evt.key === 'Enter' || evt.key === ' ') {
              evt.preventDefault();
              handleSelect();
            }
          });
          fragment.appendChild(card);
        });
        dom.supplies.catalogList.appendChild(fragment);
        dom.supplies.catalogMore.disabled = !state.catalog.nextToken;
        dom.supplies.catalogSelect.disabled = false;
        dom.supplies.catalogSelect.value = selectedSku || '';
        if (shouldPersist) {
          persistForm('supplies');
        }
      }

      function setFormState(type, partial) {
        state.forms[type] = Object.assign({}, state.forms[type], partial);
      }

      function persistForm(type, options) {
        const immediate = options && options.immediate;
        if (immediate) {
          flushPersist(type);
          return;
        }
        clearTimeout(persistTimers[type]);
        persistTimers[type] = setTimeout(() => {
          flushPersist(type);
        }, PERSIST_DELAY);
      }

      function flushPersist(type) {
        try {
          localStorage.setItem(LOCAL_KEYS[type], JSON.stringify(state.forms[type]));
        } catch (err) {
          // ignore storage errors
        }
      }

      function flushAllPersists() {
        REQUEST_KEYS.forEach(type => {
          if (persistTimers[type]) {
            clearTimeout(persistTimers[type]);
            persistTimers[type] = null;
          }
          flushPersist(type);
        });
      }

      function hydrateFormFromCache(type) {
        try {
          const raw = localStorage.getItem(LOCAL_KEYS[type]);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === 'object') {
              state.forms[type] = Object.assign({}, FORM_TEMPLATES[type], parsed);
              if (type === 'it') {
                const form = state.forms[type];
                if ((!form.urgency || form.urgency === undefined) && form.impact) {
                  form.urgency = form.impact;
                }
                delete form.impact;
              }
            }
          }
        } catch (err) {
          // ignore cache issues
        }
      }

      window.addEventListener('beforeunload', flushAllPersists);
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          flushAllPersists();
        }
      });

      function toggleRequestsSkeleton(type, active) {
        if (!active || state.requests[type].length) {
          return;
        }
        const list = dom[type].list;
        list.textContent = '';
        list.appendChild(buildSkeletonBlock());
        const moreButton = dom[type].more;
        if (moreButton) {
          moreButton.disabled = true;
        }
      }

      function toggleCatalogSkeleton(active) {
        if (!active || state.catalog.items.length) {
          return;
        }
        dom.supplies.catalogList.textContent = '';
        dom.supplies.catalogList.appendChild(buildSkeletonBlock());
        dom.supplies.catalogMore.disabled = true;
      }

      function buildSkeletonBlock() {
        const wrapper = document.createElement('div');
        wrapper.className = 'request-item';
        const title = document.createElement('div');
        title.className = 'skeleton';
        title.style.height = '20px';
        wrapper.appendChild(title);
        const line = document.createElement('div');
        line.className = 'skeleton sm';
        wrapper.appendChild(line);
        return wrapper;
      }

      function formatStatus(status) {
        switch (status) {
          case 'completed':
            return 'Completed';
          case 'in_progress':
            return 'In progress';
          case 'ordered':
            return 'Ordered';
          case 'approved':
            return 'Approved';
          case 'denied':
            return 'Denied';
          case 'declined':
            return 'Declined';
          default:
            return 'Pending review';
        }
      }

      function disableForm(type, disabled) {
        if (type === 'supplies') {
          dom.supplies.submit.disabled = disabled;
          dom.supplies.location.disabled = disabled;
          dom.supplies.qty.disabled = disabled;
          dom.supplies.notes.disabled = disabled;
          dom.supplies.catalogSelect.disabled = disabled;
          dom.supplies.reset.disabled = disabled;
        } else if (type === 'it') {
          dom.it.submit.disabled = disabled;
          dom.it.location.disabled = disabled;
          dom.it.issue.disabled = disabled;
          dom.it.device.disabled = disabled;
          dom.it.urgency.disabled = disabled;
          dom.it.details.disabled = disabled;
          dom.it.reset.disabled = disabled;
        } else if (type === 'maintenance') {
          dom.maintenance.submit.disabled = disabled;
          dom.maintenance.location.disabled = disabled;
          dom.maintenance.issue.disabled = disabled;
          dom.maintenance.urgency.disabled = disabled;
          dom.maintenance.accessNotes.disabled = disabled;
          dom.maintenance.reset.disabled = disabled;
        }
      }

      function showToast(message) {
        dom.toast.textContent = message;
        dom.toast.style.display = 'block';
        clearTimeout(showToast.timer);
        showToast.timer = setTimeout(() => {
          dom.toast.style.display = 'none';
        }, 2800);
      }

      function handleError(err, context, payload) {
        const message = err && err.message ? err.message : 'Something went wrong. Please try again.';
        console.error('[RequestManager]', context, message, err);
        showToast(message);
        if (!server) {
          return;
        }
        try {
          server
            .withFailureHandler(() => { })
            .logClientError({
              cid: makeCid(),
              context,
              message,
              stack: err && err.stack ? String(err.stack) : '',
              payload
            });
        } catch (loggingError) {
          // ignore logging issues
        }
      }

      function makeCid() {
        return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 8)}`;
      }

      function makeClientRequestId(type) {
        return `${initialSessionEmail || 'user'}-${type}-${makeCid()}`;
      }
    })();
  </script>
</body>
</html>

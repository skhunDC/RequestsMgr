<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Request Manager</title>
  <style>
    :root {
      color-scheme: light;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --surface: #ffffff;
      --surface-alt: #f5f6f8;
      --border: #d7dce1;
      --text: #202731;
      --muted: #5c6774;
      --accent: #0b57d0;
      --accent-strong: #0a47ac;
      --success: #0f9d58;
      --danger: #d93025;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--surface-alt);
      color: var(--text);
      font-size: clamp(16px, 4.6vw, 19px);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    header {
      padding: clamp(1.25rem, 6vw, 1.75rem) clamp(1rem, 6vw, 2.25rem) clamp(0.75rem, 4vw, 1.25rem);
      display: flex;
      flex-direction: column;
      gap: clamp(1rem, 5vw, 1.75rem);
      align-items: stretch;
    }

    header .hero-inner {
      width: min(100%, 1080px);
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: clamp(1.25rem, 5vw, 2rem);
      align-items: stretch;
    }

    .hero-dashboard {
      background: var(--surface);
      border-radius: 16px;
      border: 1px solid rgba(14, 31, 53, 0.08);
      padding: clamp(1rem, 4vw, 1.65rem);
      box-shadow: 0 12px 24px -18px rgba(13, 34, 78, 0.35);
      display: flex;
      flex-direction: column;
      gap: clamp(1rem, 4vw, 1.75rem);
      width: clamp(280px, 92vw, 900px);
      margin: 0 auto;
      background-image: radial-gradient(circle at top left, rgba(11, 87, 208, 0.12), transparent 55%),
        radial-gradient(circle at bottom right, rgba(15, 157, 88, 0.1), transparent 60%);
    }

    .dashboard-identity {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      flex-wrap: wrap;
      gap: clamp(0.85rem, 4vw, 1.75rem);
    }

    .dashboard-identity .dashboard-logo {
      width: clamp(88px, 22vw, 132px);
      height: auto;
      flex: 0 0 auto;
    }

    .dashboard-identity-copy {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      min-width: min(240px, 100%);
    }

    .dashboard-identity h1 {
      margin: 0;
      font-size: clamp(1.55rem, 4.8vw, 2.25rem);
      font-weight: 600;
    }

    .dashboard-identity p {
      margin: 0;
      color: var(--muted);
      font-size: clamp(1rem, 3.8vw, 1.1rem);
      max-width: 40rem;
    }

    .hero-dashboard header,
    .hero-dashboard .dashboard-header {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .hero-dashboard h2 {
      margin: 0;
      font-size: clamp(1.1rem, 3.7vw, 1.4rem);
      font-weight: 600;
    }

    .hero-dashboard .dashboard-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem clamp(0.75rem, 3vw, 1.5rem);
      font-size: clamp(0.95rem, 3.4vw, 1.05rem);
    }

    .hero-dashboard .dashboard-summary span {
      display: flex;
      align-items: baseline;
      gap: 0.35rem;
      color: var(--muted);
    }

    .hero-dashboard .dashboard-summary strong {
      font-size: clamp(1.2rem, 4vw, 1.4rem);
      color: var(--text);
    }

    .dashboard-body {
      display: grid;
      gap: clamp(1rem, 4vw, 1.5rem);
    }

    .dashboard-grid {
      display: grid;
      gap: clamp(0.75rem, 3vw, 1.25rem);
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    .dashboard-card {
      border: 1px solid rgba(14, 31, 53, 0.06);
      border-radius: 14px;
      padding: clamp(0.85rem, 3.5vw, 1.1rem);
      background: var(--surface-alt);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .dashboard-card h3 {
      margin: 0;
      font-size: clamp(1.05rem, 3.4vw, 1.25rem);
      font-weight: 600;
    }

    .dashboard-card .metric-group {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .dashboard-card .metric {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      color: var(--muted);
      font-size: clamp(0.85rem, 3vw, 0.95rem);
    }

    .dashboard-card .metric strong {
      font-size: clamp(1.4rem, 4.8vw, 1.8rem);
      font-weight: 600;
      color: var(--text);
    }

    .dashboard-card .metric.highlight strong {
      color: var(--accent);
    }

    .dashboard-visual {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
    }

    .dashboard-visual canvas {
      width: min(220px, 100%);
      height: auto;
      aspect-ratio: 1 / 1;
    }

    .dashboard-legend {
      width: 100%;
      display: grid;
      gap: 0.5rem;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: clamp(0.85rem, 3vw, 0.95rem);
      color: var(--muted);
    }

    .legend-item .swatch {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      display: inline-flex;
    }

    .legend-item .swatch[data-type="supplies"] {
      background: var(--accent);
    }

    .legend-item .swatch[data-type="it"] {
      background: var(--success);
    }

    .legend-item .swatch[data-type="maintenance"] {
      background: #f29900;
    }

    .legend-item strong,
    .legend-item .legend-value {
      color: var(--text);
      font-weight: 600;
    }

    .dashboard-empty {
      margin: 0;
      color: var(--muted);
      font-size: clamp(0.9rem, 3.2vw, 1rem);
    }

    nav.tab-nav {
      display: flex;
      gap: 0.35rem;
      padding: 0 clamp(0.75rem, 6vw, 1.35rem) clamp(0.75rem, 4vw, 1rem);
      overflow-x: auto;
      scrollbar-width: none;
      width: min(100%, 1080px);
      margin: 0 auto;
    }

    nav.tab-nav::-webkit-scrollbar {
      display: none;
    }

    main {
      padding: 0 clamp(0.75rem, 6vw, 2rem) 2.5rem;
      width: min(100%, 720px);
      margin: 0 auto;
    }

    .tab-panel {
      display: none;
      flex-direction: column;
      gap: 1.25rem;
    }

    .tab-panel.active {
      display: flex;
    }

    .notice {
      width: min(100%, 720px);
      margin: 0 auto clamp(0.75rem, 4vw, 1.2rem);
      padding: clamp(0.85rem, 4vw, 1.2rem);
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(11, 87, 208, 0.08);
      color: inherit;
      font-size: clamp(1rem, 3.6vw, 1.1rem);
    }

    .notice[hidden] {
      display: none !important;
    }

    .notice[data-variant="warning"] {
      border-color: rgba(217, 48, 37, 0.35);
      background: rgba(217, 48, 37, 0.08);
    }

    .notice[data-variant="info"] {
      border-color: rgba(11, 87, 208, 0.35);
      background: rgba(11, 87, 208, 0.08);
    }

    .notice strong {
      display: block;
      font-weight: 600;
      margin-bottom: 0.35rem;
    }

    .notice p {
      margin: 0;
    }

    .notice p + p {
      margin-top: 0.35rem;
    }

    .approver-notice {
      margin-top: 0.75rem;
      padding: clamp(0.75rem, 3.6vw, 1rem);
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(11, 87, 208, 0.08);
      font-size: clamp(0.95rem, 3.4vw, 1.05rem);
      color: inherit;
    }

    .form-grid .approver-notice {
      width: 100%;
      grid-column: 1 / -1;
      justify-self: stretch;
    }
    .approver-notice[hidden] {
      display: none !important;
    }

    .approver-notice[data-variant="warning"] {
      border-color: rgba(217, 48, 37, 0.35);
      background: rgba(217, 48, 37, 0.08);
    }

    .approver-notice strong {
      display: block;
      font-weight: 600;
      margin-bottom: 0.35rem;
    }

    .approver-notice p {
      margin: 0;
      color: inherit;
    }

    .approver-notice p + p {
      margin-top: 0.35rem;
    }

    section.card {
      background: var(--surface);
      border-radius: 16px;
      padding: clamp(1.1rem, 5.8vw, 1.65rem);
      box-shadow: 0 12px 24px -18px rgba(23, 32, 42, 0.3);
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    h2 {
      margin: 0;
      font-size: clamp(1.2rem, 4vw, 1.45rem);
      font-weight: 600;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      width: 100%;
      text-align: left;
      color: inherit;
      user-select: none;
    }

    .card-header-text {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .card-title {
      font-size: clamp(1.2rem, 4.4vw, 1.5rem);
      font-weight: 600;
    }

    .card-subtitle {
      font-size: clamp(1rem, 3.7vw, 1.1rem);
      color: var(--muted);
    }

    .card-body {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }

    .form-grid {
      display: grid;
      gap: 0.75rem;
    }

    @media (min-width: 560px) {
      .form-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        align-items: end;
      }

      .form-grid textarea,
      .form-grid .full-width {
        grid-column: 1 / -1;
      }
    }

    label span {
      display: block;
      font-size: clamp(1rem, 3.8vw, 1.15rem);
      font-weight: 600;
      margin-bottom: 0.45rem;
    }

    input[type="number"],
    input[type="text"],
    input[type="search"],
    input[type="date"],
    textarea,
    select,
    button {
      font: inherit;
    }

    textarea,
    input[type="number"],
    input[type="text"],
    input[type="search"],
    input[type="date"],
    select {
      width: 100%;
      padding: 0.75rem 0.85rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--surface-alt);
      color: inherit;
      min-height: 48px;
      font-size: clamp(1.05rem, 4vw, 1.2rem);
    }

    textarea:focus,
    input[type="number"]:focus,
    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus,
    button:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    textarea {
      resize: vertical;
      min-height: 96px;
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 999px;
      padding: 0.8rem 1.35rem;
      font-weight: 600;
      background: var(--accent);
      color: #fff;
      min-height: 48px;
      transition: background 0.2s ease;
      font-size: clamp(1.05rem, 4vw, 1.2rem);
    }

    button[disabled] {
      opacity: 0.65;
      cursor: not-allowed;
    }

    button:not([disabled]):hover {
      background: var(--accent-strong);
    }

    button.secondary {
      background: var(--surface-alt);
      color: var(--accent);
      border: 1px solid var(--border);
    }

    button.secondary:hover:not([disabled]) {
      background: #e9eef7;
    }

    .tab-nav button {
      flex: 1 1 0;
      min-width: 0;
      padding: 0.65rem 1rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--muted);
      font-weight: 600;
      font-size: clamp(0.95rem, 3.5vw, 1.05rem);
      text-align: center;
    }

    .tab-nav button:not(.active):hover {
      background: #eef2f9;
    }

    .tab-nav button.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .inline-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .inline-buttons button.secondary.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .inline-buttons button.secondary.active:hover:not([disabled]) {
      background: var(--accent-strong);
    }

    .notice-block {
      border-radius: 12px;
      border: 1px solid rgba(11, 87, 208, 0.25);
      background: rgba(11, 87, 208, 0.08);
      padding: 1rem 1.15rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .notice-block h3 {
      margin: 0;
      font-size: clamp(1.05rem, 3.8vw, 1.2rem);
      font-weight: 600;
      color: var(--accent-strong);
    }

    .notice-block p {
      margin: 0;
      color: var(--muted);
      font-size: clamp(0.95rem, 3.6vw, 1.05rem);
    }

    .skeleton {
      position: relative;
      overflow: hidden;
      background: linear-gradient(90deg, #e4e8ee 25%, #f2f4f8 37%, #e4e8ee 63%);
      background-size: 400% 100%;
      animation: shimmer 1.4s ease infinite;
      border-radius: 12px;
      min-height: 44px;
    }

    .skeleton.sm {
      height: 18px;
      border-radius: 6px;
    }

    @keyframes shimmer {
      0% {
        background-position: 100% 0;
      }
      100% {
        background-position: -100% 0;
      }
    }

    .request-item,
    .catalog-item {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      padding: 0.85rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface-alt);
    }

    .request-item {
      background: var(--surface);
      border-radius: 14px;
      padding: 0.7rem 0.85rem;
      gap: 0.4rem;
      line-height: 1.45;
    }

    .request-item-head {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.4rem;
    }

    .request-item-title {
      font-size: clamp(1rem, 3.6vw, 1.15rem);
      font-weight: 600;
      flex: 1 1 160px;
      display: inline-flex;
    }

    .request-item .status {
      margin-left: auto;
      font-size: clamp(0.85rem, 2.9vw, 0.95rem);
      padding: 0.3rem 0.65rem;
    }

    .request-item .urgency-badge {
      margin-left: 0;
      font-size: clamp(0.75rem, 2.8vw, 0.9rem);
      padding: 0.25rem 0.6rem;
    }

    .request-item-info {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem 0.75rem;
      align-items: center;
    }

    .request-item-info .meta,
    .request-item-info .detail-line {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: clamp(0.85rem, 3vw, 0.95rem);
      color: var(--muted);
      padding: 0.1rem 0;
    }

    .request-item-footer {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem 0.75rem;
      align-items: center;
      margin-top: 0.2rem;
    }

    .request-item-footer > .inline-buttons,
    .request-item-footer > .supplies-actions {
      flex: 1 1 100%;
    }

    .request-item-footer .supplies-actions {
      margin-top: 0;
    }

    .request-item-footer .supplies-actions .inline-buttons {
      gap: 0.5rem;
    }

    .request-item .eta-field {
      margin: 0;
      flex-direction: row;
      align-items: center;
      gap: 0.4rem;
      max-width: none;
    }

    .request-item .eta-field span {
      font-size: clamp(0.85rem, 2.9vw, 0.95rem);
    }

    .request-item .eta-field input[type="date"] {
      width: auto;
      min-width: 0;
    }

    .catalog-field {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .catalog-combobox {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .catalog-search {
      position: relative;
    }

    .catalog-search::after {
      content: '\1F50D';
      position: absolute;
      right: 3.15rem;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: var(--muted);
      font-size: 1rem;
    }

    .catalog-search input[type="search"] {
      padding-right: 4.75rem;
      -webkit-appearance: none;
    }

    .catalog-clear {
      position: absolute;
      top: 50%;
      right: 0.65rem;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: none;
      background: rgba(32, 39, 49, 0.08);
      color: var(--text);
      font-size: 1.35rem;
      font-weight: 700;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease, transform 0.15s ease, background 0.15s ease;
    }

    .catalog-clear.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .catalog-clear:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .catalog-clear:hover {
      background: rgba(32, 39, 49, 0.14);
      transform: translateY(-50%) scale(1.05);
    }

    datalist option {
      font-size: clamp(1rem, 3.5vw, 1.1rem);
    }

    .input-helper {
      margin-top: 0.35rem;
      font-size: clamp(0.95rem, 3.3vw, 1.05rem);
      color: var(--muted);
      display: block;
    }

    .input-helper.custom-item-alert {
      margin-top: 0.75rem;
      margin-bottom: 0.25rem;
      font-size: clamp(1rem, 3.6vw, 1.1rem);
      font-weight: 700;
      color: var(--danger);
    }

    .urgency-badge {
      display: inline-flex;
      align-items: center;
      font-size: clamp(0.85rem, 3vw, 0.95rem);
      font-weight: 600;
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      border: 1px solid transparent;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .urgency-badge + .urgency-badge {
      margin-left: 0.35rem;
    }

    .urgency-badge[data-urgency="low"] {
      background: rgba(15, 157, 88, 0.12);
      border-color: rgba(15, 157, 88, 0.35);
      color: var(--success);
    }

    .urgency-badge[data-urgency="normal"] {
      background: rgba(251, 188, 5, 0.16);
      border-color: rgba(251, 188, 5, 0.4);
      color: #8c6d00;
    }

    .urgency-badge[data-urgency="critical"] {
      background: rgba(217, 48, 37, 0.12);
      border-color: rgba(217, 48, 37, 0.35);
      color: var(--danger);
    }

    .catalog-item.selected {
      border-color: rgba(11, 87, 208, 0.4);
      background: rgba(11, 87, 208, 0.08);
    }

    .catalog-item strong {
      font-size: clamp(1.05rem, 3.8vw, 1.2rem);
    }

    .catalog-item .meta + .meta {
      margin-top: -0.1rem;
    }

    .catalog-item .meta.usage {
      color: var(--accent-strong);
      font-weight: 500;
    }

    .catalog-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      align-self: flex-start;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(11, 87, 208, 0.12);
      color: var(--accent-strong);
      font-size: clamp(0.75rem, 2.9vw, 0.9rem);
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .catalog-badge::before {
      content: '\2605';
      font-size: 0.8rem;
    }

    .meta {
      font-size: clamp(0.95rem, 3.2vw, 1.05rem);
      color: var(--muted);
    }

    .detail-line {
      display: block;
      font-size: clamp(0.95rem, 3.4vw, 1.05rem);
      color: var(--muted);
    }

    .eta-field {
      margin-top: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      max-width: 220px;
    }

    .eta-field span {
      font-size: clamp(0.9rem, 3.2vw, 1rem);
      font-weight: 600;
    }

    @media (max-width: 520px) {
      header {
        padding: clamp(1.35rem, 6vw, 1.75rem) clamp(1.1rem, 7vw, 1.65rem) clamp(0.85rem, 5vw, 1.35rem);
      }

      nav.tab-nav {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 0.35rem;
        padding: 0 clamp(0.75rem, 6vw, 1rem) clamp(0.75rem, 4vw, 0.9rem);
        overflow: visible;
      }

      .tab-nav button {
        width: 100%;
        padding: 0.65rem 0.75rem;
      }

      main {
        padding: 0 clamp(0.85rem, 6vw, 1.15rem) 2.15rem;
        width: min(100%, 640px);
      }

      section.card {
        border-radius: 20px;
        padding: clamp(1.15rem, 6.5vw, 1.75rem);
      }

      .catalog-clear {
        width: 34px;
        height: 34px;
      }
    }

    @media (max-width: 360px) {
      button {
        padding-inline: 1.1rem;
      }

      .tab-nav button {
        padding-inline: 0.7rem;
      }
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: clamp(0.95rem, 3.2vw, 1.05rem);
      font-weight: 600;
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      background: var(--surface);
      border: 1px solid var(--border);
    }

    .status[data-state="approved"] {
      border-color: rgba(15, 157, 88, 0.35);
      color: var(--success);
    }

    .status[data-state="completed"] {
      border-color: rgba(15, 157, 88, 0.35);
      color: var(--success);
    }

    .status[data-state="in_progress"],
    .status[data-state="ordered"] {
      border-color: rgba(11, 87, 208, 0.35);
      color: var(--accent);
    }

    .status[data-state="declined"],
    .status[data-state="denied"] {
      border-color: rgba(217, 48, 37, 0.35);
      color: var(--danger);
    }

    .supplies-actions {
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      margin-top: 0.5rem;
    }

    .supplies-actions .inline-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }

    .supplies-actions .inline-buttons button {
      width: 100%;
    }

    .empty {
      text-align: center;
      color: var(--muted);
      padding: 0.75rem 0;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .load-more {
      align-self: center;
    }

    #toast {
      position: fixed;
      left: 50%;
      bottom: 1.25rem;
      transform: translateX(-50%);
      background: rgba(32, 39, 49, 0.94);
      color: #fff;
      padding: 0.75rem 1.25rem;
      border-radius: 999px;
      box-shadow: 0 20px 35px -25px rgba(23, 32, 42, 0.8);
      display: none;
      z-index: 20;
      min-width: 200px;
      text-align: center;
    }

    @media (prefers-reduced-motion: reduce) {
      .skeleton {
        animation: none;
      }
    }

    @media (min-width: 600px) {
      body {
        font-size: 17px;
      }

      .tab-panel {
        gap: 1.5rem;
      }

      nav.tab-nav {
        justify-content: center;
      }
    }

    @media (min-width: 720px) {
      main {
        width: min(100%, 900px);
      }

      header {
        padding-bottom: clamp(1.5rem, 4vw, 2.5rem);
      }

      header .hero-inner {
        align-items: stretch;
        justify-content: center;
      }

      .hero-dashboard {
        width: clamp(360px, 78vw, 960px);
      }

      .dashboard-identity {
        flex-wrap: nowrap;
      }

      .dashboard-identity-copy {
        min-width: 0;
      }
    }

    @media (min-width: 1200px) {
      main {
        width: min(100%, 1080px);
      }

      .tab-panel.active {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
        align-items: stretch;
      }

      .tab-panel.active section.card {
        height: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="hero-inner">
      <section
        class="hero-dashboard"
        id="heroDashboard"
        aria-label="Request activity dashboard"
        aria-live="polite"
      >
        <div class="dashboard-identity">
          <img
            class="dashboard-logo"
            src="https://www.dublincleaners.com/wp-content/uploads/2024/12/Dublin-Logos-stacked.png"
            alt="Dublin Cleaners logo"
            loading="lazy"
            decoding="async"
            width="150"
          >
          <div class="dashboard-identity-copy">
            <h1>Request Manager</h1>
            <p>Submit and track Supplies, Technology, and Maintenance needs from one Workspace.</p>
          </div>
        </div>
        <div class="dashboard-header">
          <h2>Live request dashboard</h2>
          <div class="dashboard-summary">
            <span>
              <strong data-dashboard-total="all">—</strong>
              total requests
            </span>
            <span>
              <strong data-dashboard-outstanding="all">—</strong>
              awaiting approval/completion
            </span>
          </div>
          <p class="meta" id="dashboardUpdatedAt">Awaiting data…</p>
        </div>
        <div class="dashboard-body">
          <div class="dashboard-grid">
            <article class="dashboard-card" data-dashboard-card="supplies">
              <h3>Supplies</h3>
              <div class="metric-group">
                <span class="metric">
                  <strong data-dashboard-total="supplies">—</strong>
                  Total requests
                </span>
                <span class="metric highlight">
                  <strong data-dashboard-outstanding="supplies">—</strong>
                  Awaiting approval/completion
                </span>
              </div>
            </article>
            <article class="dashboard-card" data-dashboard-card="it">
              <h3>IT</h3>
              <div class="metric-group">
                <span class="metric">
                  <strong data-dashboard-total="it">—</strong>
                  Total requests
                </span>
                <span class="metric highlight">
                  <strong data-dashboard-outstanding="it">—</strong>
                  Awaiting approval/completion
                </span>
              </div>
            </article>
            <article class="dashboard-card" data-dashboard-card="maintenance">
              <h3>Maintenance</h3>
              <div class="metric-group">
                <span class="metric">
                  <strong data-dashboard-total="maintenance">—</strong>
                  Total requests
                </span>
                <span class="metric highlight">
                  <strong data-dashboard-outstanding="maintenance">—</strong>
                  Awaiting approval/completion
                </span>
              </div>
            </article>
          </div>
          <div class="dashboard-visual">
            <canvas id="dashboardPie" width="220" height="220" role="img" aria-label="Outstanding requests by type"></canvas>
            <div class="dashboard-legend">
              <div class="legend-item" data-dashboard-legend="supplies">
                <span class="swatch" data-type="supplies"></span>
                <span>Supplies</span>
                <span class="legend-value" data-dashboard-outstanding-legend="supplies">—</span>
              </div>
              <div class="legend-item" data-dashboard-legend="it">
                <span class="swatch" data-type="it"></span>
                <span>IT</span>
                <span class="legend-value" data-dashboard-outstanding-legend="it">—</span>
              </div>
              <div class="legend-item" data-dashboard-legend="maintenance">
                <span class="swatch" data-type="maintenance"></span>
                <span>Maintenance</span>
                <span class="legend-value" data-dashboard-outstanding-legend="maintenance">—</span>
              </div>
            </div>
          </div>
        </div>
        <p class="dashboard-empty" id="dashboardEmptyMessage" hidden>No requests yet.</p>
      </section>
    </div>
  </header>
  <nav class="tab-nav" aria-label="Request types">
    <button type="button" data-tab-trigger="supplies" class="active">Supplies</button>
    <button type="button" data-tab-trigger="it">IT</button>
    <button type="button" data-tab-trigger="maintenance">Maintenance</button>
  </nav>
  <div id="statusAuthNotice" class="notice" hidden></div>
  <main>
    <div class="tab-panel active" data-tab-panel="supplies">
      <section class="card" id="suppliesFormCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">New supplies request</span>
            <span class="card-subtitle meta">Use the catalog to quickly fill in the item details before submitting.</span>
          </div>
        </div>
        <div class="card-body">
          <form id="suppliesForm" class="form-grid" novalidate>
            <label class="full-width">
              <span>Catalog item</span>
              <div class="catalog-field">
                <div class="catalog-combobox" role="group" aria-label="Catalog search">
                  <div class="catalog-search">
                    <input
                      id="catalogSearch"
                      type="search"
                      name="catalogSearch"
                      placeholder="Search by name, category, or SKU"
                      autocomplete="off"
                      spellcheck="false"
                      list="catalogOptions"
                      aria-autocomplete="list"
                    >
                    <button type="button" id="catalogClearButton" class="catalog-clear" aria-label="Clear selected catalog item">×</button>
                    <datalist id="catalogOptions"></datalist>
                  </div>
                </div>
                <input id="catalogSkuField" name="catalogSku" type="hidden">
              </div>
              <span class="input-helper custom-item-alert">Can't find it? Enter a Custom Item below.</span>
            </label>
            <label class="full-width">
              <span>Item name</span>
              <input
                id="suppliesDescription"
                name="description"
                type="text"
                placeholder="e.g., 2XL rubber gloves"
                autocomplete="off"
                required
              >
            </label>
            <label class="full-width requester-name-field" data-name-field="supplies">
              <span>Your name</span>
              <input id="suppliesRequesterName" name="requesterName" type="text" autocomplete="name">
            </label>
            <label>
              <span>Location</span>
              <select id="suppliesLocation" name="location" required>
                <option value="">Select a location</option>
                <option value="Plant">Plant</option>
                <option value="Short North">Short North</option>
                <option value="South Dublin">South Dublin</option>
                <option value="Muirfield">Muirfield</option>
                <option value="Morse Rd.">Morse Rd.</option>
                <option value="Granville">Granville</option>
                <option value="Newark">Newark</option>
              </select>
            </label>
            <label>
              <span>Quantity</span>
              <input id="suppliesQty" name="qty" type="number" min="1" step="1" required>
            </label>
            <label class="full-width">
              <span>Notes (optional)</span>
              <textarea id="suppliesNotes" name="notes" autocomplete="off"></textarea>
            </label>
          <div class="inline-buttons full-width">
            <button type="submit" id="suppliesSubmitButton">Submit request</button>
            <button type="button" id="suppliesResetButton" class="secondary">Reset</button>
          </div>
          <div
            class="approver-notice"
            data-approver-notice="supplies"
            role="alert"
            hidden
          ></div>
        </form>
        <aside class="notice-block" role="note" aria-label="Supply request approval process">
          <h3>Supply request approvals</h3>
          <p>All supply requests must first be approved by a Manager. Approved orders will be placed once per week, every Monday Morning.</p>
          <p>If your request is missed, it will roll into the following week’s order. This process helps us stay efficient and keep operations running smoothly.</p>
        </aside>
      </div>
    </section>

      <section class="card" id="suppliesRequestsCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">Supplies requests</span>
            <span class="card-subtitle meta">Track order status and approvals in one place.</span>
          </div>
        </div>
        <div class="card-body">
          <div id="suppliesRequestsList" class="list" role="list"></div>
          <button type="button" id="suppliesMoreButton" class="load-more secondary">Load more</button>
        </div>
      </section>

      <section class="card" id="catalogCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">Catalog</span>
            <span class="card-subtitle meta">Tap an item to autofill the request form.</span>
          </div>
        </div>
        <div class="card-body">
          <div id="catalogList" class="list" role="list"></div>
          <button type="button" id="catalogMoreButton" class="load-more secondary">Load more</button>
        </div>
      </section>
    </div>

    <div class="tab-panel" data-tab-panel="it">
      <section class="card" id="itFormCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">New IT request</span>
            <span class="card-subtitle meta">Report technology issues or access needs for quick routing.</span>
          </div>
        </div>
        <div class="card-body">
          <form id="itForm" class="form-grid" novalidate>
            <label>
              <span>Location</span>
              <select id="itLocation" name="location" required>
                <option value="">Select a location</option>
                <option value="Plant">Plant</option>
                <option value="Short North">Short North</option>
                <option value="South Dublin">South Dublin</option>
                <option value="Muirfield">Muirfield</option>
                <option value="Morse Rd.">Morse Rd.</option>
                <option value="Granville">Granville</option>
                <option value="Newark">Newark</option>
              </select>
            </label>
            <label class="full-width requester-name-field" data-name-field="it">
              <span>Your name</span>
              <input id="itRequesterName" name="requesterName" type="text" autocomplete="name">
            </label>
            <label class="full-width">
              <span>Issue summary</span>
              <textarea id="itIssue" name="issue" autocomplete="off" required></textarea>
            </label>
            <label>
              <span>Device or system</span>
              <input id="itDevice" name="device" type="text" autocomplete="off">
            </label>
            <label>
              <span>Urgency</span>
              <select id="itUrgency" name="urgency">
                <option value="low">Low</option>
                <option value="normal">Normal</option>
                <option value="critical">Critical</option>
              </select>
            </label>
            <label class="full-width">
              <span>Additional details</span>
              <textarea id="itDetails" name="details" autocomplete="off"></textarea>
            </label>
            <div class="inline-buttons full-width">
              <button type="submit" id="itSubmitButton">Submit request</button>
              <button type="button" id="itResetButton" class="secondary">Reset</button>
            </div>
            <div
              class="approver-notice"
              data-approver-notice="it"
              role="alert"
              hidden
            ></div>
          </form>
        </div>
      </section>

      <section class="card" id="itRequestsCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">IT queue</span>
            <span class="card-subtitle meta">Monitor progress and close items when resolved.</span>
          </div>
        </div>
        <div class="card-body">
          <div id="itRequestsList" class="list" role="list"></div>
          <button type="button" id="itMoreButton" class="load-more secondary">Load more</button>
        </div>
      </section>
    </div>

    <div class="tab-panel" data-tab-panel="maintenance">
      <section class="card" id="maintenanceFormCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">New maintenance request</span>
            <span class="card-subtitle meta">Share location details so facilities can prioritize the work.</span>
          </div>
        </div>
        <div class="card-body">
          <form id="maintenanceForm" class="form-grid" novalidate>
            <label>
              <span>Location</span>
              <select id="maintenanceLocation" name="location" required>
                <option value="">Select a location</option>
                <option value="Plant">Plant</option>
                <option value="Short North">Short North</option>
                <option value="South Dublin">South Dublin</option>
                <option value="Muirfield">Muirfield</option>
                <option value="Morse Rd.">Morse Rd.</option>
                <option value="Granville">Granville</option>
                <option value="Newark">Newark</option>
              </select>
            </label>
            <label class="full-width requester-name-field" data-name-field="maintenance">
              <span>Your name</span>
              <input id="maintenanceRequesterName" name="requesterName" type="text" autocomplete="name">
            </label>
            <label class="full-width">
              <span>Issue description</span>
              <textarea id="maintenanceIssue" name="issue" autocomplete="off" required></textarea>
            </label>
            <label>
              <span>Urgency</span>
              <select id="maintenanceUrgency" name="urgency">
                <option value="low">Low</option>
                <option value="normal">Normal</option>
                <option value="critical">Critical</option>
              </select>
            </label>
            <label class="full-width">
              <span>Access notes (optional)</span>
              <textarea id="maintenanceAccessNotes" name="accessNotes" autocomplete="off"></textarea>
            </label>
            <div class="inline-buttons full-width">
              <button type="submit" id="maintenanceSubmitButton">Submit request</button>
              <button type="button" id="maintenanceResetButton" class="secondary">Reset</button>
            </div>
            <div
              class="approver-notice"
              data-approver-notice="maintenance"
              role="alert"
              hidden
            ></div>
          </form>
        </div>
      </section>

      <section class="card" id="maintenanceRequestsCard">
        <div class="card-header">
          <div class="card-header-text">
            <span class="card-title">Maintenance pipeline</span>
            <span class="card-subtitle meta">See outstanding work orders and update when finished.</span>
          </div>
        </div>
        <div class="card-body">
          <div id="maintenanceRequestsList" class="list" role="list"></div>
          <button type="button" id="maintenanceMoreButton" class="load-more secondary">Load more</button>
        </div>
      </section>
    </div>
  </main>
  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    const SESSION = <?!= JSON.stringify(session) ?>;
  </script>
  <script>
    (function () {
      const hasServer = typeof google !== 'undefined' && google.script && google.script.run;
      const server = hasServer ? google.script.run : null;
      const REQUEST_KEYS = ['supplies', 'it', 'maintenance'];
      const DASHBOARD_COLORS = {
        supplies: '#0b57d0',
        it: '#0f9d58',
        maintenance: '#f29900'
      };
      const DASHBOARD_REFRESH_INTERVAL = 60000;
      const DASHBOARD_DEBOUNCE = 500;
      const PERSIST_DELAY = 240;
      const persistTimers = {};
      let warmScheduled = false;
      let syncingCatalogToDescription = false;
      let dashboardAutoRefreshId = null;
      let dashboardDeferredRefreshId = null;
      const FORM_TEMPLATES = {
        supplies: { description: '', qty: 1, notes: '', catalogSku: '', location: '', requesterName: '' },
        it: { location: '', issue: '', device: '', urgency: 'normal', details: '', requesterName: '' },
        maintenance: { location: '', issue: '', urgency: 'normal', accessNotes: '', requesterName: '' }
      };
      const LOCAL_KEYS = {
        supplies: 'request-manager:supplies',
        it: 'request-manager:it',
        maintenance: 'request-manager:maintenance'
      };
      const EMPTY_REQUEST_MESSAGES = {
        supplies: 'No supplies requests are pending right now.',
        it: 'No IT tickets are in the queue right now.',
        maintenance: 'No maintenance work orders are pending right now.'
      };

      const state = {
        activeTab: 'supplies',
        forms: {
          supplies: Object.assign({}, FORM_TEMPLATES.supplies),
          it: Object.assign({}, FORM_TEMPLATES.it),
          maintenance: Object.assign({}, FORM_TEMPLATES.maintenance)
        },
        requesterName: '',
        requests: {
          supplies: [],
          it: [],
          maintenance: []
        },
        nextTokens: {
          supplies: '',
          it: '',
          maintenance: ''
        },
        loading: {
          supplies: false,
          it: false,
          maintenance: false
        },
        loaded: {
          supplies: false,
          it: false,
          maintenance: false
        },
        catalog: {
          items: [],
          nextToken: '',
          loading: false,
          search: '',
          fullyLoaded: false
        },
        dashboard: {
          loading: false,
          metrics: makeEmptyDashboardMetrics(),
          totals: {
            totalRequests: 0,
            outstandingRequests: 0
          },
          generatedAt: ''
        }
      };

      const dom = {
        tabButtons: Array.from(document.querySelectorAll('[data-tab-trigger]')),
        panels: Array.from(document.querySelectorAll('[data-tab-panel]')),
        statusNotice: document.getElementById('statusAuthNotice'),
        toast: document.getElementById('toast'),
        supplies: {
          form: document.getElementById('suppliesForm'),
          location: document.getElementById('suppliesLocation'),
          qty: document.getElementById('suppliesQty'),
          notes: document.getElementById('suppliesNotes'),
          description: document.getElementById('suppliesDescription'),
          requesterName: document.getElementById('suppliesRequesterName'),
          requesterNameRow: document.querySelector('[data-name-field="supplies"]'),
          submit: document.getElementById('suppliesSubmitButton'),
          reset: document.getElementById('suppliesResetButton'),
          list: document.getElementById('suppliesRequestsList'),
          more: document.getElementById('suppliesMoreButton'),
          catalogSearch: document.getElementById('catalogSearch'),
          catalogOptions: document.getElementById('catalogOptions'),
          catalogSku: document.getElementById('catalogSkuField'),
          catalogList: document.getElementById('catalogList'),
          catalogMore: document.getElementById('catalogMoreButton'),
          catalogClear: document.getElementById('catalogClearButton'),
          approverNotice: document.querySelector('[data-approver-notice="supplies"]')
        },
        it: {
          form: document.getElementById('itForm'),
          location: document.getElementById('itLocation'),
          issue: document.getElementById('itIssue'),
          device: document.getElementById('itDevice'),
          urgency: document.getElementById('itUrgency'),
          details: document.getElementById('itDetails'),
          requesterName: document.getElementById('itRequesterName'),
          requesterNameRow: document.querySelector('[data-name-field="it"]'),
          submit: document.getElementById('itSubmitButton'),
          reset: document.getElementById('itResetButton'),
          list: document.getElementById('itRequestsList'),
          more: document.getElementById('itMoreButton'),
          approverNotice: document.querySelector('[data-approver-notice="it"]')
        },
        maintenance: {
          form: document.getElementById('maintenanceForm'),
          location: document.getElementById('maintenanceLocation'),
          issue: document.getElementById('maintenanceIssue'),
          urgency: document.getElementById('maintenanceUrgency'),
          accessNotes: document.getElementById('maintenanceAccessNotes'),
          requesterName: document.getElementById('maintenanceRequesterName'),
          requesterNameRow: document.querySelector('[data-name-field="maintenance"]'),
          submit: document.getElementById('maintenanceSubmitButton'),
          reset: document.getElementById('maintenanceResetButton'),
          list: document.getElementById('maintenanceRequestsList'),
          more: document.getElementById('maintenanceMoreButton'),
          approverNotice: document.querySelector('[data-approver-notice="maintenance"]')
        },
        dashboard: {
          container: document.getElementById('heroDashboard'),
          updatedAt: document.getElementById('dashboardUpdatedAt'),
          empty: document.getElementById('dashboardEmptyMessage'),
          pie: document.getElementById('dashboardPie'),
          metrics: REQUEST_KEYS.reduce((acc, type) => {
            acc[type] = {
              total: document.querySelector(`[data-dashboard-total="${type}"]`),
              outstanding: document.querySelector(`[data-dashboard-outstanding="${type}"]`),
              legend: document.querySelector(`[data-dashboard-outstanding-legend="${type}"]`)
            };
            return acc;
          }, {}),
          overall: {
            total: document.querySelector('[data-dashboard-total="all"]'),
            outstanding: document.querySelector('[data-dashboard-outstanding="all"]')
          }
        }
      };

      const initialSessionEmail = SESSION && SESSION.email ? String(SESSION.email) : '';
      const canManageStatuses = Boolean(SESSION && SESSION.canManageStatuses);
      const requiresRequesterName = !initialSessionEmail;
      const statusAuth = SESSION && SESSION.statusAuth ? SESSION.statusAuth : null;

      renderStatusAuthNotice(statusAuth);
      configureRequesterNameRequirement();
      attachNavHandlers();
      attachFormHandlers();
      REQUEST_KEYS.forEach(type => {
        hydrateFormFromCache(type);
      });
      initializeRequesterName();
      REQUEST_KEYS.forEach(type => {
        renderForm(type);
      });
      setActiveTab(state.activeTab);
      renderDashboard();
      if (hasServer) {
        loadDashboardMetrics({ silent: false });
        startDashboardAutoRefresh();
        loadCatalog({ append: false, fetchAll: true });
        ensureRequestsLoaded('supplies');
      } else {
        renderCatalog();
        REQUEST_KEYS.forEach(type => {
          state.loaded[type] = true;
          renderRequests(type);
        });
        showDashboardOfflineMessage();
      }

      function loadDashboardMetrics(options) {
        if (!server) {
          state.dashboard.loading = false;
          renderDashboard();
          return;
        }
        const silent = Boolean(options && options.silent);
        if (!silent) {
          state.dashboard.loading = true;
          renderDashboard();
        }
        const payload = { cid: makeCid() };
        server
          .withSuccessHandler(response => {
            state.dashboard.loading = false;
            if (!response || !response.ok) {
              if (!silent) {
                handleError(response, 'getDashboardMetrics', payload);
              } else {
                console.error('[RequestManager]', 'getDashboardMetrics', response);
              }
              return;
            }
            const metrics = makeEmptyDashboardMetrics();
            REQUEST_KEYS.forEach(type => {
              const entry = response.metrics && response.metrics[type] ? response.metrics[type] : null;
              const total = entry && Number(entry.total);
              const outstanding = entry && Number(entry.outstanding);
              metrics[type] = {
                total: Number.isFinite(total) && total > 0 ? total : 0,
                outstanding: Number.isFinite(outstanding) && outstanding > 0 ? outstanding : 0
              };
            });
            state.dashboard.metrics = metrics;
            const totals = response.totals || {};
            const totalRequests = Number(totals.totalRequests);
            const outstandingRequests = Number(totals.outstandingRequests);
            state.dashboard.totals = {
              totalRequests: Number.isFinite(totalRequests) && totalRequests >= 0
                ? totalRequests
                : REQUEST_KEYS.reduce((sum, type) => sum + metrics[type].total, 0),
              outstandingRequests: Number.isFinite(outstandingRequests) && outstandingRequests >= 0
                ? outstandingRequests
                : REQUEST_KEYS.reduce((sum, type) => sum + metrics[type].outstanding, 0)
            };
            state.dashboard.generatedAt = typeof response.generatedAt === 'string' ? response.generatedAt : '';
            renderDashboard();
          })
          .withFailureHandler(err => {
            state.dashboard.loading = false;
            if (!silent) {
              handleError(err, 'getDashboardMetrics', payload);
            } else {
              console.error('[RequestManager]', 'getDashboardMetrics', err);
            }
            renderDashboard();
          })
          .getDashboardMetrics(payload);
      }

      function renderDashboard() {
        const container = dom.dashboard && dom.dashboard.container;
        if (!container) {
          return;
        }
        const loading = Boolean(state.dashboard.loading);
        const metrics = state.dashboard.metrics || makeEmptyDashboardMetrics();
        const totals = state.dashboard.totals || { totalRequests: 0, outstandingRequests: 0 };
        container.setAttribute('aria-busy', loading ? 'true' : 'false');
        if (dom.dashboard.overall.total) {
          dom.dashboard.overall.total.textContent = loading ? '…' : formatDashboardCount(totals.totalRequests || 0);
        }
        if (dom.dashboard.overall.outstanding) {
          dom.dashboard.overall.outstanding.textContent = loading ? '…' : formatDashboardCount(totals.outstandingRequests || 0);
        }
        REQUEST_KEYS.forEach(type => {
          const elements = dom.dashboard.metrics[type];
          const entry = metrics[type] || { total: 0, outstanding: 0 };
          const totalLabel = loading ? '…' : formatDashboardCount(entry.total);
          const outstandingLabel = loading ? '…' : formatDashboardCount(entry.outstanding);
          if (elements) {
            if (elements.total) {
              elements.total.textContent = totalLabel;
            }
            if (elements.outstanding) {
              elements.outstanding.textContent = outstandingLabel;
            }
            if (elements.legend) {
              elements.legend.textContent = loading ? '…' : outstandingLabel;
            }
          }
        });
        updateDashboardEmptyState(metrics, loading);
        updateDashboardTimestamp();
        drawDashboardPie();
      }

      function updateDashboardEmptyState(metrics, loading) {
        const empty = dom.dashboard && dom.dashboard.empty;
        if (!empty) {
          return;
        }
        if (!hasServer) {
          empty.hidden = false;
          empty.textContent = 'Connect to Google Apps Script to load live data.';
          return;
        }
        const hasRequests = REQUEST_KEYS.some(type => {
          const entry = metrics[type] || { total: 0 };
          return Number(entry.total) > 0;
        });
        if (!hasRequests) {
          empty.hidden = false;
          empty.textContent = loading && !state.dashboard.generatedAt ? 'Loading dashboard…' : 'No requests yet.';
          return;
        }
        empty.hidden = true;
      }

      function updateDashboardTimestamp() {
        const label = dom.dashboard && dom.dashboard.updatedAt;
        if (!label) {
          return;
        }
        if (!hasServer) {
          label.textContent = 'Offline preview';
          return;
        }
        if (state.dashboard.loading && !state.dashboard.generatedAt) {
          label.textContent = 'Loading…';
          return;
        }
        if (!state.dashboard.generatedAt) {
          label.textContent = 'Awaiting data…';
          return;
        }
        const timestamp = new Date(state.dashboard.generatedAt);
        if (!Number.isNaN(timestamp.getTime())) {
          label.textContent = `Updated ${timestamp.toLocaleString()}`;
        } else {
          label.textContent = 'Updated moments ago';
        }
      }

      function drawDashboardPie() {
        const canvas = dom.dashboard && dom.dashboard.pie;
        if (!canvas || typeof canvas.getContext !== 'function') {
          return;
        }
        const rect = canvas.getBoundingClientRect();
        const displayWidth = rect.width || canvas.width || 220;
        const displayHeight = rect.height || canvas.height || 220;
        const ratio = window.devicePixelRatio || 1;
        const targetWidth = Math.max(1, Math.round(displayWidth * ratio));
        const targetHeight = Math.max(1, Math.round(displayHeight * ratio));
        if (canvas.width !== targetWidth || canvas.height !== targetHeight) {
          canvas.width = targetWidth;
          canvas.height = targetHeight;
        }
        const ctx = canvas.getContext('2d');
        if (!ctx) {
          return;
        }
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        if (ratio !== 1) {
          ctx.scale(ratio, ratio);
        }
        ctx.clearRect(0, 0, displayWidth, displayHeight);
        const metrics = state.dashboard.metrics || makeEmptyDashboardMetrics();
        const values = REQUEST_KEYS.map(type => {
          const entry = metrics[type] || { outstanding: 0 };
          const value = Number(entry.outstanding);
          return Number.isFinite(value) && value > 0 ? value : 0;
        });
        const total = values.reduce((sum, value) => sum + value, 0);
        const centerX = displayWidth / 2;
        const centerY = displayHeight / 2;
        const radius = Math.max(10, Math.min(centerX, centerY) - 6);
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
        ctx.fillStyle = '#eef2f7';
        ctx.fill();
        ctx.lineWidth = 1;
        ctx.strokeStyle = '#d7dce1';
        ctx.stroke();
        if (!total) {
          return;
        }
        let startAngle = -Math.PI / 2;
        values.forEach((value, index) => {
          if (!value) {
            return;
          }
          const type = REQUEST_KEYS[index];
          const endAngle = startAngle + (value / total) * Math.PI * 2;
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.arc(centerX, centerY, radius, startAngle, endAngle, false);
          ctx.closePath();
          ctx.fillStyle = DASHBOARD_COLORS[type] || '#0b57d0';
          ctx.fill();
          startAngle = endAngle;
        });
        const innerRadius = Math.max(radius * 0.55, radius - 44);
        ctx.beginPath();
        ctx.arc(centerX, centerY, innerRadius, 0, Math.PI * 2);
        ctx.fillStyle = '#ffffff';
        ctx.fill();
        ctx.fillStyle = '#202731';
        ctx.font = '600 16px "Segoe UI", sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(formatDashboardCount(total), centerX, centerY - 8);
        ctx.font = '500 12px "Segoe UI", sans-serif';
        ctx.fillStyle = '#5c6774';
        ctx.fillText('outstanding', centerX, centerY + 10);
      }

      function formatDashboardCount(value) {
        const number = Number(value);
        if (!Number.isFinite(number)) {
          return '0';
        }
        return number.toLocaleString();
      }

      function makeEmptyDashboardMetrics() {
        return REQUEST_KEYS.reduce((acc, type) => {
          acc[type] = { total: 0, outstanding: 0 };
          return acc;
        }, {});
      }

      function requestDashboardRefresh(delay) {
        if (!hasServer) {
          return;
        }
        const wait = typeof delay === 'number' && delay >= 0 ? delay : DASHBOARD_DEBOUNCE;
        if (dashboardDeferredRefreshId) {
          window.clearTimeout(dashboardDeferredRefreshId);
        }
        dashboardDeferredRefreshId = window.setTimeout(() => {
          dashboardDeferredRefreshId = null;
          loadDashboardMetrics({ silent: true });
        }, wait);
      }

      function startDashboardAutoRefresh() {
        if (!hasServer) {
          return;
        }
        stopDashboardAutoRefresh();
        dashboardAutoRefreshId = window.setInterval(() => {
          loadDashboardMetrics({ silent: true });
        }, DASHBOARD_REFRESH_INTERVAL);
      }

      function stopDashboardAutoRefresh() {
        if (dashboardAutoRefreshId) {
          window.clearInterval(dashboardAutoRefreshId);
          dashboardAutoRefreshId = null;
        }
        if (dashboardDeferredRefreshId) {
          window.clearTimeout(dashboardDeferredRefreshId);
          dashboardDeferredRefreshId = null;
        }
      }

      function showDashboardOfflineMessage() {
        const empty = dom.dashboard && dom.dashboard.empty;
        if (empty) {
          empty.hidden = false;
          empty.textContent = 'Connect to Google Apps Script to load live data.';
        }
        const label = dom.dashboard && dom.dashboard.updatedAt;
        if (label) {
          label.textContent = 'Offline preview';
        }
      }

      function clearApproverNotices() {
        REQUEST_KEYS.forEach(type => {
          const container = dom[type] && dom[type].approverNotice;
          if (!container) {
            return;
          }
          while (container.firstChild) {
            container.removeChild(container.firstChild);
          }
          delete container.dataset.variant;
          container.hidden = true;
        });
      }

      function renderApproverUnavailable(auth) {
        const messageText = auth && auth.reason === 'missing_email'
          ? 'We could not confirm your Google Account email. Sign in with an authorized account before approving requests.'
          : `${auth && auth.email ? auth.email : 'This account'} is not on the approver allowlist.`;
        const hintText = 'An administrator can add approver emails via the SUPPLIES_TRACKING_STATUS_EMAILS script property or by updating the default allowlist.';
        REQUEST_KEYS.forEach(type => {
          const container = dom[type] && dom[type].approverNotice;
          if (!container) {
            return;
          }
          container.dataset.variant = 'warning';
          const title = document.createElement('strong');
          title.textContent = 'Approver access unavailable';
          container.appendChild(title);
          const message = document.createElement('p');
          message.textContent = messageText;
          container.appendChild(message);
          const hint = document.createElement('p');
          hint.textContent = hintText;
          container.appendChild(hint);
          container.hidden = false;
        });
      }

      function renderStatusAuthNotice(auth) {
        const notice = dom.statusNotice;
        if (notice) {
          while (notice.firstChild) {
            notice.removeChild(notice.firstChild);
          }
          delete notice.dataset.variant;
          notice.hidden = true;
        }
        clearApproverNotices();
        if (!auth) {
          return;
        }
        if (!auth.authorized) {
          renderApproverUnavailable(auth);
          return;
        }
        if (auth.allowlistSource === 'script_property' && notice) {
          notice.dataset.variant = 'info';
          const title = document.createElement('strong');
          title.textContent = 'Managed approver list active';
          notice.appendChild(title);
          const message = document.createElement('p');
          message.textContent = 'Approver permissions are being served from the SUPPLIES_TRACKING_STATUS_EMAILS script property fallback.';
          notice.appendChild(message);
          notice.hidden = false;
        }
      }

      function attachNavHandlers() {
        dom.tabButtons.forEach(button => {
          button.addEventListener('click', () => {
            const type = button.getAttribute('data-tab-trigger');
            if (type && REQUEST_KEYS.indexOf(type) !== -1) {
              setActiveTab(type);
            }
          });
        });
      }

      function attachFormHandlers() {
        dom.supplies.form.addEventListener('submit', evt => handleSubmit(evt, 'supplies'));
        dom.supplies.reset.addEventListener('click', () => {
          resetForm('supplies');
        });
        dom.supplies.location.addEventListener('change', () => {
          setFormState('supplies', { location: dom.supplies.location.value });
          persistForm('supplies');
        });
        dom.supplies.qty.addEventListener('input', () => {
          const qty = Number(dom.supplies.qty.value);
          const sanitized = Number.isFinite(qty) && qty > 0 ? Math.floor(qty) : 1;
          setFormState('supplies', { qty: sanitized });
          dom.supplies.qty.value = sanitized;
          persistForm('supplies');
        });
        dom.supplies.notes.addEventListener('input', () => {
          setFormState('supplies', { notes: dom.supplies.notes.value });
          persistForm('supplies');
        });
        dom.supplies.description.addEventListener('input', () => {
          const value = dom.supplies.description.value || '';
          const trimmed = value.trim();
          if (!syncingCatalogToDescription) {
            let matchedSku = '';
            if (trimmed) {
              const match = state.catalog.items.find(item => item.description.toLowerCase() === trimmed.toLowerCase());
              if (match) {
                matchedSku = match.sku;
              }
            }
            setFormState('supplies', { description: value, catalogSku: matchedSku });
            dom.supplies.catalogSku.value = matchedSku;
          } else {
            setFormState('supplies', { description: value });
          }
          persistForm('supplies');
          if (state.catalog.items.length) {
            renderCatalog();
          }
        });
        dom.supplies.catalogSearch.addEventListener('focus', () => {
          ensureFullCatalogLoaded();
          updateCatalogSearchAffordances();
        });
        dom.supplies.catalogSearch.addEventListener('click', () => {
          ensureFullCatalogLoaded();
        });
        if (dom.supplies.requesterName) {
          dom.supplies.requesterName.addEventListener('input', () => {
            handleRequesterNameInput('supplies');
          });
        }
        const handleCatalogSearchInput = () => {
          const rawValue = dom.supplies.catalogSearch.value || '';
          state.catalog.search = rawValue;
          ensureFullCatalogLoaded();
          const option = findCatalogOption(rawValue);
          if (option) {
            selectCatalogSku(option.dataset ? option.dataset.sku || '' : '', { searchValue: rawValue, updateSearch: false });
          } else {
            selectCatalogSku('', { searchValue: rawValue, updateSearch: false, preserveDescription: true });
          }
          if (state.catalog.items.length) {
            renderCatalog();
          }
          updateCatalogSearchAffordances();
        };
        dom.supplies.catalogSearch.addEventListener('input', handleCatalogSearchInput);
        dom.supplies.catalogSearch.addEventListener('change', handleCatalogSearchInput);
        if (dom.supplies.catalogClear) {
          dom.supplies.catalogClear.addEventListener('click', () => {
            dom.supplies.catalogSearch.value = '';
            state.catalog.search = '';
            selectCatalogSku('', { updateSearch: false, preserveDescription: true });
            renderCatalog();
            updateCatalogSearchAffordances();
            dom.supplies.catalogSearch.focus();
          });
        }
        dom.supplies.more.addEventListener('click', () => {
          if (!state.loading.supplies && state.nextTokens.supplies) {
            loadRequests('supplies', { append: true });
          }
        });
        dom.supplies.catalogMore.addEventListener('click', () => {
          if (!state.catalog.loading) {
            loadCatalog({ append: false, fetchAll: true });
          }
        });

        dom.it.form.addEventListener('submit', evt => handleSubmit(evt, 'it'));
        dom.it.reset.addEventListener('click', () => {
          resetForm('it');
        });
        dom.it.location.addEventListener('change', () => {
          setFormState('it', { location: dom.it.location.value });
          persistForm('it');
        });
        if (dom.it.requesterName) {
          dom.it.requesterName.addEventListener('input', () => {
            handleRequesterNameInput('it');
          });
        }
        dom.it.issue.addEventListener('input', () => {
          setFormState('it', { issue: dom.it.issue.value });
          persistForm('it');
        });
        dom.it.device.addEventListener('input', () => {
          setFormState('it', { device: dom.it.device.value });
          persistForm('it');
        });
        dom.it.urgency.addEventListener('change', () => {
          setFormState('it', { urgency: dom.it.urgency.value });
          persistForm('it');
        });
        dom.it.details.addEventListener('input', () => {
          setFormState('it', { details: dom.it.details.value });
          persistForm('it');
        });
        dom.it.more.addEventListener('click', () => {
          if (!state.loading.it && state.nextTokens.it) {
            loadRequests('it', { append: true });
          }
        });

        dom.maintenance.form.addEventListener('submit', evt => handleSubmit(evt, 'maintenance'));
        dom.maintenance.reset.addEventListener('click', () => {
          resetForm('maintenance');
        });
        dom.maintenance.location.addEventListener('change', () => {
          setFormState('maintenance', { location: dom.maintenance.location.value });
          persistForm('maintenance');
        });
        if (dom.maintenance.requesterName) {
          dom.maintenance.requesterName.addEventListener('input', () => {
            handleRequesterNameInput('maintenance');
          });
        }
        dom.maintenance.issue.addEventListener('input', () => {
          setFormState('maintenance', { issue: dom.maintenance.issue.value });
          persistForm('maintenance');
        });
        dom.maintenance.urgency.addEventListener('change', () => {
          setFormState('maintenance', { urgency: dom.maintenance.urgency.value });
          persistForm('maintenance');
        });
        dom.maintenance.accessNotes.addEventListener('input', () => {
          setFormState('maintenance', { accessNotes: dom.maintenance.accessNotes.value });
          persistForm('maintenance');
        });
        dom.maintenance.more.addEventListener('click', () => {
          if (!state.loading.maintenance && state.nextTokens.maintenance) {
            loadRequests('maintenance', { append: true });
          }
        });
      }

      function setActiveTab(type) {
        state.activeTab = type;
        dom.tabButtons.forEach(button => {
          button.classList.toggle('active', button.getAttribute('data-tab-trigger') === type);
        });
        dom.panels.forEach(panel => {
          panel.classList.toggle('active', panel.getAttribute('data-tab-panel') === type);
        });
        ensureRequestsLoaded(type);
        scheduleWarmCache();
      }

      function ensureRequestsLoaded(type) {
        if (state.loaded[type] || !hasServer) {
          return;
        }
        loadRequests(type, { append: false });
      }

      function scheduleWarmCache() {
        if (!hasServer || warmScheduled) {
          return;
        }
        warmScheduled = true;
        const idle = typeof window.requestIdleCallback === 'function'
          ? window.requestIdleCallback
          : callback => setTimeout(() => callback({ didTimeout: false }), 600);
        idle(() => {
          const others = REQUEST_KEYS.filter(tab => tab !== state.activeTab);
          others.forEach((type, index) => {
            setTimeout(() => {
              if (!state.loaded[type]) {
                loadRequests(type, { append: false });
              }
            }, index * 220);
          });
        });
      }

      function handleSubmit(event, type) {
        event.preventDefault();
        const formState = state.forms[type];
        const validationError = validateForm(type, formState);
        if (validationError) {
          handleError({ message: validationError }, `${type}:validation`);
          return;
        }
        if (!server) {
          showToast('Connect to Google Apps Script to submit requests.');
          return;
        }
        disableForm(type, true);
        const payload = Object.assign({
          cid: makeCid(),
          clientRequestId: makeClientRequestId(type),
          type
        }, formState);
        if (requiresRequesterName) {
          payload.requesterName = state.requesterName || formState.requesterName || '';
        }
        server
          .withSuccessHandler(response => {
            disableForm(type, false);
            if (!response || !response.ok || !response.request) {
              handleError(response, 'createRequest', payload);
              return;
            }
            showToast('Request submitted');
            resetForm(type);
            state.requests[type].unshift(response.request);
            renderRequests(type);
            requestDashboardRefresh(DASHBOARD_DEBOUNCE);
          })
          .withFailureHandler(err => {
            disableForm(type, false);
            handleError(err, 'createRequest', payload);
          })
          .createRequest(payload);
      }

      function validateForm(type, formState) {
        if (requiresRequesterName) {
          const nameValue = (state.requesterName || formState.requesterName || '').trim();
          if (!nameValue) {
            return 'Your name is required.';
          }
        }
        switch (type) {
          case 'supplies':
            if (!formState.location || !formState.location.trim()) {
              return 'Location is required.';
            }
            if (!formState.description || !formState.description.trim()) {
              return 'Item name is required.';
            }
            if (!formState.qty || Number(formState.qty) <= 0) {
              return 'Quantity must be at least 1.';
            }
            return '';
          case 'it':
            if (!formState.location || !formState.location.trim()) {
              return 'Location is required.';
            }
            if (!formState.issue || !formState.issue.trim()) {
              return 'Issue summary is required.';
            }
            return '';
          case 'maintenance':
            if (!formState.location || !formState.location.trim()) {
              return 'Location is required.';
            }
            if (!formState.issue || !formState.issue.trim()) {
              return 'Issue description is required.';
            }
            return '';
          default:
            return 'Unsupported request type.';
        }
      }

      function resetForm(type) {
        state.forms[type] = Object.assign({}, FORM_TEMPLATES[type]);
        if (requiresRequesterName) {
          state.forms[type].requesterName = state.requesterName || '';
        }
        if (type === 'supplies') {
          state.catalog.search = '';
        }
        renderForm(type);
        if (type === 'supplies' && state.catalog.items.length) {
          renderCatalog();
        }
        persistForm(type, { immediate: true });
      }

      function renderForm(type) {
        const formState = state.forms[type];
        if (type === 'supplies') {
          dom.supplies.catalogSku.value = formState.catalogSku || '';
          dom.supplies.location.value = formState.location || '';
          dom.supplies.qty.value = formState.qty || 1;
          dom.supplies.description.value = formState.description || '';
          dom.supplies.notes.value = formState.notes || '';
          if (dom.supplies.requesterName) {
            dom.supplies.requesterName.value = requiresRequesterName
              ? (formState.requesterName || state.requesterName || '')
              : '';
          }
        } else if (type === 'it') {
          dom.it.location.value = formState.location || '';
          dom.it.issue.value = formState.issue || '';
          dom.it.device.value = formState.device || '';
          const itUrgency = normalizeUrgency(formState.urgency) || 'normal';
          dom.it.urgency.value = itUrgency;
          state.forms.it.urgency = itUrgency;
          dom.it.details.value = formState.details || '';
          if (dom.it.requesterName) {
            dom.it.requesterName.value = requiresRequesterName
              ? (formState.requesterName || state.requesterName || '')
              : '';
          }
        } else if (type === 'maintenance') {
          dom.maintenance.location.value = formState.location || '';
          dom.maintenance.issue.value = formState.issue || '';
          const maintenanceUrgency = normalizeUrgency(formState.urgency) || 'normal';
          dom.maintenance.urgency.value = maintenanceUrgency;
          state.forms.maintenance.urgency = maintenanceUrgency;
          dom.maintenance.accessNotes.value = formState.accessNotes || '';
          if (dom.maintenance.requesterName) {
            dom.maintenance.requesterName.value = requiresRequesterName
              ? (formState.requesterName || state.requesterName || '')
              : '';
          }
        }
      }

      function loadRequests(type, { append }) {
        if (state.loading[type]) {
          return;
        }
        if (!server) {
          state.loaded[type] = true;
          renderRequests(type);
          return;
        }
        state.loading[type] = true;
        const moreButton = dom[type].more;
        if (moreButton) {
          moreButton.disabled = true;
        }
        toggleRequestsSkeleton(type, true);
        const payload = {
          cid: makeCid(),
          type,
          pageSize: 10,
          scope: 'all',
          nextToken: append ? state.nextTokens[type] : ''
        };
        server
          .withSuccessHandler(response => {
            state.loading[type] = false;
            state.loaded[type] = true;
            toggleRequestsSkeleton(type, false);
            if (!response || !response.ok) {
              handleError(response, 'listRequests', payload);
              return;
            }
            state.nextTokens[type] = response.nextToken || '';
            const items = Array.isArray(response.requests) ? response.requests : [];
            state.requests[type] = append ? state.requests[type].concat(items) : items;
            renderRequests(type);
          })
          .withFailureHandler(err => {
            state.loading[type] = false;
            state.loaded[type] = true;
            toggleRequestsSkeleton(type, false);
            handleError(err, 'listRequests', payload);
          })
          .listRequests(payload);
      }

      function renderRequests(type) {
        const list = dom[type].list;
        const moreButton = dom[type].more;
        list.textContent = '';
        if (!state.requests[type].length) {
          if (state.loading[type]) {
            list.appendChild(buildSkeletonBlock());
          } else {
            const empty = document.createElement('p');
            empty.className = 'empty';
            const message = EMPTY_REQUEST_MESSAGES[type];
            empty.textContent = hasServer ? message : 'Connect to Google Apps Script to load requests.';
            list.appendChild(empty);
          }
          if (moreButton) {
            moreButton.disabled = true;
          }
          return;
        }
        const fragment = document.createDocumentFragment();
        state.requests[type].forEach(request => {
          const item = document.createElement('article');
          item.className = 'request-item';
          item.dataset.requestType = type;
          item.dataset.requestId = request.id;

          const head = document.createElement('div');
          head.className = 'request-item-head';

          const title = document.createElement('strong');
          title.className = 'request-item-title';
          title.textContent = request.summary || 'Request';
          head.appendChild(title);

          if ((type === 'it' || type === 'maintenance') && request.fields) {
            const urgencyKey = normalizeUrgency(request.fields.urgency);
            if (urgencyKey) {
              const urgencyBadge = document.createElement('span');
              urgencyBadge.className = 'urgency-badge request-urgency';
              urgencyBadge.dataset.urgency = urgencyKey;
              urgencyBadge.textContent = formatUrgencyLabel(urgencyKey);
              head.appendChild(urgencyBadge);
            }
          }

          const status = document.createElement('span');
          status.className = 'status';
          const statusValue = String(request.status || '').toLowerCase();
          const stateKey = statusValue.replace(/\s+/g, '_');
          status.dataset.state = stateKey;
          status.textContent = formatStatus(stateKey);
          head.appendChild(status);
          item.appendChild(head);

          const info = document.createElement('div');
          info.className = 'request-item-info';

          const meta = document.createElement('span');
          meta.className = 'meta';
          meta.textContent = buildRequestMeta(request, type);
          info.appendChild(meta);

          if (Array.isArray(request.details)) {
            request.details.forEach(detail => {
              if (!detail) return;
              const line = document.createElement('span');
              line.className = 'detail-line';
              line.textContent = detail;
              info.appendChild(line);
            });
          }

          const submittedLine = document.createElement('span');
          submittedLine.className = 'detail-line';
          submittedLine.textContent = `Submitted by: ${request.requester || 'Unknown requester'}`;
          info.appendChild(submittedLine);

          const statusLineText = buildStatusActorLine(type, stateKey, request.approver);
          if (statusLineText) {
            const statusLine = document.createElement('span');
            statusLine.className = 'detail-line';
            statusLine.textContent = statusLineText;
            info.appendChild(statusLine);
          }

          item.appendChild(info);

          const footer = document.createElement('div');
          footer.className = 'request-item-footer';

          if (type === 'supplies') {
            const etaWrapper = document.createElement('label');
            etaWrapper.className = 'eta-field';

            const etaText = document.createElement('span');
            etaText.textContent = 'ETA';
            etaWrapper.appendChild(etaText);

            const etaInput = document.createElement('input');
            etaInput.type = 'date';
            etaInput.autocomplete = 'off';
            const previousEta = getRequestEta(request);
            etaInput.value = previousEta;
            etaInput.setAttribute('aria-label', `ETA for ${request.summary || 'request'}`);
            const etaStatusAllowed = canEditEtaStatus(stateKey);
            const etaEditable = server && canManageStatuses && etaStatusAllowed;
            if (!etaEditable) {
              etaInput.disabled = true;
            }
            if (!canManageStatuses) {
              etaInput.title = 'Only authorized approvers can update ETA.';
            } else if (!etaStatusAllowed) {
              etaInput.title = 'ETA can be set after approval only.';
            } else {
              etaInput.title = '';
            }
            if (etaEditable) {
              etaInput.addEventListener('change', () => {
                const nextValue = etaInput.value;
                if (nextValue === previousEta) {
                  return;
                }
                handleUpdateEta(type, request, nextValue, etaInput, previousEta);
              });
            }
            etaWrapper.appendChild(etaInput);
            footer.appendChild(etaWrapper);
          }

          if (type === 'supplies' && canManageStatuses) {
            const buttonRow = document.createElement('div');
            buttonRow.className = 'inline-buttons';
            let hasButtons = false;

            if (stateKey === 'pending') {
              const approved = document.createElement('button');
              approved.type = 'button';
              approved.className = 'secondary';
              approved.textContent = 'Approved';
              approved.addEventListener('click', () => handleUpdateStatus(type, request.id, 'approved'));
              buttonRow.appendChild(approved);

              const denied = document.createElement('button');
              denied.type = 'button';
              denied.className = 'secondary';
              denied.textContent = 'Denied';
              denied.addEventListener('click', () => handleUpdateStatus(type, request.id, 'denied'));
              buttonRow.appendChild(denied);
              hasButtons = true;
            }

            if (hasButtons) {
              const controls = document.createElement('div');
              controls.className = 'supplies-actions';
              controls.appendChild(buttonRow);
              footer.appendChild(controls);
            }
          } else if (canManageStatuses && (stateKey === 'pending' || stateKey === 'in_progress')) {
            const actions = document.createElement('div');
            actions.className = 'inline-buttons';
            const complete = document.createElement('button');
            complete.type = 'button';
            complete.className = 'secondary';
            complete.textContent = 'Complete';
            complete.addEventListener('click', () => handleUpdateStatus(type, request.id, 'completed'));
            actions.appendChild(complete);

            const progress = document.createElement('button');
            progress.type = 'button';
            progress.className = 'secondary';
            progress.textContent = 'In Progress';
            progress.addEventListener('click', () => handleUpdateStatus(type, request.id, 'in_progress'));
            progress.classList.toggle('active', stateKey === 'in_progress');
            progress.setAttribute('aria-pressed', stateKey === 'in_progress' ? 'true' : 'false');
            actions.appendChild(progress);

            const denied = document.createElement('button');
            denied.type = 'button';
            denied.className = 'secondary';
            denied.textContent = 'Denied';
            denied.addEventListener('click', () => handleUpdateStatus(type, request.id, 'denied'));
            actions.appendChild(denied);

            footer.appendChild(actions);
          }

          if (footer.childElementCount) {
            item.appendChild(footer);
          }

          fragment.appendChild(item);
        });
        list.appendChild(fragment);
        if (moreButton) {
          moreButton.disabled = !state.nextTokens[type];
        }
      }

      function handleUpdateStatus(type, requestId, status) {
        if (!canManageStatuses) {
          showToast('You are not authorized to update requests.');
          return;
        }
        if (!server) {
          showToast('Connect to Google Apps Script to update statuses.');
          return;
        }
        const payload = {
          cid: makeCid(),
          clientRequestId: makeClientRequestId(type),
          type,
          requestId,
          status
        };
        const item = dom[type].list.querySelector(`article[data-request-id="${requestId}"]`);
        const interactive = item
          ? Array.from(item.querySelectorAll('button'))
          : [];
        interactive.forEach(element => { element.disabled = true; });
        server
          .withSuccessHandler(response => {
            interactive.forEach(element => { element.disabled = false; });
            if (!response || !response.ok || !response.request) {
              handleError(response, 'updateRequestStatus', payload);
              return;
            }
            const updated = response.request;
            const index = state.requests[type].findIndex(entry => entry.id === updated.id);
            if (index >= 0) {
              state.requests[type][index] = updated;
              renderRequests(type);
            }
            showToast('Request updated');
            requestDashboardRefresh(DASHBOARD_DEBOUNCE);
          })
          .withFailureHandler(err => {
            interactive.forEach(element => { element.disabled = false; });
            handleError(err, 'updateRequestStatus', payload);
          })
          .updateRequestStatus(payload);
      }

      function handleUpdateEta(type, request, etaValue, input, previousEta) {
        if (!canManageStatuses) {
          showToast('You are not authorized to update requests.');
          input.value = previousEta;
          return;
        }
        if (!server) {
          showToast('Connect to Google Apps Script to update ETA dates.');
          input.value = previousEta;
          return;
        }
        if (!request || !request.id) {
          input.value = previousEta;
          handleError({ message: 'Request not found.' }, 'updateRequestEta');
          return;
        }
        if (!canEditEtaStatus(request && request.status)) {
          input.value = previousEta;
          showToast('ETA can be set after approval only.');
          return;
        }
        const payload = {
          cid: makeCid(),
          clientRequestId: makeClientRequestId(type),
          type,
          requestId: request.id,
          status: request.status || 'pending',
          eta: etaValue
        };
        input.disabled = true;
        server
          .withSuccessHandler(response => {
            input.disabled = false;
            if (!response || !response.ok || !response.request) {
              input.value = previousEta;
              handleError(response, 'updateRequestEta', payload);
              return;
            }
            const updated = response.request;
            const index = state.requests[type].findIndex(entry => entry.id === updated.id);
            if (index >= 0) {
              state.requests[type][index] = updated;
              renderRequests(type);
            }
            const updatedEta = getRequestEta(updated);
            showToast(updatedEta ? 'ETA updated' : 'ETA cleared');
            requestDashboardRefresh(DASHBOARD_DEBOUNCE);
          })
          .withFailureHandler(err => {
            input.disabled = false;
            input.value = previousEta;
            handleError(err, 'updateRequestEta', payload);
          })
          .updateRequestStatus(payload);
      }

      function canEditEtaStatus(status) {
        const key = typeof status === 'string'
          ? status.trim().toLowerCase().replace(/\s+/g, '_')
          : '';
        return key === 'approved' || key === 'ordered' || key === 'completed';
      }

      function buildRequestMeta(request, type) {
        const parts = [];
        if (request.ts) {
          try {
            parts.push(new Date(request.ts).toLocaleString());
          } catch (err) {
            parts.push(request.ts);
          }
        }
        const scopeType = typeof type === 'string' ? type : '';
        if (scopeType !== 'supplies' && request.requester) {
          parts.push(request.requester);
        }
        return parts.join(' • ');
      }

      function normalizeUrgency(value) {
        const text = typeof value === 'string' ? value.trim().toLowerCase() : '';
        if (!text) {
          return '';
        }
        if (text === 'high') {
          return 'critical';
        }
        if (text === 'medium') {
          return 'normal';
        }
        return text === 'low' || text === 'normal' || text === 'critical' ? text : '';
      }

      function formatUrgencyLabel(value) {
        switch (value) {
          case 'low':
            return 'Low';
          case 'critical':
            return 'Critical';
          case 'normal':
          default:
            return 'Normal';
        }
      }

      function getRequestEta(request) {
        if (!request || !request.fields) {
          return '';
        }
        return String(request.fields.eta || '');
      }

      function loadCatalog({ append, fetchAll }) {
        if (state.catalog.loading || !server) {
          if (!server) {
            state.catalog.loading = false;
            renderCatalog();
          }
          return;
        }
        state.catalog.loading = true;
        if (fetchAll) {
          state.catalog.fullyLoaded = false;
        }
        dom.supplies.catalogMore.disabled = true;
        toggleCatalogSkeleton(true);
        updateCatalogControls();
        const payload = {
          cid: makeCid()
        };
        if (fetchAll) {
          payload.fetchAll = true;
        } else {
          payload.pageSize = 20;
          payload.nextToken = append ? state.catalog.nextToken : '';
        }
        server
          .withSuccessHandler(response => {
            state.catalog.loading = false;
            toggleCatalogSkeleton(false);
            if (!response || !response.ok) {
              handleError(response, 'listCatalog', payload);
              return;
            }
            state.catalog.nextToken = response.nextToken || '';
            const items = Array.isArray(response.items) ? response.items : [];
            state.catalog.items = append && !fetchAll ? state.catalog.items.concat(items) : items;
            state.catalog.fullyLoaded = fetchAll || !state.catalog.nextToken;
            renderCatalog();
            updateCatalogControls();
          })
          .withFailureHandler(err => {
            state.catalog.loading = false;
            toggleCatalogSkeleton(false);
            handleError(err, 'listCatalog', payload);
            updateCatalogControls();
          })
          .listCatalog(payload);
      }

      function renderCatalog() {
        dom.supplies.catalogList.textContent = '';
        if (dom.supplies.catalogOptions) {
          dom.supplies.catalogOptions.textContent = '';
        }
        let selectedSku = state.forms.supplies.catalogSku || '';
        const searchValue = state.catalog.search || '';
        dom.supplies.catalogSearch.value = searchValue;
        updateCatalogSearchAffordances();
        updateCatalogControls();

        if (!state.catalog.items.length) {
          dom.supplies.catalogSearch.disabled = !state.catalog.loading;
          if (state.catalog.loading) {
            dom.supplies.catalogList.appendChild(buildSkeletonBlock());
          } else {
            const empty = document.createElement('p');
            empty.className = 'empty';
            empty.textContent = hasServer ? 'No catalog items found.' : 'Catalog requires Google Apps Script.';
            dom.supplies.catalogList.appendChild(empty);
          }
          return;
        }

        dom.supplies.catalogSearch.disabled = false;

        const descriptionValue = (state.forms.supplies.description || '').trim();
        if (!selectedSku && descriptionValue) {
          const match = state.catalog.items.find(item => item.description.toLowerCase() === descriptionValue.toLowerCase());
          if (match) {
            selectCatalogSku(match.sku, { updateSearch: false });
            selectedSku = match.sku;
          }
        }

        dom.supplies.catalogSku.value = selectedSku;

        const normalizedSearch = searchValue.trim().toLowerCase();
        let filteredItems = state.catalog.items.slice();
        if (normalizedSearch) {
          filteredItems = state.catalog.items.filter(item => {
            const haystack = `${item.description} ${item.category} ${item.sku}`.toLowerCase();
            return haystack.indexOf(normalizedSearch) !== -1;
          });
          const skuToHighlight = state.forms.supplies.catalogSku || '';
          if (skuToHighlight && !filteredItems.some(item => item.sku === skuToHighlight)) {
            const selectedItem = findCatalogItem(skuToHighlight);
            if (selectedItem) {
              filteredItems.unshift(selectedItem);
            }
          }
        }

        if (!filteredItems.length) {
          const empty = document.createElement('p');
          empty.className = 'empty';
          if (normalizedSearch) {
            empty.textContent = state.catalog.loading && !state.catalog.fullyLoaded
              ? 'Loading more catalog items to finish your search…'
              : 'No catalog items match your search. Try another keyword.';
          } else {
            empty.textContent = hasServer ? 'No catalog items found.' : 'Catalog requires Google Apps Script.';
          }
          dom.supplies.catalogList.appendChild(empty);
          return;
        }

        const popularItems = state.catalog.items.filter(item => Number(item.usageCount) > 0);
        const topRank = Math.min(5, popularItems.length);
        const topSkuSet = new Set(popularItems.slice(0, topRank).map(item => item.sku));

        if (dom.supplies.catalogOptions) {
          const datalistFragment = document.createDocumentFragment();
          const limit = 25;
          const datalistItems = filteredItems.slice(0, limit);
          if (selectedSku) {
            const selectedItem = findCatalogItem(selectedSku);
            if (selectedItem && !datalistItems.some(entry => entry.sku === selectedSku)) {
              datalistItems.unshift(selectedItem);
            }
          }
          datalistItems.slice(0, limit).forEach(item => {
            const option = document.createElement('option');
            option.value = formatCatalogOptionValue(item, topSkuSet.has(item.sku));
            option.dataset.sku = item.sku;
            option.dataset.description = item.description;
            option.dataset.category = item.category || '';
            datalistFragment.appendChild(option);
          });
          dom.supplies.catalogOptions.appendChild(datalistFragment);
        }

        const fragment = document.createDocumentFragment();
        filteredItems.forEach(item => {
          const card = document.createElement('article');
          card.className = 'catalog-item';
          if (item.sku === selectedSku) {
            card.classList.add('selected');
          }
          card.tabIndex = 0;
          card.setAttribute('role', 'listitem');
          const name = document.createElement('strong');
          name.textContent = item.description;
          card.appendChild(name);
          const meta = document.createElement('span');
          meta.className = 'meta';
          meta.textContent = item.category ? `${item.category} • ${item.sku}` : item.sku;
          card.appendChild(meta);
          if (Number(item.usageCount) > 0) {
            const usage = document.createElement('span');
            usage.className = 'meta usage';
            usage.textContent = item.usageCount === 1 ? 'Requested 1 time' : `Requested ${item.usageCount} times`;
            card.appendChild(usage);
          }
          if (topSkuSet.has(item.sku) && Number(item.usageCount) > 0) {
            const badge = document.createElement('span');
            badge.className = 'catalog-badge';
            badge.textContent = 'Most requested';
            card.appendChild(badge);
          }
          const handleSelect = () => {
            selectCatalogSku(item.sku);
            renderCatalog();
          };
          card.addEventListener('click', () => {
            handleSelect();
          });
          card.addEventListener('keydown', evt => {
            if (evt.key === 'Enter' || evt.key === ' ') {
              evt.preventDefault();
              handleSelect();
            }
          });
          fragment.appendChild(card);
        });
        dom.supplies.catalogList.appendChild(fragment);
        if (state.catalog.loading && !state.catalog.fullyLoaded) {
          const loading = document.createElement('p');
          loading.className = 'meta';
          loading.textContent = 'Loading remaining catalog items…';
          dom.supplies.catalogList.appendChild(loading);
        }
      }

      function updateCatalogSearchAffordances() {
        if (!dom.supplies.catalogClear) {
          return;
        }
        const hasValue = Boolean(dom.supplies.catalogSearch.value);
        const hasSelection = Boolean(dom.supplies.catalogSku.value);
        dom.supplies.catalogClear.classList.toggle('visible', hasValue || hasSelection);
      }

      function selectCatalogSku(sku, options) {
        const opts = options || {};
        const item = sku ? findCatalogItem(sku) : null;
        const shouldUpdateSearch = opts.updateSearch !== false;
        const searchValue = 'searchValue' in opts
          ? opts.searchValue
          : item
            ? formatCatalogOptionValue(item, false)
            : '';
        if (shouldUpdateSearch) {
          state.catalog.search = searchValue;
          dom.supplies.catalogSearch.value = searchValue;
        }
        const preserveDescription = Boolean(opts.preserveDescription);
        const nextDescription = item && !preserveDescription ? item.description : dom.supplies.description.value;
        if (item && !preserveDescription) {
          syncingCatalogToDescription = true;
          dom.supplies.description.value = item.description;
          syncingCatalogToDescription = false;
        }
        dom.supplies.catalogSku.value = sku || '';
        setFormState('supplies', { catalogSku: sku || '', description: nextDescription });
        updateCatalogSearchAffordances();
        if (opts.persist !== false) {
          persistForm('supplies');
        }
      }

      function formatCatalogOptionValue(item, highlight) {
        if (!item) {
          return '';
        }
        const prefix = highlight ? '★ ' : '';
        const categoryLabel = item.category ? ` · ${item.category}` : '';
        return `${prefix}${item.description}${categoryLabel} — ${item.sku}`;
      }

      function findCatalogOption(value) {
        if (!dom.supplies.catalogOptions) {
          return null;
        }
        const options = Array.from(dom.supplies.catalogOptions.querySelectorAll('option'));
        return options.find(option => option.value === value) || null;
      }
      function findCatalogItem(sku) {
        if (!sku) {
          return null;
        }
        const item = state.catalog.items.find(entry => entry.sku === sku);
        return item || null;
      }

      function ensureFullCatalogLoaded() {
        if (!hasServer) {
          return;
        }
        if (state.catalog.fullyLoaded || state.catalog.loading) {
          return;
        }
        loadCatalog({ append: false, fetchAll: true });
      }

      function updateCatalogControls() {
        const button = dom.supplies.catalogMore;
        if (!button) {
          return;
        }
        if (!hasServer) {
          button.hidden = true;
          return;
        }
        button.hidden = false;
        if (state.catalog.loading) {
          button.disabled = true;
          button.textContent = state.catalog.fullyLoaded ? 'Refreshing…' : 'Loading all items…';
          return;
        }
        if (state.catalog.fullyLoaded) {
          button.disabled = false;
          button.textContent = 'Refresh catalog';
        } else {
          button.disabled = false;
          button.textContent = 'Load all items';
        }
      }

      function setFormState(type, partial) {
        state.forms[type] = Object.assign({}, state.forms[type], partial);
      }

      function handleRequesterNameInput(type) {
        if (!requiresRequesterName) {
          return;
        }
        const input = dom[type] && dom[type].requesterName;
        if (!input) {
          return;
        }
        setRequesterName(input.value || '', { sourceType: type });
      }

      function setRequesterName(value, options) {
        const sourceType = options && options.sourceType;
        const skipPersist = Boolean(options && options.skipPersist);
        const text = typeof value === 'string' ? value : '';
        state.requesterName = text;
        REQUEST_KEYS.forEach(type => {
          state.forms[type] = Object.assign({}, state.forms[type], { requesterName: text });
          const input = dom[type] && dom[type].requesterName;
          if (input) {
            if (!requiresRequesterName) {
              input.value = '';
            } else if (type !== sourceType || document.activeElement !== input) {
              input.value = text;
            }
          }
          if (!skipPersist) {
            persistForm(type);
          }
        });
      }

      function initializeRequesterName() {
        if (!requiresRequesterName) {
          setRequesterName('', { skipPersist: true });
          return;
        }
        const cached = REQUEST_KEYS
          .map(type => state.forms[type] && state.forms[type].requesterName ? String(state.forms[type].requesterName) : '')
          .find(name => typeof name === 'string' && name.trim());
        if (cached) {
          setRequesterName(cached, { skipPersist: true });
        } else {
          setRequesterName('', { skipPersist: true });
        }
      }

      function configureRequesterNameRequirement() {
        if (!requiresRequesterName) {
          state.requesterName = '';
        }
        REQUEST_KEYS.forEach(type => {
          const wrapper = dom[type] && dom[type].requesterNameRow;
          const input = dom[type] && dom[type].requesterName;
          if (!wrapper || !input) {
            return;
          }
          if (requiresRequesterName) {
            wrapper.hidden = false;
            input.required = true;
            input.disabled = false;
          } else {
            wrapper.hidden = true;
            input.required = false;
            input.disabled = true;
            input.value = '';
          }
        });
      }

      function persistForm(type, options) {
        const immediate = options && options.immediate;
        if (immediate) {
          flushPersist(type);
          return;
        }
        clearTimeout(persistTimers[type]);
        persistTimers[type] = setTimeout(() => {
          flushPersist(type);
        }, PERSIST_DELAY);
      }

      function flushPersist(type) {
        try {
          localStorage.setItem(LOCAL_KEYS[type], JSON.stringify(state.forms[type]));
        } catch (err) {
          // ignore storage errors
        }
      }

      function flushAllPersists() {
        REQUEST_KEYS.forEach(type => {
          if (persistTimers[type]) {
            clearTimeout(persistTimers[type]);
            persistTimers[type] = null;
          }
          flushPersist(type);
        });
      }

      function hydrateFormFromCache(type) {
        try {
          const raw = localStorage.getItem(LOCAL_KEYS[type]);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === 'object') {
              state.forms[type] = Object.assign({}, FORM_TEMPLATES[type], parsed);
              if (type === 'it') {
                const form = state.forms[type];
                if ((!form.urgency || form.urgency === undefined) && form.impact) {
                  form.urgency = form.impact;
                }
                delete form.impact;
                form.urgency = normalizeUrgency(form.urgency) || 'normal';
              } else if (type === 'maintenance') {
                state.forms[type].urgency = normalizeUrgency(state.forms[type].urgency) || 'normal';
              }
            }
          }
        } catch (err) {
          // ignore cache issues
        }
      }

      window.addEventListener('beforeunload', () => {
        stopDashboardAutoRefresh();
        flushAllPersists();
      });
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          flushAllPersists();
          stopDashboardAutoRefresh();
        } else if (document.visibilityState === 'visible') {
          if (hasServer) {
            requestDashboardRefresh(0);
            startDashboardAutoRefresh();
          }
        }
      });

      function toggleRequestsSkeleton(type, active) {
        if (!active || state.requests[type].length) {
          return;
        }
        const list = dom[type].list;
        list.textContent = '';
        list.appendChild(buildSkeletonBlock());
        const moreButton = dom[type].more;
        if (moreButton) {
          moreButton.disabled = true;
        }
      }

      function toggleCatalogSkeleton(active) {
        if (!active || state.catalog.items.length) {
          return;
        }
        dom.supplies.catalogList.textContent = '';
        dom.supplies.catalogList.appendChild(buildSkeletonBlock());
        dom.supplies.catalogMore.disabled = true;
      }

      function buildSkeletonBlock() {
        const wrapper = document.createElement('div');
        wrapper.className = 'request-item';
        const title = document.createElement('div');
        title.className = 'skeleton';
        title.style.height = '20px';
        wrapper.appendChild(title);
        const line = document.createElement('div');
        line.className = 'skeleton sm';
        wrapper.appendChild(line);
        return wrapper;
      }

      function formatStatus(status) {
        switch (status) {
          case 'completed':
            return 'Completed';
          case 'in_progress':
            return 'In progress';
          case 'ordered':
            return 'Ordered';
          case 'approved':
            return 'Approved';
          case 'denied':
            return 'Denied';
          case 'declined':
            return 'Declined';
          default:
            return 'Pending review';
        }
      }

      function buildStatusActorLine(type, statusKey, approver) {
        const actorName = approver ? approver : 'Not recorded';
        switch (statusKey) {
          case 'denied':
          case 'declined':
            return `Denied by: ${actorName}`;
          case 'approved':
            return `Approved by: ${actorName}`;
          case 'ordered':
            return `Ordered by: ${actorName}`;
          case 'completed':
            return `Completed by: ${actorName}`;
          case 'in_progress':
            return `In progress by: ${actorName}`;
          case 'pending':
            return type === 'supplies' ? 'Approval decision pending' : 'Update pending';
          default:
            return `Status: ${formatStatus(statusKey)}${approver ? ` by ${actorName}` : ''}`;
        }
      }

      function disableForm(type, disabled) {
        if (type === 'supplies') {
          dom.supplies.submit.disabled = disabled;
          dom.supplies.location.disabled = disabled;
          dom.supplies.qty.disabled = disabled;
          dom.supplies.notes.disabled = disabled;
          dom.supplies.catalogSearch.disabled = disabled;
          dom.supplies.reset.disabled = disabled;
          if (dom.supplies.requesterName && requiresRequesterName) {
            dom.supplies.requesterName.disabled = disabled;
          }
        } else if (type === 'it') {
          dom.it.submit.disabled = disabled;
          dom.it.location.disabled = disabled;
          dom.it.issue.disabled = disabled;
          dom.it.device.disabled = disabled;
          dom.it.urgency.disabled = disabled;
          dom.it.details.disabled = disabled;
          dom.it.reset.disabled = disabled;
          if (dom.it.requesterName && requiresRequesterName) {
            dom.it.requesterName.disabled = disabled;
          }
        } else if (type === 'maintenance') {
          dom.maintenance.submit.disabled = disabled;
          dom.maintenance.location.disabled = disabled;
          dom.maintenance.issue.disabled = disabled;
          dom.maintenance.urgency.disabled = disabled;
          dom.maintenance.accessNotes.disabled = disabled;
          dom.maintenance.reset.disabled = disabled;
          if (dom.maintenance.requesterName && requiresRequesterName) {
            dom.maintenance.requesterName.disabled = disabled;
          }
        }
      }

      function showToast(message) {
        dom.toast.textContent = message;
        dom.toast.style.display = 'block';
        clearTimeout(showToast.timer);
        showToast.timer = setTimeout(() => {
          dom.toast.style.display = 'none';
        }, 2800);
      }

      function resolveErrorMessage(err) {
        if (!err) {
          return 'Something went wrong. Please try again.';
        }
        if (typeof err === 'string') {
          return err;
        }
        if (typeof err.message === 'string' && err.message.trim()) {
          return err.message.trim();
        }
        if (typeof err.statusText === 'string' && err.statusText.trim()) {
          return err.statusText.trim();
        }
        if (typeof err.details === 'string' && err.details.trim()) {
          return err.details.trim();
        }
        if (Array.isArray(err.details) && err.details.length) {
          const firstDetail = err.details.find(detail => typeof detail === 'string' && detail.trim());
          if (firstDetail) {
            return firstDetail.trim();
          }
        }
        if (Array.isArray(err.errors) && err.errors.length) {
          const firstError = err.errors.find(detail => typeof detail === 'string' && detail.trim());
          if (firstError) {
            return firstError.trim();
          }
        }
        if (typeof err.error === 'string' && err.error.trim()) {
          return err.error.trim();
        }
        return 'Something went wrong. Please try again.';
      }

      function handleError(err, context, payload) {
        const message = resolveErrorMessage(err);
        console.error('[RequestManager]', context, message, err);
        showToast(message);
        if (!server) {
          return;
        }
        try {
          server
            .withFailureHandler(() => { })
            .logClientError({
              cid: makeCid(),
              context,
              message,
              stack: err && err.stack ? String(err.stack) : '',
              payload
            });
        } catch (loggingError) {
          // ignore logging issues
        }
      }

      function makeCid() {
        return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 8)}`;
      }

      function makeClientRequestId(type) {
        return `${initialSessionEmail || 'user'}-${type}-${makeCid()}`;
      }
    })();
  </script>
</body>
</html>

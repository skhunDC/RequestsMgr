<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Supplies Tracker</title>
<style>
*,*::before,*::after{box-sizing:border-box;}
body{font-family:Arial,sans-serif;margin:0;background:#f5f7fb;color:#1f2933;min-height:100vh;}
.app-header{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:1rem 1rem .75rem;background:#fff;box-shadow:0 1px 0 rgba(15,23,42,.08);gap:.5rem;text-align:center;}
.app-logo{height:80px;object-fit:contain;}
@media (min-width:640px){.app-logo{height:96px;}}
nav{display:flex;gap:.5rem;padding:.75rem 1rem;background:#fff;position:sticky;top:0;z-index:10;border-bottom:1px solid #e2e8f0;}
nav button{flex:1;appearance:none;border:none;background:transparent;padding:.65rem .75rem;border-radius:999px;font-weight:600;color:#475569;transition:background .2s,color .2s;}
nav button.active{background:#1a73e8;color:#fff;box-shadow:0 0 0 1px rgba(26,115,232,.2);}
nav button:hover{background:rgba(26,115,232,.12);color:#1a73e8;}
nav button.dev-trigger{flex:0 0 auto;margin-left:auto;}
nav button.dev-trigger:hover{background:#0b1120;color:#fff;}
.dev-trigger{background:#0f172a;color:#fff;box-shadow:0 12px 24px -18px rgba(15,23,42,.7);}
.dev-trigger:hover{background:#0b1120;color:#fff;}
.dev-trigger[disabled]{opacity:.6;cursor:not-allowed;box-shadow:none;}
.dev-trigger[disabled]:hover{background:#0f172a;color:#fff;}
.dev-launcher{position:fixed;top:1rem;right:1rem;z-index:80;}
.dev-launcher button{flex:0 0 auto;padding:.55rem 1.25rem;}
@media (max-width:640px){
.dev-launcher{top:.75rem;right:.75rem;}
}
main{padding:1.5rem 1rem;}
.view{display:flex;flex-direction:column;gap:1rem;margin:0 auto;width:100%;max-width:960px;}
.view-header h1{margin:0;font-size:1.5rem;}
.view-header p{margin:.25rem 0 0;color:#64748b;}
.panel{background:#fff;border-radius:12px;padding:1rem;box-shadow:0 8px 16px -12px rgba(15,23,42,.45);}
.panel-head{display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;}
.panel-title{margin:0;font-size:1rem;}
.stack>*+*{margin-top:.75rem;}
.form-grid{display:grid;gap:.75rem;}
@media (min-width:640px){
.form-grid{grid-template-columns:repeat(auto-fit,minmax(180px,1fr));}
.form-grid textarea{grid-column:1 / -1;}
}
.field{display:flex;flex-direction:column;gap:.25rem;font-size:.875rem;color:#475569;}
.field span{font-weight:600;}
input,textarea{font:inherit;padding:.5rem .6rem;border-radius:8px;border:1px solid #cbd5f5;background:#f8fafc;}
input:focus,textarea:focus{outline:2px solid #1a73e8;outline-offset:2px;}
textarea{min-height:5rem;resize:vertical;}
.checkbox-field{flex-direction:row;align-items:center;gap:.5rem;}
.checkbox-field span{font-weight:500;}
.actions{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:flex-end;}
.actions.start{justify-content:flex-start;}
.actions.start button{flex:0 0 auto;}
button{font:inherit;border-radius:999px;border:none;padding:.55rem 1.1rem;cursor:pointer;transition:background .2s,box-shadow .2s,color .2s;background:#e2e8f0;color:#1f2933;}
button:hover{background:#cbd5f5;}
button.primary{background:#1a73e8;color:#fff;}
button.primary:hover{background:#1666cf;}
button.ghost{background:transparent;color:#1a73e8;box-shadow:0 0 0 1px rgba(26,115,232,.3);}
button.ghost:hover{background:rgba(26,115,232,.12);}
button.link{background:transparent;color:#1a73e8;padding:0;border-radius:0;font-weight:600;}
button.link:hover{text-decoration:underline;}
.table-wrapper{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:.95rem;}
thead{background:#f1f5f9;color:#475569;}
th,td{padding:.65rem;border-bottom:1px solid #e2e8f0;text-align:left;}
tr:nth-child(even){background:#f8fafc;}
.chip-row{display:flex;flex-wrap:wrap;margin:.25rem -.25rem 0;}
.chip{display:inline-flex;align-items:center;padding:.25rem .65rem;margin:.25rem;border-radius:999px;background:#e2e8f0;color:#475569;font-size:.75rem;font-weight:600;cursor:pointer;transition:background .2s,color .2s;}
.chip.active{background:#1a73e8;color:#fff;}
#itemPreview{display:flex;align-items:center;gap:.75rem;margin-top:.5rem;padding:.5rem;border-radius:8px;background:#eef2ff;color:#312e81;}
#itemPreview.hidden{display:none;}
#itemPreview img{width:72px;height:72px;object-fit:cover;border-radius:8px;box-shadow:0 0 0 1px rgba(49,46,129,.15);}
#itemPreview button{align-self:flex-start;}
#itemPreview button.link{padding:0;}
#bulkBar{display:flex;gap:.75rem;flex-wrap:wrap;align-items:flex-end;}
#bulkBar .field{flex:1 1 240px;}
#bulkBar .actions{flex:1 1 200px;justify-content:flex-end;}
#bulkBar textarea{min-height:3rem;}
.empty{padding:.75rem 0;color:#64748b;text-align:center;}
#toast{position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);background:#1f2933;color:#fff;padding:.65rem 1rem;border-radius:999px;display:none;box-shadow:0 10px 25px -12px rgba(15,23,42,.6);}
.hidden{display:none;}
.footnote{margin:.5rem 0 0;font-size:.8rem;color:#64748b;}
.field-note{margin:.25rem 0 0;font-size:.8rem;color:#64748b;}
.thumb{width:60px;height:60px;object-fit:cover;border-radius:8px;box-shadow:0 0 0 1px rgba(148,163,184,.4);transition:transform .2s,box-shadow .2s;cursor:pointer;background:#fff;}
.thumb:hover{transform:translateY(-2px);box-shadow:0 8px 12px -10px rgba(30,64,175,.45);}
.catalog-item{display:flex;align-items:center;gap:.75rem;}
.catalog-item-text{display:flex;flex-direction:column;gap:.25rem;}
.thumb-button{padding:0;border:none;background:transparent;cursor:pointer;}
.modal-overlay{position:fixed;inset:0;background:rgba(15,23,42,.55);display:flex;align-items:center;justify-content:center;padding:1.25rem;z-index:50;}
.modal-overlay.hidden{display:none;}
.modal-card{background:#fff;border-radius:16px;width:100%;max-width:420px;padding:1.25rem;box-shadow:0 24px 48px -24px rgba(15,23,42,.55);display:flex;flex-direction:column;gap:1rem;}
.modal-head{display:flex;align-items:center;justify-content:space-between;gap:.75rem;}
.modal-head h2{margin:0;font-size:1.25rem;}
.modal-close{appearance:none;border:none;background:transparent;color:#475569;font-size:1.5rem;line-height:1;cursor:pointer;padding:.25rem;}
.modal-close:hover{color:#1f2933;}
.modal-body{display:flex;flex-direction:column;gap:1rem;}
.notice{padding:.65rem .75rem;border-radius:10px;font-size:.9rem;}
.notice.ok{background:#ecfdf5;color:#047857;}
.notice.error{background:#fef2f2;color:#b91c1c;}
.dev-form .actions{justify-content:flex-end;}
.dev-users{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:.35rem;font-size:.9rem;}
.dev-users li{display:flex;justify-content:space-between;gap:.5rem;padding:.35rem .5rem;border-radius:8px;background:#f8fafc;color:#1f2933;}
.dev-users li span{font-weight:600;word-break:break-all;}
.modal-actions{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:flex-end;}
.modal-actions.spread{justify-content:space-between;}
.modal-actions button{flex:0 0 auto;}

.dropzone{border:1px dashed #94a3b8;border-radius:10px;padding:1rem;display:flex;flex-direction:column;align-items:center;gap:.5rem;text-align:center;background:#f8fafc;color:#475569;transition:border-color .2s,background .2s;min-height:120px;justify-content:center;}
.dropzone.drag{border-color:#1a73e8;background:rgba(26,115,232,.08);}
.dropzone.has-image{border-style:solid;background:#fff;}
.dropzone strong{color:#1a73e8;}
.dropzone .field-note{margin:0;font-size:.75rem;color:#64748b;}
.field-note + .link{margin-top:.35rem;display:inline-block;}
.preview{max-width:220px;border-radius:12px;margin-top:.5rem;box-shadow:0 10px 18px -12px rgba(15,23,42,.45);display:block;}
.preview.hidden{display:none;}
</style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
<header class="app-header">
<img src="https://www.dublincleaners.com/wp-content/uploads/2025/06/LogosHQ.png" alt="Dublin Cleaners logo" class="app-logo">
</header>
<nav id="nav" role="navigation"></nav>
<div id="devLauncher" class="dev-launcher">
  <button id="devLauncherButton" type="button" class="dev-trigger">Developer</button>
</div>
<main id="app"></main>
<div id="devModalOverlay" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="devModalTitle">
  <section id="devModalCard" class="modal-card"></section>
</div>
<div id="toast" aria-live="polite"></div>
<script>
const SESSION = <?!= JSON.stringify(session) ?>;
</script>
<script type="module">
const DEV_ALLOWED_EMAILS = Array.isArray(SESSION.devEmails) ? SESSION.devEmails.map(e => String(e).toLowerCase()) : [];
const DEV_ALLOWED_SET = new Set(DEV_ALLOWED_EMAILS);
const DEV_USERINFO_ENDPOINT = 'https://www.googleapis.com/oauth2/v3/userinfo';
const DEV_AUTH_SCOPES = 'openid https://www.googleapis.com/auth/userinfo.email';
const OAUTH_LOAD_TIMEOUT_MS = 10000;
const HAS_OAUTH_CLIENT = typeof SESSION.oauthClientId === 'string' && SESSION.oauthClientId.trim() !== '';
const INITIAL_DEV_ALLOWED = !HAS_OAUTH_CLIENT && DEV_ALLOWED_SET.has((SESSION.email || '').toLowerCase());
const oauthState = { client: null, token: '' };

const state = {
  session: SESSION,
  route: 'request',
  filters: { mineOnly: false, status: [], search: '' },
  rows: [],
  selection: new Set(),
  catalog: [],
  dev: {
    allowed: INITIAL_DEV_ALLOWED,
    oauthConfigured: HAS_OAUTH_CLIENT,
    oauthLoading: false,
    oauthError: '',
    oauthEmail: INITIAL_DEV_ALLOWED ? (SESSION.email || '').toLowerCase() : '',
    oauthToken: '',
    show: false,
    statusLoaded: false,
    hasPassword: false,
    authed: false,
    token: '',
    loading: false,
    error: '',
    message: '',
    view: 'login',
    users: [],
    loadingUsers: false,
    loadedUsers: false
  }
};

const CAN_MANAGE_PROOF = ['approver','developer','super_admin'].includes(SESSION.role);
const CAN_MANAGE_THUMBS = ['developer','super_admin'].includes(SESSION.role);
const CAN_UPLOAD_IMAGES = ['developer','super_admin'].includes(SESSION.role);
let proofPanelCtx = null;
let thumbPanelCtx = null;
let devModalReady = false;

function waitForGoogleIdentity(timeout = OAUTH_LOAD_TIMEOUT_MS){
  if(window.google && window.google.accounts && window.google.accounts.oauth2){
    return Promise.resolve();
  }
  return new Promise((resolve, reject) => {
    const start = Date.now();
    (function check(){
      if(window.google && window.google.accounts && window.google.accounts.oauth2){
        resolve();
        return;
      }
      if(Date.now() - start >= timeout){
        reject(new Error('Google authentication library failed to load.'));
        return;
      }
      setTimeout(check, 100);
    })();
  });
}

function ensureOauthClient(){
  if(!state.dev || !state.dev.oauthConfigured) return null;
  if(oauthState.client) return oauthState.client;
  if(!(window.google && window.google.accounts && window.google.accounts.oauth2)) return null;
  oauthState.client = window.google.accounts.oauth2.initTokenClient({
    client_id: state.session.oauthClientId,
    scope: DEV_AUTH_SCOPES,
    callback: () => {}
  });
  return oauthState.client;
}

function requestOauthToken(forcePrompt = false){
  return new Promise((resolve, reject) => {
    const client = ensureOauthClient();
    if(!client){
      reject(new Error('Google authentication is not available. Refresh and try again.'));
      return;
    }
    client.callback = response => {
      if(response && response.error){
        reject(new Error(response.error_description || 'Authorization was denied.'));
        return;
      }
      if(response && response.access_token){
        oauthState.token = response.access_token;
        resolve(response.access_token);
        return;
      }
      reject(new Error('Authorization failed.'));
    };
    try {
      client.requestAccessToken({ prompt: forcePrompt ? 'consent' : '' });
    } catch (err) {
      reject(err);
    }
  });
}

async function fetchOauthEmail(token){
  if(!token) throw new Error('Missing authorization token.');
  const res = await fetch(DEV_USERINFO_ENDPOINT, {
    headers: { Authorization: `Bearer ${token}` }
  });
  if(res.status === 401 || res.status === 403){
    const err = new Error('Authorization expired. Please try again.');
    err.retry = true;
    throw err;
  }
  if(!res.ok){
    throw new Error('Unable to verify Google account.');
  }
  const data = await res.json();
  const email = String(data && data.email ? data.email : '').toLowerCase();
  if(!email){
    throw new Error('Google account email unavailable.');
  }
  if(data && data.email_verified === false){
    throw new Error('Google account email is not verified.');
  }
  return email;
}

async function authorizeDevAccess(){
  if(!state.dev || state.dev.allowed) return true;
  if(!state.dev.oauthConfigured){
    toast('Developer authentication is not configured.');
    return false;
  }
  if(state.dev.oauthLoading) return false;
  state.dev.oauthLoading = true;
  state.dev.oauthError = '';
  updateDevLauncher();
  try {
    await waitForGoogleIdentity();
  } catch (err) {
    state.dev.oauthError = err.message || 'Google authentication unavailable.';
    state.dev.oauthLoading = false;
    updateDevLauncher();
    toast(state.dev.oauthError);
    return false;
  }
  try {
    let token = oauthState.token || '';
    if(!token){
      token = await requestOauthToken(false);
    }
    let email;
    try {
      email = await fetchOauthEmail(token);
    } catch (err) {
      if(err && err.retry){
        token = await requestOauthToken(true);
        email = await fetchOauthEmail(token);
      } else {
        throw err;
      }
    }
    if(!DEV_ALLOWED_SET.has(email)){
      const message = 'This Google account is not authorized for developer tools.';
      state.dev.oauthError = message;
      toast(message);
      oauthState.token = '';
      state.dev.oauthLoading = false;
      updateDevLauncher();
      return false;
    }
    state.dev.allowed = true;
    state.dev.oauthEmail = email;
    state.dev.oauthToken = token;
    if(!state.session.email){
      state.session.email = email;
    }
    state.dev.oauthError = '';
    toast('Developer access verified.');
    state.dev.oauthLoading = false;
    updateDevLauncher();
    return true;
  } catch (err) {
    state.dev.oauthError = err.message || 'Authorization failed.';
    toast(state.dev.oauthError);
    state.dev.oauthLoading = false;
    updateDevLauncher();
    return false;
  }
}

function init(){
  setupDevModal();
  setupDevLauncher();
  if(state.dev.allowed){
    fetchDevStatus();
  }
  route('request');
}

function renderNav(){
  const nav = document.getElementById('nav');
  nav.innerHTML = '';
  const links = [['request','Request'],['all','All Requests'],['catalog','Catalog']];
  links.forEach(([r,label])=>{
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = label;
    btn.onclick = () => route(r);
    btn.classList.toggle('active', state.route === r);
    btn.setAttribute('aria-current', state.route === r ? 'page' : 'false');
    nav.appendChild(btn);
  });
  updateDevLauncher();
}

function setupDevLauncher(){
  const trigger = document.getElementById('devLauncherButton');
  if(trigger){
    trigger.onclick = async () => {
      if(trigger.disabled) return;
      if(state.dev && state.dev.allowed){
        openDevModal();
        return;
      }
      const authorized = await authorizeDevAccess();
      if(authorized){
        if(!state.dev.statusLoaded){
          fetchDevStatus();
        }
        openDevModal();
      }
    };
  }
  updateDevLauncher();
}

function updateDevLauncher(){
  const launcher = document.getElementById('devLauncher');
  const trigger = document.getElementById('devLauncherButton');
  if(!launcher || !trigger) return;
  launcher.classList.remove('hidden');
  const devState = state.dev || {};
  const allowed = !!devState.allowed;
  const loading = !!devState.oauthLoading;
  const configured = devState.oauthConfigured !== false;
  const disabled = loading || (!configured && !allowed);
  trigger.disabled = disabled;
  trigger.textContent = loading ? 'Verifying…' : 'Developer';
  trigger.setAttribute('aria-disabled', disabled ? 'true' : 'false');
  let title = 'Developer tools restricted to authorized users';
  if(loading){
    title = 'Verifying developer access…';
  }else if(allowed){
    const email = devState.oauthEmail || (state.session.email ? state.session.email.toLowerCase() : '');
    title = email ? `Open developer tools (verified as ${email})` : 'Open developer tools';
  }else if(!configured){
    title = 'Developer authentication is not configured.';
  }else if(devState.oauthError){
    title = devState.oauthError;
  }else{
    title = 'Authorize with Google to access developer tools';
  }
  trigger.title = title;
}

function route(r){
  state.route = r;
  proofPanelCtx = null;
  thumbPanelCtx = null;
  renderNav();
  const app = document.getElementById('app');
  app.innerHTML = '';
  if(r === 'request') renderRequest(app);
  else if(r === 'all') renderAll(app);
  else if(r === 'catalog') renderCatalog(app);
}

function viewHeader(title, subtitle=''){
  return `<header class="view-header"><h1>${title}</h1>${subtitle ? `<p>${subtitle}</p>` : ''}</header>`;
}

function renderRequest(app){
  app.innerHTML = `
    <section class="view">
      ${viewHeader('New request','Choose an item from the catalog and share any required details.')}
      <section class="panel stack">
        <h2 class="panel-title">Request details</h2>
        <div class="form-grid">
          <label class="field">
            <span>Item</span>
            <input id="item" placeholder="Start typing to search the catalog" list="catList">
            <p class="field-note">Choose an item to reveal its catalog thumbnail.</p>
            <div id="itemPreview" class="hidden">
              <img id="itemPreviewImg" alt="Selected item thumbnail">
              <div class="catalog-item-text">
                <strong id="itemPreviewLabel"></strong>
                <button id="itemPreviewOpen" type="button" class="link">Open full image</button>
              </div>
            </div>
          </label>
          <label class="field">
            <span>Quantity</span>
            <input id="qty" type="number" min="1" value="1">
          </label>
          <label class="field">
            <span>Estimated cost</span>
            <input id="est" type="number" min="0" placeholder="0.00">
          </label>
          <label class="field checkbox-field">
            <input type="checkbox" id="ov">
            <span>Override catalog guidance</span>
          </label>
          <label class="field">
            <span>Justification</span>
            <textarea id="just" placeholder="Provide context when overriding the catalog."></textarea>
          </label>
        </div>
        <div class="actions">
          <button id="sub" class="primary" type="button">Submit request</button>
        </div>
      </section>
      <section class="panel stack">
        <div class="panel-head">
          <h2 class="panel-title">Catalog snapshot</h2>
          <button class="link" type="button" data-route="catalog">View full catalog</button>
        </div>
        <div id="catalogPreview"><p class="footnote">Loading catalog...</p></div>
      </section>
      <datalist id="catList"></datalist>
    </section>
  `;
  app.querySelector('#sub').onclick = submitOrder;
  const itemInput = app.querySelector('#item');
  const preview = app.querySelector('#itemPreview');
  const previewImg = app.querySelector('#itemPreviewImg');
  if(previewImg){
    previewImg.loading = 'lazy';
    previewImg.decoding = 'async';
  }
  const previewLabel = app.querySelector('#itemPreviewLabel');
  const previewOpen = app.querySelector('#itemPreviewOpen');
  let previewSrc = '';
  function hideItemPreview(){
    if(preview){
      preview.classList.add('hidden');
    }
    previewSrc = '';
  }
  function showItemPreview(row){
    if(!preview || !row || !row.image_url){
      hideItemPreview();
      return;
    }
    previewImg.src = row.image_url;
    previewImg.alt = `${row.description} thumbnail`;
    previewLabel.textContent = row.description;
    preview.classList.remove('hidden');
    previewSrc = row.image_url;
  }
  function updateItemPreview(){
    if(!itemInput) return;
    const value = itemInput.value ? itemInput.value.toLowerCase().trim() : '';
    if(!value){
      hideItemPreview();
      return;
    }
    const match = state.catalog.find(row => (row.description || '').toLowerCase() === value);
    if(match){
      showItemPreview(match);
    }else{
      hideItemPreview();
    }
  }
  if(itemInput){
    itemInput.addEventListener('input', updateItemPreview);
    itemInput.addEventListener('change', updateItemPreview);
  }
  if(previewOpen){
    previewOpen.onclick = () => { if(previewSrc) window.open(previewSrc, '_blank'); };
  }
  app.querySelectorAll('[data-route="catalog"]').forEach(btn=>btn.onclick=()=>route('catalog'));
  const schedulePreviewLoad = () => {
    loadCatalog().then(()=>{
      const dl = document.getElementById('catList');
      if(dl){
        dl.innerHTML = '';
        state.catalog.forEach(c=>{
          const o = document.createElement('option');
          o.value = c.description;
          dl.appendChild(o);
        });
      }
      renderCatalogList('catalogPreview',{limit:6});
      updateItemPreview();
    });
  };
  if('requestIdleCallback' in window){
    requestIdleCallback(()=>schedulePreviewLoad());
  }else{
    setTimeout(schedulePreviewLoad,120);
  }
}

function renderAll(app){
  app.innerHTML = `
    <section class="view">
      ${viewHeader('Requests','Track submissions and make decisions in one place.')}
      <section class="panel stack" id="filters">
        <h2 class="panel-title">Filters</h2>
        <div class="form-grid">
          <label class="field checkbox-field">
            <input type="checkbox" id="mine">
            <span>Show only my requests</span>
          </label>
          <label class="field">
            <span>Search</span>
            <input id="search" placeholder="Search by item, requester or status">
          </label>
          <div class="field">
            <span>Status</span>
            <div id="statusChips" class="chip-row"></div>
          </div>
        </div>
        <div class="actions">
          <button id="clear" class="ghost" type="button">Clear filters</button>
        </div>
      </section>
      <section class="panel stack">
        <div id="bulkBar" class="hidden">
          <label class="field">
            <span>Decision comment</span>
            <textarea id="comment" placeholder="Optional note"></textarea>
          </label>
          <div class="actions">
            <button id="ap" class="primary" type="button">Approve</button>
            <button id="dn" class="ghost" type="button">Deny</button>
            <button id="oh" class="ghost" type="button">On-Hold</button>
          </div>
        </div>
        <div class="table-wrapper">
          <table id="list">
            <thead>
              <tr>
                <th scope="col"><input type="checkbox" id="selAll"></th>
                <th scope="col">Requested</th>
                <th scope="col">Item</th>
                <th scope="col">Qty</th>
                <th scope="col">Est Cost</th>
                <th scope="col">Requester</th>
                <th scope="col">Status</th>
                <th scope="col">Approver</th>
                <th scope="col">ETA</th>
                <th scope="col">Order proof</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="empty" class="empty hidden">No requests match your filters. <button id="reset" class="ghost" type="button">Reset filters</button></div>
      </section>
      ${CAN_MANAGE_PROOF ? `
      <section class="panel stack hidden" id="proofPanel">
        <h2 class="panel-title">Order fulfillment evidence</h2>
        <p class="field-note" id="proofOrderLabel">Select “Manage proof” on a request to attach details.</p>
        <div class="field">
          <span>ETA details</span>
          <textarea id="etaInput" placeholder="Example: Expected delivery 3/15 via UPS"></textarea>
        </div>
        <div class="field">
          <span>Order screenshot</span>
          <div id="proofDrop" class="dropzone" tabindex="0">
            <strong>Paste</strong> (Ctrl+V) an image or drop a file
            <span class="field-note">Or provide a hosted image URL below.</span>
          </div>
          <div class="actions start">
            <button id="proofBrowse" class="ghost" type="button">Select image</button>
            <button id="proofUpload" class="primary hidden" type="button">Upload to Drive</button>
          </div>
          <input id="proofFile" type="file" accept="image/*" class="hidden">
          <input id="proofUrl" placeholder="https://example.com/order-proof.png">
          <img id="proofPreview" class="preview hidden" alt="Order proof preview">
          <div class="actions">
            <button id="clearProof" class="ghost" type="button">Clear image</button>
          </div>
          <input type="hidden" id="proofData">
        </div>
        <div class="actions">
          <button id="cancelProof" class="ghost" type="button">Close</button>
          <button id="saveProof" class="primary" type="button" disabled>Save proof</button>
        </div>
      </section>
      ` : ''}
      <section class="panel stack">
        <div class="panel-head">
          <h2 class="panel-title">Catalog snapshot</h2>
          <button class="link" type="button" data-route="catalog">View full catalog</button>
        </div>
        <div id="catalogInline"><p class="footnote">Loading catalog...</p></div>
      </section>
    </section>
  `;
  const st = ['PENDING','APPROVED','DENIED','ON-HOLD'];
  const chipsDiv = app.querySelector('#statusChips');
  st.forEach(s=>{
    const sp = document.createElement('span');
    sp.textContent = s;
    sp.className = 'chip';
    sp.onclick = ()=>{sp.classList.toggle('active');updateFilters();};
    chipsDiv.appendChild(sp);
  });
  app.querySelector('#mine').onchange = updateFilters;
  app.querySelector('#search').oninput = debounce(updateFilters,300);
  app.querySelector('#clear').onclick = ()=>{
    state.filters = {mineOnly:false,status:[],search:''};
    route('all');
    loadOrders();
  };
  app.querySelector('#reset').onclick = ()=>{
    state.filters = {mineOnly:false,status:[],search:''};
    route('all');
    loadOrders();
  };
  app.querySelector('#selAll').onchange = e=>{
    const c = e.target.checked;
    state.selection = new Set();
    const tbody = document.querySelector('#list tbody');
    if(tbody){
      tbody.querySelectorAll('input[type=checkbox]').forEach(cb=>{
        cb.checked = c;
        if(c) state.selection.add(cb.value);
      });
    }
    toggleBulk();
  };
  app.querySelectorAll('[data-route="catalog"]').forEach(btn=>btn.onclick=()=>route('catalog'));
  if(CAN_MANAGE_PROOF){
    const bulkBar = app.querySelector('#bulkBar');
    if(bulkBar) bulkBar.classList.remove('hidden');
    const ap = app.querySelector('#ap');
    const dn = app.querySelector('#dn');
    const oh = app.querySelector('#oh');
    if(ap) ap.onclick = ()=>bulk('APPROVED');
    if(dn) dn.onclick = ()=>bulk('DENIED');
    if(oh) oh.onclick = ()=>bulk('ON-HOLD');
    setupProofPanel(app);
  }
  loadOrders();
  loadCatalog().then(()=>renderCatalogList('catalogInline',{limit:6}));
}

function renderCatalog(app){
  app.innerHTML = `
    <section class="view">
      ${viewHeader('Catalog','Browse approved items for quick ordering.')}
      <section class="panel stack">
        <div class="panel-head">
          <h2 class="panel-title">All items</h2>
          <button class="link" type="button" data-route="request">Submit a request</button>
        </div>
        <div id="catalogFull"><p class="footnote">Loading catalog...</p></div>
      </section>
      ${CAN_MANAGE_THUMBS ? `
      <section class="panel stack" id="thumbPanel">
        <h2 class="panel-title">Manage thumbnails</h2>
        <p class="field-note">Paste or drop an image to update catalog visuals.</p>
        <label class="field">
          <span>Catalog item</span>
          <select id="thumbSku">
            <option value="">Select an item</option>
          </select>
        </label>
        <div class="field">
          <span>Thumbnail</span>
          <div id="thumbDrop" class="dropzone" tabindex="0">
            <strong>Paste</strong> (Ctrl+V) an image or drop a file
            <span class="field-note">Or provide a hosted image URL below.</span>
          </div>
          <div class="actions start">
            <button id="thumbBrowse" class="ghost" type="button">Select image</button>
            <button id="thumbUpload" class="primary hidden" type="button">Upload to Drive</button>
          </div>
          <input id="thumbFile" type="file" accept="image/*" class="hidden">
          <input id="thumbUrl" placeholder="https://example.com/catalog-item.png">
          <img id="thumbPreview" class="preview hidden" alt="Catalog thumbnail preview">
          <div class="actions">
            <button id="thumbClear" class="ghost" type="button">Clear image</button>
            <button id="thumbSave" class="primary" type="button" disabled>Save thumbnail</button>
          </div>
          <input type="hidden" id="thumbData">
        </div>
      </section>
      ` : ''}
    </section>
  `;
  app.querySelector('[data-route="request"]').onclick = ()=>route('request');
  if(CAN_MANAGE_THUMBS){
    setupThumbPanel(app);
  }
  const scheduleCatalogLoad = () => {
    loadCatalog().then(()=>{
      renderCatalogList('catalogFull');
      if(CAN_MANAGE_THUMBS){
        populateThumbOptions();
      }
    });
  };
  if('requestIdleCallback' in window){
    requestIdleCallback(()=>scheduleCatalogLoad());
  }else{
    setTimeout(scheduleCatalogLoad,120);
  }
}

function renderCatalogList(targetId,{limit}={}){
  const target = document.getElementById(targetId);
  if(!target) return;
  target.innerHTML = '';
  const rows = typeof limit === 'number' ? state.catalog.slice(0,limit) : state.catalog;
  if(!rows.length){
    const p = document.createElement('p');
    p.className = 'empty';
    p.textContent = 'No catalog items available yet.';
    target.appendChild(p);
    return;
  }
  const wrapper = document.createElement('div');
  wrapper.className = 'table-wrapper';
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  thead.innerHTML = '<tr><th scope="col">Item</th><th scope="col">Category</th></tr>';
  const tbody = document.createElement('tbody');
  const fragment = document.createDocumentFragment();
  rows.forEach(row=>{
    const tr = document.createElement('tr');
    const item = document.createElement('td');
    const itemWrapper = document.createElement('div');
    itemWrapper.className = 'catalog-item';
    if(row.image_url){
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'thumb-button';
      const img = document.createElement('img');
      img.className = 'thumb';
      img.loading = 'lazy';
      img.decoding = 'async';
      img.alt = `${row.description} thumbnail`;
      img.src = row.image_url;
      btn.appendChild(img);
      btn.onclick = () => window.open(row.image_url, '_blank');
      itemWrapper.appendChild(btn);
    }
    const text = document.createElement('div');
    text.className = 'catalog-item-text';
    const name = document.createElement('span');
    name.textContent = row.description;
    text.appendChild(name);
    if(!row.image_url){
      const note = document.createElement('span');
      note.className = 'field-note';
      note.textContent = 'Thumbnail not added yet';
      text.appendChild(note);
    }
    itemWrapper.appendChild(text);
    item.appendChild(itemWrapper);
    const cat = document.createElement('td');
    cat.textContent = row.category;
    tr.append(item,cat);
    fragment.appendChild(tr);
  });
  tbody.appendChild(fragment);
  table.append(thead,tbody);
  wrapper.appendChild(table);
  target.appendChild(wrapper);
  if(limit && state.catalog.length > limit){
    const foot = document.createElement('p');
    foot.className = 'footnote';
    foot.textContent = `Showing ${rows.length} of ${state.catalog.length} items.`;
    target.appendChild(foot);
  }
}

function loadCatalog(force=false){
  if(!force && state.catalog.length) return Promise.resolve();
  return new Promise(res=>{
    google.script.run.withSuccessHandler(rows=>{state.catalog = rows;res();}).router({action:'listCatalog'});
  });
}

function submitOrder(){
  const payload = {
    item: document.getElementById('item').value,
    qty: Number(document.getElementById('qty').value||1),
    est_cost: Number(document.getElementById('est').value||0),
    override: document.getElementById('ov').checked,
    justification: document.getElementById('just').value
  };
  google.script.run.withSuccessHandler(o=>{
    toast('Submitted');
    state.filters = {mineOnly:true,status:['PENDING'],search:''};
    route('all');
    loadOrders();
  }).withFailureHandler(err=>toast(err.message))
    .router({action:'createOrder',payload,csrf:state.session.csrf});
}

function updateFilters(){
  state.filters.mineOnly = document.getElementById('mine').checked;
  state.filters.search = document.getElementById('search').value;
  state.filters.status = [...document.querySelectorAll('#statusChips .chip.active')].map(c=>c.textContent);
  loadOrders();
}

function loadOrders(){
  google.script.run.withSuccessHandler(rows=>{
    state.rows=rows;
    renderRows();
    if(proofPanelCtx && proofPanelCtx.orderId){
      const current = state.rows.find(r => r.id === proofPanelCtx.orderId);
      if(current){
        proofPanelCtx.orderLabel.textContent = `${current.item} • ${current.ts}`;
      }
    }
  })
    .router({action:'listOrders',filter:state.filters});
}

function renderRows(){
  const tbody = document.querySelector('#list tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  state.selection = new Set();
  const fragment = document.createDocumentFragment();
  state.rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input type="checkbox" value="${r.id}"></td>`;
    const requested = document.createElement('td');
    requested.textContent = r.ts;
    const itemCell = document.createElement('td');
    itemCell.textContent = r.item;
    const qty = document.createElement('td');
    qty.textContent = r.qty;
    const cost = document.createElement('td');
    cost.textContent = r.est_cost;
    const requester = document.createElement('td');
    requester.textContent = r.requester;
    const status = document.createElement('td');
    status.textContent = r.statusChip;
    const approver = document.createElement('td');
    approver.textContent = r.approver || '';
    const eta = document.createElement('td');
    eta.textContent = r.eta_details || '—';
    const proof = document.createElement('td');
    if(r.proof_image){
      const proofBtn = document.createElement('button');
      proofBtn.type = 'button';
      proofBtn.className = 'thumb-button';
      const img = document.createElement('img');
      img.className = 'thumb';
      img.loading = 'lazy';
      img.decoding = 'async';
      img.alt = `Order proof for ${r.item}`;
      img.src = r.proof_image;
      proofBtn.appendChild(img);
      proofBtn.onclick = () => window.open(r.proof_image, '_blank');
      proof.appendChild(proofBtn);
    }else if(CAN_MANAGE_PROOF){
      const note = document.createElement('span');
      note.className = 'field-note';
      note.textContent = 'No proof yet';
      proof.appendChild(note);
    }else{
      proof.textContent = '—';
    }
    if(CAN_MANAGE_PROOF){
      const manage = document.createElement('button');
      manage.type = 'button';
      manage.className = 'link';
      manage.textContent = r.proof_image ? 'Update proof' : 'Manage proof';
      manage.onclick = () => openProofPanel(r);
      proof.appendChild(manage);
    }
    tr.append(requested,itemCell,qty,cost,requester,status,approver,eta,proof);
    fragment.appendChild(tr);
  });
  tbody.appendChild(fragment);
  tbody.onchange = e => {
    const target = e.target;
    if(target && target.matches('input[type=checkbox]')){
      if(target.checked) state.selection.add(target.value);
      else state.selection.delete(target.value);
      toggleBulk();
    }
  };
  const empty = document.getElementById('empty');
  if(empty){
    if(!state.rows.length) empty.classList.remove('hidden');
    else empty.classList.add('hidden');
  }
}

function setupProofPanel(app){
  const panel = app.querySelector('#proofPanel');
  if(!panel) return;
  const dropZone = panel.querySelector('#proofDrop');
  const preview = panel.querySelector('#proofPreview');
  const hiddenInput = panel.querySelector('#proofData');
  const urlInput = panel.querySelector('#proofUrl');
  const clearButton = panel.querySelector('#clearProof');
  const browseButton = panel.querySelector('#proofBrowse');
  const uploadButton = panel.querySelector('#proofUpload');
  const fileInput = panel.querySelector('#proofFile');
  const saveButton = panel.querySelector('#saveProof');
  const etaInput = panel.querySelector('#etaInput');
  const orderLabel = panel.querySelector('#proofOrderLabel');
  if(uploadButton){
    uploadButton.classList.toggle('hidden', !CAN_UPLOAD_IMAGES);
  }
  proofPanelCtx = {
    panel,
    etaInput,
    orderLabel,
    saveButton,
    imageField: createImageField({
      dropZone,
      preview,
      hiddenInput,
      urlInput,
      clearButton,
      browseButton,
      uploadButton,
      fileInput,
      canUpload: CAN_UPLOAD_IMAGES,
      getName: () => {
        if(proofPanelCtx && proofPanelCtx.orderId){
          const label = proofPanelCtx.orderName || 'order-proof';
          return `order-${proofPanelCtx.orderId}-${label}`;
        }
        return 'order-proof';
      },
      onChange: updateProofSaveState
    }),
    orderId: null,
    orderName: ''
  };
  const cancel = panel.querySelector('#cancelProof');
  if(cancel) cancel.onclick = closeProofPanel;
  if(saveButton) saveButton.onclick = saveProof;
  updateProofSaveState();
}

function openProofPanel(order){
  if(!proofPanelCtx) return;
  proofPanelCtx.orderId = order.id;
  proofPanelCtx.orderName = order.item || '';
  proofPanelCtx.panel.classList.remove('hidden');
  proofPanelCtx.orderLabel.textContent = `${order.item} • ${order.ts}`;
  proofPanelCtx.etaInput.value = order.eta_details || '';
  proofPanelCtx.imageField.setExisting(order.proof_image || '');
  updateProofSaveState();
  proofPanelCtx.panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
  const dropZone = proofPanelCtx.panel.querySelector('#proofDrop');
  if(dropZone) dropZone.focus();
}

function closeProofPanel(){
  if(!proofPanelCtx) return;
  proofPanelCtx.orderId = null;
  proofPanelCtx.orderName = '';
  proofPanelCtx.etaInput.value = '';
  proofPanelCtx.imageField.clear();
  proofPanelCtx.orderLabel.textContent = 'Select “Manage proof” on a request to attach details.';
  proofPanelCtx.panel.classList.add('hidden');
  updateProofSaveState();
}

function updateProofSaveState(){
  if(!proofPanelCtx) return;
  const imageValue = proofPanelCtx.imageField.getValue();
  const eta = proofPanelCtx.etaInput.value.trim();
  const disabled = !proofPanelCtx.orderId || (!imageValue && !eta);
  proofPanelCtx.saveButton.disabled = disabled;
}

function saveProof(){
  if(!proofPanelCtx || !proofPanelCtx.orderId) return;
  const payload = {
    action: 'updateOrderProof',
    id: proofPanelCtx.orderId,
    eta: proofPanelCtx.etaInput.value.trim(),
    image: proofPanelCtx.imageField.getValue(),
    csrf: state.session.csrf
  };
  proofPanelCtx.saveButton.disabled = true;
  google.script.run.withSuccessHandler(()=>{
    toast('Proof saved');
    closeProofPanel();
    loadOrders();
  }).withFailureHandler(err=>{
    toast(err.message);
    updateProofSaveState();
  }).router(payload);
}

function setupThumbPanel(app){
  const panel = app.querySelector('#thumbPanel');
  if(!panel) return;
  const dropZone = panel.querySelector('#thumbDrop');
  const preview = panel.querySelector('#thumbPreview');
  const hiddenInput = panel.querySelector('#thumbData');
  const urlInput = panel.querySelector('#thumbUrl');
  const clearButton = panel.querySelector('#thumbClear');
  const browseButton = panel.querySelector('#thumbBrowse');
  const uploadButton = panel.querySelector('#thumbUpload');
  const fileInput = panel.querySelector('#thumbFile');
  const saveButton = panel.querySelector('#thumbSave');
  const select = panel.querySelector('#thumbSku');
  if(uploadButton){
    uploadButton.classList.toggle('hidden', !CAN_UPLOAD_IMAGES);
  }
  thumbPanelCtx = {
    panel,
    select,
    saveButton,
    originalImage: '',
    imageField: createImageField({
      dropZone,
      preview,
      hiddenInput,
      urlInput,
      clearButton,
      browseButton,
      uploadButton,
      fileInput,
      canUpload: CAN_UPLOAD_IMAGES,
      getName: () => {
        if(thumbPanelCtx && thumbPanelCtx.select){
          const sku = thumbPanelCtx.select.value || '';
          if(sku) return `catalog-${sku}`;
        }
        return 'catalog-image';
      },
      onChange: updateThumbSaveState
    })
  };
  if(select){
    select.onchange = () => {
      const row = state.catalog.find(r => r.sku === select.value);
      thumbPanelCtx.originalImage = row ? row.image_url || '' : '';
      thumbPanelCtx.imageField.setExisting(thumbPanelCtx.originalImage);
      updateThumbSaveState();
    };
  }
  if(saveButton) saveButton.onclick = saveThumbnail;
  updateThumbSaveState();
}

function populateThumbOptions(){
  if(!thumbPanelCtx || !thumbPanelCtx.select) return;
  const select = thumbPanelCtx.select;
  const current = select.value;
  select.innerHTML = '<option value="">Select an item</option>';
  state.catalog.forEach(row=>{
    const opt = document.createElement('option');
    opt.value = row.sku;
    opt.textContent = `${row.description} (${row.category})`;
    select.appendChild(opt);
  });
  if(current){
    select.value = current;
    const row = state.catalog.find(r => r.sku === current);
    thumbPanelCtx.originalImage = row ? row.image_url || '' : '';
    thumbPanelCtx.imageField.setExisting(thumbPanelCtx.originalImage);
  }
  updateThumbSaveState();
}

function updateThumbSaveState(){
  if(!thumbPanelCtx) return;
  const sku = thumbPanelCtx.select ? thumbPanelCtx.select.value : '';
  const value = thumbPanelCtx.imageField.getValue();
  const canSave = !!sku && (value || thumbPanelCtx.originalImage);
  if(thumbPanelCtx.saveButton) thumbPanelCtx.saveButton.disabled = !canSave;
}

function saveThumbnail(){
  if(!thumbPanelCtx || !thumbPanelCtx.select) return;
  const sku = thumbPanelCtx.select.value;
  if(!sku){
    updateThumbSaveState();
    return;
  }
  const image = thumbPanelCtx.imageField.getValue();
  if(thumbPanelCtx.saveButton) thumbPanelCtx.saveButton.disabled = true;
  google.script.run.withSuccessHandler(()=>{
    toast('Thumbnail updated');
    loadCatalog(true).then(()=>{
      refreshCatalogViews();
    });
  }).withFailureHandler(err=>{
    toast(err.message);
    updateThumbSaveState();
  }).router({ action: 'updateCatalogImage', sku, image, csrf: state.session.csrf });
}

function refreshCatalogViews(){
  if(document.getElementById('catalogPreview')) renderCatalogList('catalogPreview',{limit:6});
  if(document.getElementById('catalogInline')) renderCatalogList('catalogInline',{limit:6});
  if(document.getElementById('catalogFull')) renderCatalogList('catalogFull');
  const itemInput = document.getElementById('item');
  if(itemInput){
    itemInput.dispatchEvent(new Event('change'));
  }
  if(thumbPanelCtx && thumbPanelCtx.select){
    const row = state.catalog.find(r => r.sku === thumbPanelCtx.select.value);
    thumbPanelCtx.originalImage = row ? row.image_url || '' : '';
    thumbPanelCtx.imageField.setExisting(thumbPanelCtx.originalImage);
    updateThumbSaveState();
  }
}

function createImageField({ dropZone, preview, hiddenInput, urlInput, clearButton, browseButton, uploadButton, fileInput, canUpload, getName, onChange }){
  if(!dropZone) return { setExisting: ()=>{}, clear: ()=>{}, getValue: ()=>'' };
  const trigger = () => { if(typeof onChange === 'function') onChange(); };
  let lastSource = { dataUrl: '', fileName: '', contentType: '' };
  const uploadLabel = uploadButton ? uploadButton.textContent : '';
  const updateUploadButton = () => {
    if(uploadButton){
      uploadButton.disabled = !(canUpload && lastSource.dataUrl);
    }
  };
  const showPreview = (src, triggerChange = true) => {
    if(preview){
      preview.src = src;
      preview.classList.remove('hidden');
    }
    dropZone.classList.add('has-image');
    if(triggerChange) trigger();
  };
  const hidePreview = (triggerChange = true) => {
    if(preview){
      preview.src = '';
      preview.classList.add('hidden');
    }
    dropZone.classList.remove('has-image');
    if(triggerChange) trigger();
  };
  const clearValues = (triggerChange = true) => {
    if(hiddenInput) hiddenInput.value = '';
    if(urlInput) urlInput.value = '';
    lastSource = { dataUrl: '', fileName: '', contentType: '' };
    hidePreview(triggerChange);
    updateUploadButton();
  };
  const setFromDataUrl = (dataUrl, fileName, contentType, triggerChange = true) => {
    lastSource = {
      dataUrl: dataUrl || '',
      fileName: fileName || '',
      contentType: contentType || ''
    };
    if(hiddenInput) hiddenInput.value = dataUrl || '';
    if(urlInput) urlInput.value = '';
    showPreview(dataUrl || '', triggerChange);
    updateUploadButton();
  };
  const handleFile = file => {
    if(!file) return;
    const reader = new FileReader();
    const type = file.type || '';
    reader.onload = e => {
      setFromDataUrl(e.target.result, file.name || '', type);
    };
    reader.readAsDataURL(file);
  };
  dropZone.addEventListener('paste', e => {
    const items = e.clipboardData && e.clipboardData.items ? e.clipboardData.items : [];
    for(let i=0;i<items.length;i+=1){
      const item = items[i];
      if(item.type && item.type.indexOf('image') === 0){
        const file = item.getAsFile();
        if(file){
          e.preventDefault();
          handleFile(file);
          break;
        }
      }
    }
  });
  dropZone.addEventListener('dragover', e => {
    e.preventDefault();
    dropZone.classList.add('drag');
  });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('drag');
    if(e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length){
      handleFile(e.dataTransfer.files[0]);
    }
  });
  dropZone.addEventListener('click', () => {
    if(fileInput){
      fileInput.click();
    }else{
      dropZone.focus();
    }
  });
  dropZone.addEventListener('keydown', e => {
    if((e.key === 'Enter' || e.key === ' ') && fileInput){
      e.preventDefault();
      fileInput.click();
    }
  });
  if(fileInput){
    fileInput.addEventListener('change', e => {
      const file = e.target.files && e.target.files[0];
      handleFile(file);
      e.target.value = '';
    });
  }
  if(browseButton){
    browseButton.onclick = () => {
      if(fileInput){
        fileInput.click();
      }
    };
  }
  if(urlInput){
    urlInput.addEventListener('input', () => {
      if(hiddenInput) hiddenInput.value = '';
      lastSource = { dataUrl: '', fileName: '', contentType: '' };
      const url = urlInput.value.trim();
      if(url){
        showPreview(url);
      }else{
        hidePreview();
      }
      updateUploadButton();
    });
  }
  if(clearButton){
    clearButton.onclick = () => clearValues();
  }
  if(uploadButton){
    if(!canUpload){
      uploadButton.disabled = true;
    }else{
      uploadButton.disabled = true;
      uploadButton.onclick = () => {
        if(!lastSource.dataUrl){
          toast('Select an image before uploading.');
          return;
        }
        const payload = {
          action: 'uploadImage',
          data: lastSource.dataUrl,
          name: typeof getName === 'function' ? getName() : 'image',
          filename: lastSource.fileName || '',
          contentType: lastSource.contentType || '',
          csrf: state.session.csrf
        };
        const originalText = uploadLabel || uploadButton.textContent;
        uploadButton.disabled = true;
        uploadButton.textContent = 'Uploading…';
        google.script.run.withSuccessHandler(res => {
          const url = res && res.url ? res.url : '';
          if(url){
            if(hiddenInput) hiddenInput.value = url;
            if(urlInput) urlInput.value = url;
            showPreview(url);
            lastSource = { dataUrl: '', fileName: '', contentType: '' };
            toast('Image uploaded to Drive');
          }
          uploadButton.textContent = originalText;
          updateUploadButton();
        }).withFailureHandler(err => {
          toast(err.message);
          uploadButton.textContent = originalText;
          updateUploadButton();
        }).router(payload);
      };
    }
  }
  updateUploadButton();
  return {
    setExisting(value){
      clearValues(false);
      if(value){
        if(value.startsWith('data:')){
          setFromDataUrl(value, '', '', false);
        }else{
          if(urlInput) urlInput.value = value;
          showPreview(value,false);
        }
      }else{
        hidePreview(false);
      }
      updateUploadButton();
      trigger();
    },
    clear(){
      clearValues();
    },
    getValue(){
      const hidden = hiddenInput ? hiddenInput.value : '';
      const url = urlInput ? urlInput.value.trim() : '';
      return hidden || url;
    }
  };
}

function toggleBulk(){
  const bar = document.getElementById('bulkBar');
  if(!bar) return;
  bar.classList.toggle('hidden', state.selection.size === 0);
}

function bulk(decision){
  const ids = [...state.selection];
  const comment = document.getElementById('comment').value;
  google.script.run.withSuccessHandler(()=>{
    toast('Done');
    loadOrders();
  })
    .withFailureHandler(e=>toast(e.message))
    .router({action:'bulkDecision',ids,decision,comment,csrf:state.session.csrf});
}

function escapeHtml(str){
  const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
  return String(str == null ? '' : str).replace(/[&<>"']/g, ch => map[ch]);
}

function setupDevModal(){
  if(devModalReady) return;
  const overlay = document.getElementById('devModalOverlay');
  if(!overlay) return;
  devModalReady = true;
  overlay.addEventListener('click', e => {
    if(e.target === overlay){
      closeDevModal();
    }
  });
  document.addEventListener('keydown', e => {
    if(e.key === 'Escape' && state.dev && state.dev.show){
      closeDevModal();
    }
  });
}

function openDevModal(){
  if(!state.dev || !state.dev.allowed) return;
  state.dev.show = true;
  state.dev.error = '';
  state.dev.message = '';
  renderDevModal();
  if(!state.dev.statusLoaded){
    fetchDevStatus();
  }else if(state.dev.authed && !state.dev.loadedUsers && !state.dev.loadingUsers){
    loadDevUsers();
  }
}

function closeDevModal(){
  if(!state.dev) return;
  state.dev.show = false;
  state.dev.loading = false;
  state.dev.error = '';
  state.dev.message = '';
  const overlay = document.getElementById('devModalOverlay');
  const card = document.getElementById('devModalCard');
  if(overlay){
    overlay.classList.add('hidden');
    overlay.setAttribute('aria-hidden','true');
  }
  if(card){
    card.innerHTML = '';
  }
}

function renderDevModal(){
  const overlay = document.getElementById('devModalOverlay');
  const card = document.getElementById('devModalCard');
  if(!overlay || !card) return;
  if(!state.dev || !state.dev.allowed || !state.dev.show){
    overlay.classList.add('hidden');
    overlay.setAttribute('aria-hidden','true');
    card.innerHTML = '';
    return;
  }
  overlay.classList.remove('hidden');
  overlay.setAttribute('aria-hidden','false');
  let body = '';
  const disabledAttr = state.dev.loading ? 'disabled' : '';
  if(!state.dev.statusLoaded){
    body = '<p class="footnote">Loading developer tools…</p>';
  }else if(state.dev.authed && state.dev.view === 'main'){
    const sorted = Array.isArray(state.dev.users) ? [...state.dev.users].sort((a,b)=>String(a.email||'').localeCompare(String(b.email||''))) : [];
    let list = '';
    if(state.dev.loadingUsers){
      list = '<p class="footnote">Loading access list…</p>';
    }else if(sorted.length){
      list = '<ul class="dev-users">' + sorted.map(row => `<li><span>${escapeHtml(row.email || '')}</span><small>${escapeHtml(row.role || '')}</small></li>`).join('') + '</ul>';
    }else{
      list = '<p class="field-note">No users added yet.</p>';
    }
    body = `
      <p class="field-note">Signed in as <strong>${escapeHtml(state.session.email || '')}</strong>.</p>
      <form id="devAddUserForm" class="dev-form">
        <label class="field">
          <span>User email</span>
          <input type="email" id="devUserEmail" autocomplete="email" required ${disabledAttr} data-autofocus>
        </label>
        <label class="field">
          <span>Role</span>
          <select id="devUserRole" ${disabledAttr}>
            <option value="requester">Requester</option>
            <option value="approver">Approver</option>
            <option value="developer">Developer</option>
            <option value="super_admin">Super Admin</option>
          </select>
        </label>
        <div class="actions">
          <button class="primary" type="submit" ${disabledAttr}>Save access</button>
        </div>
      </form>
      <section>
        <h3 class="panel-title">Project users</h3>
        ${list}
      </section>
      <div class="modal-actions spread">
        <button type="button" class="ghost" data-change-pass ${disabledAttr}>Change password</button>
        <button type="button" class="ghost" data-logout ${disabledAttr}>Sign out</button>
      </div>
    `;
  }else if(state.dev.view === 'set'){
    const needCurrent = state.dev.hasPassword && !state.dev.authed;
    const currentField = needCurrent ? `<label class="field"><span>Current password</span><input type="password" id="devCurrentPassword" autocomplete="current-password" ${disabledAttr} data-autofocus></label>` : '';
    const newAutofocus = needCurrent ? '' : 'data-autofocus';
    body = `
      <form id="devSetForm" class="dev-form">
        ${currentField}
        <label class="field">
          <span>New password</span>
          <input type="password" id="devNewPassword" autocomplete="new-password" minlength="12" required ${disabledAttr} ${newAutofocus}>
          <p class="field-note">Use at least 12 characters.</p>
        </label>
        <label class="field">
          <span>Confirm password</span>
          <input type="password" id="devConfirmPassword" autocomplete="new-password" required ${disabledAttr}>
        </label>
        <div class="actions">
          <button class="primary" type="submit" ${disabledAttr}>Save password</button>
          ${state.dev.hasPassword ? `<button type="button" class="ghost" data-cancel-reset ${disabledAttr}>Cancel</button>` : ''}
        </div>
      </form>
    `;
  }else{
    body = `
      <form id="devLoginForm" class="dev-form">
        <label class="field">
          <span>Developer password</span>
          <input type="password" id="devLoginPassword" autocomplete="current-password" required ${disabledAttr} data-autofocus>
        </label>
        <div class="actions">
          <button class="primary" type="submit" ${disabledAttr}>Sign in</button>
          <button type="button" class="ghost" data-reset ${disabledAttr}>Reset password</button>
        </div>
      </form>
    `;
  }
  const title = state.dev.authed ? 'Developer tools' : state.dev.hasPassword ? 'Developer sign-in' : 'Set developer access';
  const messageBlock = state.dev.message ? `<div class="notice ok">${escapeHtml(state.dev.message)}</div>` : '';
  const errorBlock = state.dev.error ? `<div class="notice error">${escapeHtml(state.dev.error)}</div>` : '';
  card.innerHTML = `
    <header class="modal-head">
      <h2 id="devModalTitle">${title}</h2>
      <button type="button" class="modal-close" data-close aria-label="Close developer tools">&times;</button>
    </header>
    <div class="modal-body">${body}</div>
    ${messageBlock}${errorBlock}
  `;
  const closer = card.querySelector('[data-close]');
  if(closer) closer.onclick = closeDevModal;
  const loginForm = card.querySelector('#devLoginForm');
  if(loginForm){
    loginForm.onsubmit = handleDevLogin;
    const resetBtn = card.querySelector('[data-reset]');
    if(resetBtn){
      resetBtn.onclick = () => {
        state.dev.view = 'set';
        state.dev.error = '';
        state.dev.message = '';
        renderDevModal();
      };
    }
  }
  const setForm = card.querySelector('#devSetForm');
  if(setForm){
    setForm.onsubmit = handleDevSetPassword;
    const cancel = card.querySelector('[data-cancel-reset]');
    if(cancel){
      cancel.onclick = () => {
        state.dev.view = state.dev.authed ? 'main' : (state.dev.hasPassword ? 'login' : 'set');
        state.dev.error = '';
        state.dev.message = '';
        renderDevModal();
      };
    }
  }
  const addForm = card.querySelector('#devAddUserForm');
  if(addForm){
    addForm.onsubmit = handleDevAddUser;
    const changeBtn = card.querySelector('[data-change-pass]');
    if(changeBtn){
      changeBtn.onclick = () => {
        state.dev.view = 'set';
        state.dev.error = '';
        state.dev.message = '';
        renderDevModal();
      };
    }
    const logoutBtn = card.querySelector('[data-logout]');
    if(logoutBtn){
      logoutBtn.onclick = handleDevLogout;
    }
  }
  const focusTarget = card.querySelector('[data-autofocus]');
  if(focusTarget && typeof focusTarget.focus === 'function'){
    focusTarget.focus();
  }
}

function fetchDevStatus(){
  if(!state.dev || !state.dev.allowed) return;
  state.dev.statusLoaded = false;
  if(state.dev.show) renderDevModal();
  google.script.run.withSuccessHandler(res => {
    state.dev.statusLoaded = true;
    state.dev.hasPassword = !!(res && res.hasPassword);
    const active = !!(res && res.sessionActive && res.token);
    state.dev.authed = active;
    state.dev.token = active ? res.token : '';
    state.dev.view = state.dev.authed ? 'main' : (state.dev.hasPassword ? 'login' : 'set');
    state.dev.error = '';
    if(state.dev.authed){
      state.dev.loadedUsers = false;
      state.dev.loadingUsers = false;
      loadDevUsers();
    }else{
      state.dev.users = [];
      state.dev.loadedUsers = false;
      state.dev.loadingUsers = false;
    }
    if(state.dev.show) renderDevModal();
  }).withFailureHandler(err => {
    state.dev.statusLoaded = true;
    state.dev.error = err.message;
    if(state.dev.show) renderDevModal();
  }).router({action:'devStatus',csrf:state.session.csrf});
}

function handleDevLogin(e){
  e.preventDefault();
  if(!state.dev || state.dev.loading) return;
  const input = e.target.querySelector('#devLoginPassword');
  const password = input ? input.value : '';
  if(!password){
    state.dev.error = 'Enter your developer password.';
    renderDevModal();
    return;
  }
  state.dev.loading = true;
  state.dev.error = '';
  renderDevModal();
  google.script.run.withSuccessHandler(res => {
    state.dev.loading = false;
    state.dev.authed = true;
    state.dev.hasPassword = true;
    state.dev.token = res && res.token ? res.token : '';
    state.dev.view = 'main';
    state.dev.message = 'Signed in';
    state.dev.loadedUsers = false;
    if(input) input.value = '';
    loadDevUsers();
    renderDevModal();
  }).withFailureHandler(err => {
    state.dev.loading = false;
    state.dev.error = err.message;
    renderDevModal();
  }).router({action:'devLogin',password,csrf:state.session.csrf});
}

function handleDevSetPassword(e){
  e.preventDefault();
  if(!state.dev || state.dev.loading) return;
  const form = e.target;
  const current = form.querySelector('#devCurrentPassword') ? form.querySelector('#devCurrentPassword').value : '';
  const next = form.querySelector('#devNewPassword') ? form.querySelector('#devNewPassword').value : '';
  const confirm = form.querySelector('#devConfirmPassword') ? form.querySelector('#devConfirmPassword').value : '';
  if(!next || next.length < 12){
    state.dev.error = 'Password must be at least 12 characters.';
    renderDevModal();
    return;
  }
  if(next !== confirm){
    state.dev.error = 'Passwords do not match.';
    renderDevModal();
    return;
  }
  state.dev.loading = true;
  state.dev.error = '';
  renderDevModal();
  google.script.run.withSuccessHandler(res => {
    state.dev.loading = false;
    state.dev.authed = true;
    state.dev.hasPassword = true;
    state.dev.token = res && res.token ? res.token : '';
    state.dev.view = 'main';
    state.dev.message = state.dev.show ? 'Password saved' : '';
    state.dev.loadedUsers = false;
    loadDevUsers();
    renderDevModal();
  }).withFailureHandler(err => {
    state.dev.loading = false;
    state.dev.error = err.message;
    renderDevModal();
  }).router({action:'devSetPassword',token:state.dev.token,currentPassword:current,newPassword:next,csrf:state.session.csrf});
}

function handleDevAddUser(e){
  e.preventDefault();
  if(!state.dev || state.dev.loading) return;
  const form = e.target;
  const emailInput = form.querySelector('#devUserEmail');
  const roleSelect = form.querySelector('#devUserRole');
  const email = emailInput ? emailInput.value.trim().toLowerCase() : '';
  const role = roleSelect ? roleSelect.value : '';
  if(!email || email.indexOf('@') === -1){
    state.dev.error = 'Enter a valid email address.';
    renderDevModal();
    return;
  }
  state.dev.loading = true;
  state.dev.error = '';
  renderDevModal();
  google.script.run.withSuccessHandler(() => {
    state.dev.loading = false;
    state.dev.message = 'Access saved';
    state.dev.error = '';
    state.dev.loadedUsers = false;
    if(emailInput) emailInput.value = '';
    if(roleSelect) roleSelect.value = 'requester';
    loadDevUsers();
    renderDevModal();
  }).withFailureHandler(err => {
    state.dev.loading = false;
    state.dev.error = err.message;
    renderDevModal();
  }).router({action:'devAddUser',token:state.dev.token,payload:{email,role},csrf:state.session.csrf});
}

function handleDevLogout(){
  if(!state.dev || state.dev.loading) return;
  state.dev.loading = true;
  state.dev.error = '';
  renderDevModal();
  google.script.run.withSuccessHandler(() => {
    state.dev.loading = false;
    state.dev.authed = false;
    state.dev.token = '';
    state.dev.users = [];
    state.dev.loadedUsers = false;
    state.dev.loadingUsers = false;
    state.dev.view = state.dev.hasPassword ? 'login' : 'set';
    state.dev.message = 'Signed out';
    renderDevModal();
  }).withFailureHandler(err => {
    state.dev.loading = false;
    state.dev.error = err.message;
    renderDevModal();
  }).router({action:'devLogout',token:state.dev.token,csrf:state.session.csrf});
}

function loadDevUsers(){
  if(!state.dev || !state.dev.authed || !state.dev.token || state.dev.loadingUsers) return;
  state.dev.loadingUsers = true;
  google.script.run.withSuccessHandler(rows => {
    state.dev.loadingUsers = false;
    state.dev.loadedUsers = true;
    state.dev.users = Array.isArray(rows) ? rows : [];
    if(state.dev.show) renderDevModal();
  }).withFailureHandler(err => {
    state.dev.loadingUsers = false;
    state.dev.loadedUsers = true;
    state.dev.error = err.message;
    if(state.dev.show) renderDevModal();
  }).router({action:'devListRoles',token:state.dev.token,csrf:state.session.csrf});
}

function toast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(()=>t.style.display='none',3000);
}
function debounce(fn,ms){let t;return function(){clearTimeout(t);t=setTimeout(fn,ms);};}

init();
</script>
</body>
</html>

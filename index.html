<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Supplies Tracker</title>
  <style>
    body{font-family:Arial,sans-serif;margin:0;padding:0;}
    header{display:flex;align-items:center;justify-content:center;gap:0.5rem;padding:0.5rem;background:#1a73e8;color:#fff;}
    header img{height:125px;}
    header h1{font-size:1.25rem;margin:0;}
    nav{display:flex;gap:0.5rem;padding:0.5rem;background:#f5f5f5;flex-wrap:wrap;}
    nav button{flex:1 1 auto;}
    .hidden{display:none;}
    .btn{background:#1a73e8;color:#fff;border:none;border-radius:4px;padding:0.5rem 1rem;}
    .btn:disabled{background:#9e9e9e;}
    .input{padding:0.5rem;border:1px solid #ccc;border-radius:4px;}
    table{width:100%;border-collapse:collapse;margin-top:0.5rem;}
    th,td{padding:0.5rem;border-bottom:1px solid #ddd;}
    .chip{display:inline-block;padding:0.25rem 0.5rem;margin:0.25rem;border-radius:16px;background:#eee;cursor:pointer;font-size:0.8rem;}
    .chip.active{background:#1a73e8;color:#fff;}
    ul{list-style:none;padding:0;}
    ul li{margin:0.25rem 0;}
  </style>
</head>
<body>
  <header>
    <img src="https://www.dublincleaners.com/wp-content/uploads/2025/06/LogosHQ.png" alt="Dublin Cleaners logo">
    <h1>Supplies Order & Tracking</h1>
  </header>
  <nav id="nav">
    <button class="btn" data-view="request">Request</button>
    <button class="btn" data-view="myRequests">My Requests</button>
    <button class="btn hidden" data-view="approvals" id="approveNav">Approvals</button>
    <button class="btn hidden" data-view="catalog" id="catalogNav">Catalog</button>
  </nav>
  <main id="main" class="p-2"></main>
  <script type="module">
  const store = {
    session: null,
    cart: { lines: [] },
    route: 'request'
  };

  google.script.run.withSuccessHandler(s => {
    store.session = s;
    if (!s.isLt) {
      document.body.innerHTML = '<p class="p-2">Access denied</p>';
      return;
    }
    if (s.isAdmin) {
      document.getElementById('approveNav').classList.remove('hidden');
      document.getElementById('catalogNav').classList.remove('hidden');
    }
    document.querySelectorAll('#nav button').forEach(b => b.addEventListener('click', () => navigate(b.dataset.view)));
    renderRoute();
  }).getSession();

  function navigate(route) {
    store.route = route;
    renderRoute();
  }

  function renderRoute() {
    const main = document.getElementById('main');
    main.innerHTML = '';
    if (store.route === 'request') return renderRequest(main);
    if (store.route === 'myRequests') return loadMyRequests();
    if (store.route === 'approvals') return loadApprovals();
    if (store.route === 'catalog') return renderCatalog(main);
  }

  function renderRequest(main) {
    main.innerHTML = `<h2>Request Supplies</h2>
      <input id="search" class="input" placeholder="Search">
      <div id="chips"></div>
      <table id="stock"><thead><tr><th>Description</th><th>Category</th><th>Qty</th><th></th></tr></thead><tbody></tbody></table>
      <h3>Custom Item</h3>
      <div><input id="cDesc" class="input" placeholder="Description"> <input id="cQty" type="number" min="1" value="1" class="input" style="width:4rem;"> <button id="cAdd" class="btn">Add</button></div>
      <h3>Cart</h3>
      <ul id="cartList"></ul>
      <button id="submitBtn" class="btn" disabled>Submit</button>`;

    const tbody = main.querySelector('#stock tbody');
    const chipsDiv = main.querySelector('#chips');
    ['All', 'Office', 'Cleaning', 'Operations'].forEach(c => {
      const chip = document.createElement('span');
      chip.textContent = c;
      chip.dataset.cat = c;
      chip.className = 'chip' + (c === 'All' ? ' active' : '');
      chip.onclick = () => {
        chipsDiv.querySelectorAll('.chip').forEach(ch => ch.classList.remove('active'));
        chip.classList.add('active');
        filter();
      };
      chipsDiv.appendChild(chip);
    });
    document.getElementById('search').addEventListener('input', filter);
    let items = [];
    google.script.run.withSuccessHandler(list => { items = list; filter(); }).getCatalog({});

    function filter() {
      const q = document.getElementById('search').value.toLowerCase();
      const cat = chipsDiv.querySelector('.chip.active').dataset.cat;
      tbody.innerHTML = '';
      items.filter(it => {
        const matchText = it.description.toLowerCase().includes(q);
        const matchCat = cat === 'All' || it.category === cat;
        return !it.archived && matchText && matchCat;
      }).forEach(it => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.description}</td><td>${it.category}</td><td><button class="qm">-</button><input type="number" value="1" min="1" class="qty" style="width:3rem;"><button class="qp">+</button></td><td><button class="add btn" data-desc="${it.description}">Add</button></td>`;
        const qty = tr.querySelector('.qty');
        tr.querySelector('.qm').onclick = () => qty.value = Math.max(1, qty.value - 1);
        tr.querySelector('.qp').onclick = () => qty.value = Number(qty.value) + 1;
        tr.querySelector('.add').onclick = () => addLine(it.description, Number(qty.value));
        tbody.appendChild(tr);
      });
    }

    document.getElementById('cAdd').onclick = () => {
      const desc = document.getElementById('cDesc').value.trim();
      const qty = Number(document.getElementById('cQty').value);
      addLine(desc, qty);
      document.getElementById('cDesc').value = '';
      document.getElementById('cQty').value = '1';
    };

    submitBtn = document.getElementById('submitBtn');
    submitBtn.addEventListener('click', submitHandler);
    renderCart();
    updateSubmitState();
  }

  function addLine(desc, qty = 1) {
    if (!desc || qty < 1) return;
    store.cart.lines.push({ description: desc.trim(), qty: Number(qty) });
    renderCart();
    updateSubmitState();
  }

  let submitBtn;
  function renderCart() {
    const ul = document.getElementById('cartList');
    if (!ul) return;
    ul.innerHTML = '';
    store.cart.lines.forEach((l, i) => {
      const li = document.createElement('li');
      li.textContent = `${l.qty} × ${l.description}`;
      const btn = document.createElement('button');
      btn.textContent = '✕';
      btn.onclick = () => {
        store.cart.lines.splice(i, 1);
        renderCart();
        updateSubmitState();
      };
      li.appendChild(btn);
      ul.appendChild(li);
    });
  }

  function updateSubmitState() {
    if (!submitBtn) return;
    submitBtn.disabled = store.cart.lines.length === 0;
  }

  function setSubmitting(is) {
    if (!submitBtn) return;
    submitBtn.disabled = is || store.cart.lines.length === 0;
    submitBtn.textContent = is ? 'Submitting…' : 'Submit';
  }

  function submitHandler() {
    if (store.cart.lines.length === 0) return toast('Add at least one item.');
    setSubmitting(true);

    const payload = {
      requester: store.session.email,
      items: store.cart.lines.map(l => ({ desc: l.description, qty: l.qty })),
      approver: ''
    };

    google.script.run
      .withSuccessHandler(res => {
        setSubmitting(false);
        if (res && res.ok) {
          store.cart.lines = [];
          renderCart();
          navigate('myRequests');
          loadMyRequests();
          toast(res.message || 'Submitted!');
        } else {
          toast('Submit failed.');
        }
      })
      .withFailureHandler(err => {
        setSubmitting(false);
        toast('Submit failed: ' + (err && err.message ? err.message : err));
      })
      .submitRequest(payload);
  }

  function loadMyRequests() {
    google.script.run
      .withSuccessHandler(rows => renderMyRequests(rows))
      .listMyOrders({ email: store.session.email });
  }

  function renderMyRequests(rows) {
    const main = document.getElementById('main');
    main.innerHTML = '<h2>My Requests</h2><table><thead><tr><th>Date</th><th>Description</th><th>Qty</th><th>Status</th><th>Approver</th></tr></thead><tbody></tbody></table>';
    const tbody = main.querySelector('tbody');
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.ts}</td><td>${r.description}</td><td>${r.qty}</td><td>${r.status}</td><td>${r.approver}</td>`;
      tbody.appendChild(tr);
    });
  }

  function loadApprovals() {
    google.script.run
      .withSuccessHandler(rows => renderApprovals(rows))
      .listPendingApprovals();
  }

  function renderApprovals(rows) {
    const main = document.getElementById('main');
    main.innerHTML = '<h2>Pending Approvals</h2><table><thead><tr><th>Date</th><th>Requester</th><th>Description</th><th>Qty</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>';
    const tbody = main.querySelector('tbody');
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.ts}</td><td>${r.requester}</td><td>${r.description}</td><td>${r.qty}</td><td>${r.status}</td><td><button class="btn ap">Approve</button> <button class="btn dn">Deny</button></td>`;
      tr.querySelector('.ap').onclick = () => decide(r.id, 'APPROVED');
      tr.querySelector('.dn').onclick = () => decide(r.id, 'DENIED');
      tbody.appendChild(tr);
    });

    function decide(id, decision) {
      google.script.run
        .withSuccessHandler(() => loadApprovals())
        .decideOrder({ id, decision });
    }
  }

  function renderCatalog(main) {
    main.innerHTML = '<h2>Catalog Manager</h2><div><input id="nDesc" class="input" placeholder="Description"> <select id="nCat" class="input"><option>Office</option><option>Cleaning</option><option>Operations</option></select> <button id="nAdd" class="btn">Add</button></div><table><thead><tr><th>Description</th><th>Category</th><th>Archived</th><th></th></tr></thead><tbody></tbody></table>';
    const tbody = main.querySelector('tbody');
    function load() {
      google.script.run.withSuccessHandler(items => {
        tbody.innerHTML = '';
        items.forEach(it => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${it.description}</td><td>${it.category}</td><td>${it.archived}</td><td><button class="btn tg">${it.archived ? 'Unarchive' : 'Archive'}</button></td>`;
          tr.querySelector('.tg').onclick = () => {
            google.script.run.withSuccessHandler(load).setCatalogArchived({ sku: it.sku, archived: !it.archived });
          };
          tbody.appendChild(tr);
        });
      }).getCatalog({ includeArchived: true });
    }
    load();
    main.querySelector('#nAdd').onclick = () => {
      const desc = main.querySelector('#nDesc').value.trim();
      const cat = main.querySelector('#nCat').value;
      if (desc) {
        google.script.run.withSuccessHandler(() => {
          main.querySelector('#nDesc').value = '';
          load();
        }).addCatalogItem({ description: desc, category: cat });
      }
    };
  }

  function toast(msg) {
    const div = document.createElement('div');
    div.textContent = msg;
    Object.assign(div.style, {
      position: 'fixed',
      bottom: '1rem',
      left: '50%',
      transform: 'translateX(-50%)',
      background: '#323232',
      color: '#fff',
      padding: '0.5rem 1rem',
      borderRadius: '4px',
      zIndex: '1000'
    });
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 3000);
  }
  </script>
</body>
</html>
